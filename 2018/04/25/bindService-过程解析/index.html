<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="android_deep_analysis," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="引言在做IPC架构时，bindService()是一个绕不过的话题。基于此，本文打算深入研究bindService()的完整过程，并且尝试回答以下几个问题:  bindService()过程系统到底做了什么？ 使用Activity Context和Application Context进行bindService()的效果是一样的吗？  回答以上问题的目的其实是为了回答以下这个终极问题: 进行IPC">
<meta name="keywords" content="android_deep_analysis">
<meta property="og:type" content="article">
<meta property="og:title" content="bindService()过程解析">
<meta property="og:url" content="http://yoursite.com/2018/04/25/bindService-过程解析/index.html">
<meta property="og:site_name" content="AllenWang的个人博客">
<meta property="og:description" content="引言在做IPC架构时，bindService()是一个绕不过的话题。基于此，本文打算深入研究bindService()的完整过程，并且尝试回答以下几个问题:  bindService()过程系统到底做了什么？ 使用Activity Context和Application Context进行bindService()的效果是一样的吗？  回答以上问题的目的其实是为了回答以下这个终极问题: 进行IPC">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://yoursite.com/images/ipc/bindService_flow.png">
<meta property="og:updated_time" content="2018-05-16T01:41:29.253Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="bindService()过程解析">
<meta name="twitter:description" content="引言在做IPC架构时，bindService()是一个绕不过的话题。基于此，本文打算深入研究bindService()的完整过程，并且尝试回答以下几个问题:  bindService()过程系统到底做了什么？ 使用Activity Context和Application Context进行bindService()的效果是一样的吗？  回答以上问题的目的其实是为了回答以下这个终极问题: 进行IPC">
<meta name="twitter:image" content="http://yoursite.com/images/ipc/bindService_flow.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/04/25/bindService-过程解析/"/>





  <title>bindService()过程解析 | AllenWang的个人博客</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">AllenWang的个人博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">小楼一夜听春雨</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-ad">
          <a href="/ad/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            menu.ad
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/25/bindService-过程解析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Allen Wang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="AllenWang的个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">bindService()过程解析</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-25T10:40:38+08:00">
                2018-04-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android-deep-analysis/" itemprop="url" rel="index">
                    <span itemprop="name">android_deep_analysis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>在做IPC架构时，bindService()是一个绕不过的话题。基于此，本文打算深入研究bindService()的完整过程，并且尝试回答以下几个问题:</p>
<ul>
<li>bindService()过程系统到底做了什么？</li>
<li>使用Activity Context和Application Context进行bindService()的效果是一样的吗？</li>
</ul>
<p>回答以上问题的目的其实是为了回答以下这个终极问题:</p>
<p><strong>进行IPC通信是否一定要采用bindService()，有没有可能采用其他的方案<a id="more"></a>?</strong></p>
<h2 id="bindService-过程"><a href="#bindService-过程" class="headerlink" title="bindService()过程"></a>bindService()过程</h2><h3 id="Client端bindService"><a href="#Client端bindService" class="headerlink" title="Client端bindService()"></a>Client端bindService()</h3><p>以Context的bindService()为例，在Context中只是个抽象方法，真正的实现是在ContextImpl中，如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">bindService</span><span class="params">(Intent service, ServiceConnection conn,</span></span></div><div class="line"><span class="function"><span class="params">            <span class="keyword">int</span> flags)</span> </span>&#123;</div><div class="line">        warnIfCallingFromSystemProcess();</div><div class="line">        <span class="keyword">return</span> bindServiceCommon(service, conn, flags, Process.myUserHandle());</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>而bindServiceCommon()方法如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">bindServiceCommon</span><span class="params">(Intent service, ServiceConnection conn, <span class="keyword">int</span> flags,</span></span></div><div class="line"><span class="function"><span class="params">            UserHandle user)</span> </span>&#123;</div><div class="line">        IServiceConnection sd;</div><div class="line">        <span class="keyword">if</span> (conn == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"connection is null"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (mPackageInfo != <span class="keyword">null</span>) &#123;</div><div class="line">            sd = mPackageInfo.getServiceDispatcher(conn, getOuterContext(),</div><div class="line">                    mMainThread.getHandler(), flags);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Not supported in system context"</span>);</div><div class="line">        &#125;</div><div class="line">        validateServiceIntent(service);</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            IBinder token = getActivityToken();</div><div class="line">            <span class="keyword">if</span> (token == <span class="keyword">null</span> &amp;&amp; (flags&amp;BIND_AUTO_CREATE) == <span class="number">0</span> &amp;&amp; mPackageInfo != <span class="keyword">null</span></div><div class="line">                    &amp;&amp; mPackageInfo.getApplicationInfo().targetSdkVersion</div><div class="line">                    &lt; android.os.Build.VERSION_CODES.ICE_CREAM_SANDWICH) &#123;</div><div class="line">                flags |= BIND_WAIVE_PRIORITY;</div><div class="line">            &#125;</div><div class="line">            service.prepareToLeaveProcess();</div><div class="line">            <span class="keyword">int</span> res = ActivityManagerNative.getDefault().bindService(</div><div class="line">                mMainThread.getApplicationThread(), getActivityToken(), service,</div><div class="line">                service.resolveTypeIfNeeded(getContentResolver()),</div><div class="line">                sd, flags, getOpPackageName(), user.getIdentifier());</div><div class="line">            <span class="keyword">if</span> (res &lt; <span class="number">0</span>) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(</div><div class="line">                        <span class="string">"Not allowed to bind to service "</span> + service);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> res != <span class="number">0</span>;</div><div class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Failure from system"</span>, e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>这个方法中有以下几点值得注意:</p>
<ul>
<li>mPackageInfo其实是LoadedAPK对象，那么它的getServiceDispatcher()方法做了什么事呢?</li>
<li>如果getActivityToken(), flags不为BIND_AUTO_CREATE,并且targetSdkVersion小于14的话，flags会添加BIND_WAIVE_PRIORITY标志，这个标志的含义是弃权，即不影响提供Service的进程的优先级</li>
<li>调用AMP.bindService()时，会传递getActivityToken()的值，而这个值对于bindService()的结果有什么样的影响呢？</li>
</ul>
<p>后面将逐步回答以上3个问题。</p>
<p>首先看一下LoadedApk的getServiceDispatcher()方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> IServiceConnection <span class="title">getServiceDispatcher</span><span class="params">(ServiceConnection c,</span></span></div><div class="line"><span class="function"><span class="params">        Context context, Handler handler, <span class="keyword">int</span> flags)</span> </span>&#123;</div><div class="line">    <span class="keyword">synchronized</span> (mServices) &#123;</div><div class="line">        LoadedApk.ServiceDispatcher sd = <span class="keyword">null</span>;</div><div class="line">        ArrayMap&lt;ServiceConnection, LoadedApk.ServiceDispatcher&gt; map = mServices.get(context);</div><div class="line">        <span class="keyword">if</span> (map != <span class="keyword">null</span>) &#123;</div><div class="line">            sd = map.get(c);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (sd == <span class="keyword">null</span>) &#123;</div><div class="line">            sd = <span class="keyword">new</span> ServiceDispatcher(c, context, handler, flags);</div><div class="line">            <span class="keyword">if</span> (map == <span class="keyword">null</span>) &#123;</div><div class="line">                map = <span class="keyword">new</span> ArrayMap&lt;ServiceConnection, LoadedApk.ServiceDispatcher&gt;();</div><div class="line">                mServices.put(context, map);</div><div class="line">            &#125;</div><div class="line">            map.put(c, sd);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            sd.validate(context, handler);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> sd.getIServiceConnection();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>显然，这个方法就是首先尝试从缓存中取出ServiceDispatcher对象，如果没有取到就新建一个ServiceDispatcher对象，而ServiceConnection就是此时保存到ServiceDispatcher对象中的。</p>
<p><strong>不过需要注意的是最后返回的并不是ServiceDispatcher对象，而是其中的IServiceConnection对象，其中IServiceConnection是一个IPC接口, 而IServiceConnection对象的初始化就是在ServiceDispatcher的构造方法中。</strong>这个IServiceConnection的binder会在IPC时传递到AMS中。</p>
<p>IServiceConnection的aidl定义如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> android.content.ComponentName;</div><div class="line"></div><div class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></div><div class="line">oneway <span class="class"><span class="keyword">interface</span> <span class="title">IServiceConnection</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">connected</span><span class="params">(in ComponentName name, IBinder service)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>显然，它是个单向方法，并且ComponentName参数也是单向传递到server端的。</p>
<p>再回到bindServiceCommon()方法中，接下来就是调用AMP的bindService()方法，然后通过IPC调用到AMS的bindService()方法，而AMS中的bindService()方法分析见下一小节。</p>
<h3 id="AMS中bindService"><a href="#AMS中bindService" class="headerlink" title="AMS中bindService()"></a>AMS中bindService()</h3><p>该方法如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">bindService</span><span class="params">(IApplicationThread caller, IBinder token, Intent service,</span></span></div><div class="line"><span class="function"><span class="params">            String resolvedType, IServiceConnection connection, <span class="keyword">int</span> flags, String callingPackage,</span></span></div><div class="line"><span class="function"><span class="params">            <span class="keyword">int</span> userId)</span> <span class="keyword">throws</span> TransactionTooLargeException </span>&#123;</div><div class="line">        enforceNotIsolatedCaller(<span class="string">"bindService"</span>);</div><div class="line"></div><div class="line">        <span class="comment">// Refuse possible leaked file descriptors</span></div><div class="line">        <span class="keyword">if</span> (service != <span class="keyword">null</span> &amp;&amp; service.hasFileDescriptors() == <span class="keyword">true</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"File descriptors passed in Intent"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (callingPackage == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"callingPackage cannot be null"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</div><div class="line">            <span class="keyword">return</span> mServices.bindServiceLocked(caller, token, service,</div><div class="line">                    resolvedType, connection, flags, callingPackage, userId);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>注意其中的mServices是ActiveServices对象，其bindServiceLocked()方法如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">bindServiceLocked</span><span class="params">(IApplicationThread caller, IBinder token, Intent service,</span></span></div><div class="line"><span class="function"><span class="params">            String resolvedType, IServiceConnection connection, <span class="keyword">int</span> flags,</span></span></div><div class="line"><span class="function"><span class="params">            String callingPackage, <span class="keyword">int</span> userId)</span> <span class="keyword">throws</span> TransactionTooLargeException </span>&#123;</div><div class="line">        ...</div><div class="line">        <span class="keyword">final</span> ProcessRecord callerApp = mAm.getRecordForAppLocked(caller);</div><div class="line">        <span class="keyword">if</span> (callerApp == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(</div><div class="line">                    <span class="string">"Unable to find app for caller "</span> + caller</div><div class="line">                    + <span class="string">" (pid="</span> + Binder.getCallingPid()</div><div class="line">                    + <span class="string">") when binding service "</span> + service);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        ActivityRecord activity = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">if</span> (token != <span class="keyword">null</span>) &#123;</div><div class="line">            activity = ActivityRecord.isInStackLocked(token);</div><div class="line">            <span class="keyword">if</span> (activity == <span class="keyword">null</span>) &#123;</div><div class="line">                Slog.w(TAG, <span class="string">"Binding with unknown activity: "</span> + token);</div><div class="line">                <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">int</span> clientLabel = <span class="number">0</span>;</div><div class="line">        PendingIntent clientIntent = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (callerApp.info.uid == Process.SYSTEM_UID) &#123;</div><div class="line">            <span class="comment">// Hacky kind of thing -- allow system stuff to tell us</span></div><div class="line">            <span class="comment">// what they are, so we can report this elsewhere for</span></div><div class="line">            <span class="comment">// others to know why certain services are running.</span></div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                clientIntent = service.getParcelableExtra(Intent.EXTRA_CLIENT_INTENT);</div><div class="line">            &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (clientIntent != <span class="keyword">null</span>) &#123;</div><div class="line">                clientLabel = service.getIntExtra(Intent.EXTRA_CLIENT_LABEL, <span class="number">0</span>);</div><div class="line">                <span class="keyword">if</span> (clientLabel != <span class="number">0</span>) &#123;</div><div class="line">                    <span class="comment">// There are no useful extras in the intent, trash them.</span></div><div class="line">                    <span class="comment">// System code calling with this stuff just needs to know</span></div><div class="line">                    <span class="comment">// this will happen.</span></div><div class="line">                    service = service.cloneFilter();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> ((flags&amp;Context.BIND_TREAT_LIKE_ACTIVITY) != <span class="number">0</span>) &#123;</div><div class="line">            mAm.enforceCallingPermission(android.Manifest.permission.MANAGE_ACTIVITY_STACKS,</div><div class="line">                    <span class="string">"BIND_TREAT_LIKE_ACTIVITY"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> callerFg = callerApp.setSchedGroup != Process.THREAD_GROUP_BG_NONINTERACTIVE;</div><div class="line"></div><div class="line">        ServiceLookupResult res =</div><div class="line">            retrieveServiceLocked(service, resolvedType, callingPackage,</div><div class="line">                    Binder.getCallingPid(), Binder.getCallingUid(), userId, <span class="keyword">true</span>, callerFg);</div><div class="line">        <span class="keyword">if</span> (res == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (res.record == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">        ServiceRecord s = res.record;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">if</span> (unscheduleServiceRestartLocked(s, callerApp.info.uid, <span class="keyword">false</span>)) &#123;</div><div class="line">              ...</div><div class="line"></div><div class="line">            <span class="keyword">if</span> ((flags&amp;Context.BIND_AUTO_CREATE) != <span class="number">0</span>) &#123;</div><div class="line">                s.lastActivity = SystemClock.uptimeMillis();</div><div class="line">                <span class="keyword">if</span> (!s.hasAutoCreateConnections()) &#123;</div><div class="line">                    <span class="comment">// This is the first binding, let the tracker know.</span></div><div class="line">                    ProcessStats.ServiceState stracker = s.getTracker();</div><div class="line">                    <span class="keyword">if</span> (stracker != <span class="keyword">null</span>) &#123;</div><div class="line">                        stracker.setBound(<span class="keyword">true</span>, mAm.mProcessStats.getMemFactorLocked(),</div><div class="line">                                s.lastActivity);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            mAm.startAssociationLocked(callerApp.uid, callerApp.processName,</div><div class="line">                    s.appInfo.uid, s.name, s.processName);</div><div class="line"></div><div class="line">            AppBindRecord b = s.retrieveAppBindingLocked(service, callerApp);</div><div class="line">            ConnectionRecord c = <span class="keyword">new</span> ConnectionRecord(b, activity,</div><div class="line">                    connection, flags, clientLabel, clientIntent);</div><div class="line"></div><div class="line">            IBinder binder = connection.asBinder();</div><div class="line">            ArrayList&lt;ConnectionRecord&gt; clist = s.connections.get(binder);</div><div class="line">            <span class="keyword">if</span> (clist == <span class="keyword">null</span>) &#123;</div><div class="line">                clist = <span class="keyword">new</span> ArrayList&lt;ConnectionRecord&gt;();</div><div class="line">                s.connections.put(binder, clist);</div><div class="line">            &#125;</div><div class="line">            clist.add(c);</div><div class="line">            b.connections.add(c);</div><div class="line">            <span class="keyword">if</span> (activity != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">if</span> (activity.connections == <span class="keyword">null</span>) &#123;</div><div class="line">                    activity.connections = <span class="keyword">new</span> HashSet&lt;ConnectionRecord&gt;();</div><div class="line">                &#125;</div><div class="line">                activity.connections.add(c);</div><div class="line">            &#125;</div><div class="line">            b.client.connections.add(c);</div><div class="line">            <span class="keyword">if</span> ((c.flags&amp;Context.BIND_ABOVE_CLIENT) != <span class="number">0</span>) &#123;</div><div class="line">                b.client.hasAboveClient = <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (s.app != <span class="keyword">null</span>) &#123;</div><div class="line">                updateServiceClientActivitiesLocked(s.app, c, <span class="keyword">true</span>);</div><div class="line">            &#125;</div><div class="line">            clist = mServiceConnections.get(binder);</div><div class="line">            <span class="keyword">if</span> (clist == <span class="keyword">null</span>) &#123;</div><div class="line">                clist = <span class="keyword">new</span> ArrayList&lt;ConnectionRecord&gt;();</div><div class="line">                mServiceConnections.put(binder, clist);</div><div class="line">            &#125;</div><div class="line">            clist.add(c);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> ((flags&amp;Context.BIND_AUTO_CREATE) != <span class="number">0</span>) &#123;</div><div class="line">                s.lastActivity = SystemClock.uptimeMillis();</div><div class="line">                <span class="keyword">if</span> (bringUpServiceLocked(s, service.getFlags(), callerFg, <span class="keyword">false</span>) != <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (s.app != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">if</span> ((flags&amp;Context.BIND_TREAT_LIKE_ACTIVITY) != <span class="number">0</span>) &#123;</div><div class="line">                    s.app.treatLikeActivity = <span class="keyword">true</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="comment">// This could have made the service more important.</span></div><div class="line">                mAm.updateLruProcessLocked(s.app, s.app.hasClientActivities</div><div class="line">                        || s.app.treatLikeActivity, b.client);</div><div class="line">                mAm.updateOomAdjLocked(s.app);</div><div class="line">            &#125;</div><div class="line">            ...</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (s.app != <span class="keyword">null</span> &amp;&amp; b.intent.received) &#123;</div><div class="line">                <span class="comment">// Service is already running, so we can immediately</span></div><div class="line">                <span class="comment">// publish the connection.</span></div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    c.conn.connected(s.name, b.intent.binder);</div><div class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                    ...</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">// If this is the first app connected back to this binding,</span></div><div class="line">                <span class="comment">// and the service had previously asked to be told when</span></div><div class="line">                <span class="comment">// rebound, then do so.</span></div><div class="line">                <span class="keyword">if</span> (b.intent.apps.size() == <span class="number">1</span> &amp;&amp; b.intent.doRebind) &#123;</div><div class="line">                    requestServiceBindingLocked(s, b.intent, callerFg, <span class="keyword">true</span>);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!b.intent.requested) &#123;</div><div class="line">                requestServiceBindingLocked(s, b.intent, callerFg, <span class="keyword">false</span>);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            getServiceMap(s.userId).ensureNotStartingBackground(s);</div><div class="line"></div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            Binder.restoreCallingIdentity(origId);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>这个方法主要做了以下事情:</p>
<ul>
<li>根据传递的IApplicationThread，通过AMS.getRecordForAppLocked()方法，从LRU缓存中获取ProcessRecord对象;这里可以保证一定能从缓存中取到，因为在App调用bindService()之前，所在的进程一定已经启动，只要启动了就会在AMS中留下进程记录。</li>
<li>前面提到的Activity的token在这里用上了，如果token不为null,就会从缓存中取出ActivityRecord, 类似地，如果是从Activity中调用bindService()，由于Activity已经启动，所以这里也一定可以取到ActivityRecord对象;</li>
<li>如果是系统uid,那么会从Intent中提取出clientIntent;</li>
<li>调用retrieveServiceLocked()方法来获取ServiceLookupResult这个查询结果，这个方法会先尝试从缓存中取出ServiceRecord对象，如果没有则新建ServiceRecord并且存入缓存中，最后返回的ServiceLookupResult是ServiceRecord的包装类;</li>
<li>调用unscheduleServiceRestartLocked(),即如果要绑定的Service在重启名单中，那么就将它从AMS的mHandler中移除重启的Callback;</li>
<li>之后调用ServiceRecord的retrieveAppBindingLocked()从缓存中获取或者新建AppBindRecord对象；</li>
<li>然后新建ConnectionRecord对象,这个对象包含的信息非常多，包括AppBindRecord对象，ActivityRecord对象，IServiceConnection代理，flags, clientLabel和clientIntent;</li>
<li>之后将ConnectionRecord对象放入缓存中，这个缓存的key是IServiceConnection的binder, value是ArrayList<connectionrecord>，这说明一个IServiceConnection可能对应多个ConnectionRecord,其实这也很好理解，因为一个client进程只有一个用于处理服务连接状态的IServiceConnection,但是一个client进程中却可能有多个连接;</connectionrecord></li>
<li>之后，如果ServiceRecord中的ProcessRecord不为空，则调用updateServiceClientActivitiesLocked()方法，这个方法主要作用就是查找client进程中是否存在activity,如果存在则更新AMS中ProcessRecord的LRU记录;</li>
<li>如果flags中含有Context.BIND_AUTO_CREATE标志，那么<strong>调用bringUpServiceLocked()将启动Service，这个过程还可能伴随启动Service所在进程(如果进程没有启动的话)</strong>; 在下一节将详细分析。</li>
</ul>
<h3 id="Service侧进程启动以及Service启动"><a href="#Service侧进程启动以及Service启动" class="headerlink" title="Service侧进程启动以及Service启动"></a>Service侧进程启动以及Service启动</h3><p>ActiveServices中bringUpServiceLocked()方法如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> String <span class="title">bringUpServiceLocked</span><span class="params">(ServiceRecord r, <span class="keyword">int</span> intentFlags, <span class="keyword">boolean</span> execInFg,</span></span></div><div class="line"><span class="function"><span class="params">         <span class="keyword">boolean</span> whileRestarting)</span> <span class="keyword">throws</span> TransactionTooLargeException </span>&#123;</div><div class="line">     <span class="comment">//Slog.i(TAG, "Bring up service:");</span></div><div class="line">     <span class="comment">//r.dump("  ");</span></div><div class="line"></div><div class="line">     <span class="keyword">if</span> (r.app != <span class="keyword">null</span> &amp;&amp; r.app.thread != <span class="keyword">null</span>) &#123;</div><div class="line">         sendServiceArgsLocked(r, execInFg, <span class="keyword">false</span>);</div><div class="line">         <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     <span class="keyword">if</span> (!whileRestarting &amp;&amp; r.restartDelay &gt; <span class="number">0</span>) &#123;</div><div class="line">         <span class="comment">// If waiting for a restart, then do nothing.</span></div><div class="line">         <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"Bringing up "</span> + r + <span class="string">" "</span> + r.intent);</div><div class="line"></div><div class="line">     <span class="comment">// We are now bringing the service up, so no longer in the</span></div><div class="line">     <span class="comment">// restarting state.</span></div><div class="line">     <span class="keyword">if</span> (mRestartingServices.remove(r)) &#123;</div><div class="line">         r.resetRestartCounter();</div><div class="line">         clearRestartingIfNeededLocked(r);</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     <span class="comment">// Make sure this service is no longer considered delayed, we are starting it now.</span></div><div class="line">     <span class="keyword">if</span> (r.delayed) &#123;</div><div class="line">         <span class="keyword">if</span> (DEBUG_DELAYED_STARTS) Slog.v(TAG_SERVICE, <span class="string">"REM FR DELAY LIST (bring up): "</span> + r);</div><div class="line">         getServiceMap(r.userId).mDelayedStartList.remove(r);</div><div class="line">         r.delayed = <span class="keyword">false</span>;</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     <span class="comment">// Make sure that the user who owns this service is started.  If not,</span></div><div class="line">     <span class="comment">// we don't want to allow it to run.</span></div><div class="line">     <span class="keyword">if</span> (mAm.mStartedUsers.get(r.userId) == <span class="keyword">null</span>) &#123;</div><div class="line">         String msg = <span class="string">"Unable to launch app "</span></div><div class="line">                 + r.appInfo.packageName + <span class="string">"/"</span></div><div class="line">                 + r.appInfo.uid + <span class="string">" for service "</span></div><div class="line">                 + r.intent.getIntent() + <span class="string">": user "</span> + r.userId + <span class="string">" is stopped"</span>;</div><div class="line">         Slog.w(TAG, msg);</div><div class="line">         bringDownServiceLocked(r);</div><div class="line">         <span class="keyword">return</span> msg;</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     <span class="comment">// Service is now being launched, its package can't be stopped.</span></div><div class="line">     <span class="keyword">try</span> &#123;</div><div class="line">         AppGlobals.getPackageManager().setPackageStoppedState(</div><div class="line">                 r.packageName, <span class="keyword">false</span>, r.userId);</div><div class="line">     &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">     &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</div><div class="line">         Slog.w(TAG, <span class="string">"Failed trying to unstop package "</span></div><div class="line">                 + r.packageName + <span class="string">": "</span> + e);</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     <span class="keyword">final</span> <span class="keyword">boolean</span> isolated = (r.serviceInfo.flags&amp;ServiceInfo.FLAG_ISOLATED_PROCESS) != <span class="number">0</span>;</div><div class="line">     <span class="keyword">final</span> String procName = r.processName;</div><div class="line">     ProcessRecord app;</div><div class="line"></div><div class="line">     <span class="keyword">if</span> (!isolated) &#123;</div><div class="line">         app = mAm.getProcessRecordLocked(procName, r.appInfo.uid, <span class="keyword">false</span>);</div><div class="line">         <span class="keyword">if</span> (DEBUG_MU) Slog.v(TAG_MU, <span class="string">"bringUpServiceLocked: appInfo.uid="</span> + r.appInfo.uid</div><div class="line">                     + <span class="string">" app="</span> + app);</div><div class="line">         <span class="keyword">if</span> (app != <span class="keyword">null</span> &amp;&amp; app.thread != <span class="keyword">null</span>) &#123;</div><div class="line">             <span class="keyword">try</span> &#123;</div><div class="line">                 app.addPackage(r.appInfo.packageName, r.appInfo.versionCode, mAm.mProcessStats);</div><div class="line">                 realStartServiceLocked(r, app, execInFg);</div><div class="line">                 <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">             &#125; <span class="keyword">catch</span> (TransactionTooLargeException e) &#123;</div><div class="line">                 <span class="keyword">throw</span> e;</div><div class="line">             &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">                 Slog.w(TAG, <span class="string">"Exception when starting service "</span> + r.shortName, e);</div><div class="line">             &#125;</div><div class="line"></div><div class="line">             <span class="comment">// If a dead object exception was thrown -- fall through to</span></div><div class="line">             <span class="comment">// restart the application.</span></div><div class="line">         &#125;</div><div class="line">     &#125; <span class="keyword">else</span> &#123;</div><div class="line">         <span class="comment">// If this service runs in an isolated process, then each time</span></div><div class="line">         <span class="comment">// we call startProcessLocked() we will get a new isolated</span></div><div class="line">         <span class="comment">// process, starting another process if we are currently waiting</span></div><div class="line">         <span class="comment">// for a previous process to come up.  To deal with this, we store</span></div><div class="line">         <span class="comment">// in the service any current isolated process it is running in or</span></div><div class="line">         <span class="comment">// waiting to have come up.</span></div><div class="line">         app = r.isolatedProc;</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     <span class="comment">// Not running -- get it started, and enqueue this service record</span></div><div class="line">     <span class="comment">// to be executed when the app comes up.</span></div><div class="line">     <span class="keyword">if</span> (app == <span class="keyword">null</span>) &#123;</div><div class="line">         <span class="keyword">if</span> ((app=mAm.startProcessLocked(procName, r.appInfo, <span class="keyword">true</span>, intentFlags,</div><div class="line">                 <span class="string">"service"</span>, r.name, <span class="keyword">false</span>, isolated, <span class="keyword">false</span>)) == <span class="keyword">null</span>) &#123;</div><div class="line">             String msg = <span class="string">"Unable to launch app "</span></div><div class="line">                     + r.appInfo.packageName + <span class="string">"/"</span></div><div class="line">                     + r.appInfo.uid + <span class="string">" for service "</span></div><div class="line">                     + r.intent.getIntent() + <span class="string">": process is bad"</span>;</div><div class="line">             Slog.w(TAG, msg);</div><div class="line">             bringDownServiceLocked(r);</div><div class="line">             <span class="keyword">return</span> msg;</div><div class="line">         &#125;</div><div class="line">         <span class="keyword">if</span> (isolated) &#123;</div><div class="line">             r.isolatedProc = app;</div><div class="line">         &#125;</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     <span class="keyword">if</span> (!mPendingServices.contains(r)) &#123;</div><div class="line">         mPendingServices.add(r);</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     <span class="keyword">if</span> (r.delayedStop) &#123;</div><div class="line">         <span class="comment">// Oh and hey we've already been asked to stop!</span></div><div class="line">         r.delayedStop = <span class="keyword">false</span>;</div><div class="line">         <span class="keyword">if</span> (r.startRequested) &#123;</div><div class="line">             <span class="keyword">if</span> (DEBUG_DELAYED_STARTS) Slog.v(TAG_SERVICE,</div><div class="line">                     <span class="string">"Applying delayed stop (in bring up): "</span> + r);</div><div class="line">             stopServiceLocked(r);</div><div class="line">         &#125;</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>首先尝试从AMS.getProcessRecordLocked()方法中获取ProcessRecord,如果获取到了，说明进程已经启动，就可以调用realStartServiceLocked()方法启动Service了:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">realStartServiceLocked</span><span class="params">(ServiceRecord r,</span></span></div><div class="line"><span class="function"><span class="params">            ProcessRecord app, <span class="keyword">boolean</span> execInFg)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</div><div class="line">        <span class="keyword">if</span> (app.thread == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RemoteException();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (DEBUG_MU)</div><div class="line">            Slog.v(TAG_MU, <span class="string">"realStartServiceLocked, ServiceRecord.uid = "</span> + r.appInfo.uid</div><div class="line">                    + <span class="string">", ProcessRecord.uid = "</span> + app.uid);</div><div class="line">        r.app = app;</div><div class="line">        r.restartTime = r.lastActivity = SystemClock.uptimeMillis();</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> newService = app.services.add(r);</div><div class="line">        bumpServiceExecutingLocked(r, execInFg, <span class="string">"create"</span>);</div><div class="line">        mAm.updateLruProcessLocked(app, <span class="keyword">false</span>, <span class="keyword">null</span>);</div><div class="line">        mAm.updateOomAdjLocked();</div><div class="line"></div><div class="line">        <span class="keyword">boolean</span> created = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">if</span> (LOG_SERVICE_START_STOP) &#123;</div><div class="line">                String nameTerm;</div><div class="line">                <span class="keyword">int</span> lastPeriod = r.shortName.lastIndexOf(<span class="string">'.'</span>);</div><div class="line">                nameTerm = lastPeriod &gt;= <span class="number">0</span> ? r.shortName.substring(lastPeriod) : r.shortName;</div><div class="line">                EventLogTags.writeAmCreateService(</div><div class="line">                        r.userId, System.identityHashCode(r), nameTerm, r.app.uid, r.app.pid);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">synchronized</span> (r.stats.getBatteryStats()) &#123;</div><div class="line">                r.stats.startLaunchedLocked();</div><div class="line">            &#125;</div><div class="line">            mAm.ensurePackageDexOpt(r.serviceInfo.packageName);</div><div class="line">            app.forceProcessStateUpTo(ActivityManager.PROCESS_STATE_SERVICE);</div><div class="line">            app.thread.scheduleCreateService(r, r.serviceInfo,</div><div class="line">                    mAm.compatibilityInfoForPackageLocked(r.serviceInfo.applicationInfo),</div><div class="line">                    app.repProcState);</div><div class="line">            r.postNotification();</div><div class="line">            created = <span class="keyword">true</span>;</div><div class="line">        &#125; <span class="keyword">catch</span> (DeadObjectException e) &#123;</div><div class="line">            Slog.w(TAG, <span class="string">"Application dead when creating service "</span> + r);</div><div class="line">            mAm.appDiedLocked(app);</div><div class="line">            <span class="keyword">throw</span> e;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            <span class="keyword">if</span> (!created) &#123;</div><div class="line">                <span class="comment">// Keep the executeNesting count accurate.</span></div><div class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> inDestroying = mDestroyingServices.contains(r);</div><div class="line">                serviceDoneExecutingLocked(r, inDestroying, inDestroying);</div><div class="line"></div><div class="line">                <span class="comment">// Cleanup.</span></div><div class="line">                <span class="keyword">if</span> (newService) &#123;</div><div class="line">                    app.services.remove(r);</div><div class="line">                    r.app = <span class="keyword">null</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">// Retry.</span></div><div class="line">                <span class="keyword">if</span> (!inDestroying) &#123;</div><div class="line">                    scheduleServiceRestartLocked(r, <span class="keyword">false</span>);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        requestServiceBindingsLocked(r, execInFg);</div><div class="line"></div><div class="line">        updateServiceClientActivitiesLocked(app, <span class="keyword">null</span>, <span class="keyword">true</span>);</div><div class="line"></div><div class="line">        <span class="comment">// If the service is in the started state, and there are no</span></div><div class="line">        <span class="comment">// pending arguments, then fake up one so its onStartCommand() will</span></div><div class="line">        <span class="comment">// be called.</span></div><div class="line">        <span class="keyword">if</span> (r.startRequested &amp;&amp; r.callStart &amp;&amp; r.pendingStarts.size() == <span class="number">0</span>) &#123;</div><div class="line">            r.pendingStarts.add(<span class="keyword">new</span> ServiceRecord.StartItem(r, <span class="keyword">false</span>, r.makeNextStartId(),</div><div class="line">                    <span class="keyword">null</span>, <span class="keyword">null</span>));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        sendServiceArgsLocked(r, execInFg, <span class="keyword">true</span>);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (r.delayed) &#123;</div><div class="line">            <span class="keyword">if</span> (DEBUG_DELAYED_STARTS) Slog.v(TAG_SERVICE, <span class="string">"REM FR DELAY LIST (new proc): "</span> + r);</div><div class="line">            getServiceMap(r.userId).mDelayedStartList.remove(r);</div><div class="line">            r.delayed = <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (r.delayedStop) &#123;</div><div class="line">            <span class="comment">// Oh and hey we've already been asked to stop!</span></div><div class="line">            r.delayedStop = <span class="keyword">false</span>;</div><div class="line">            <span class="keyword">if</span> (r.startRequested) &#123;</div><div class="line">                <span class="keyword">if</span> (DEBUG_DELAYED_STARTS) Slog.v(TAG_SERVICE,</div><div class="line">                        <span class="string">"Applying delayed stop (from start): "</span> + r);</div><div class="line">                stopServiceLocked(r);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>这个方法也很长，主要做了以下事情:</p>
<ul>
<li>调用AMS.updateLruProcessLocked()方法更新ProcessRecord的LRU缓存;</li>
<li>调用AMS.updateOomAdjLocked()方法更新Service所在进程的oom_adj值;</li>
<li>通过ProcessRecord中的IApplicationThread的代理，<strong>通过IPC调用scheduleCreateService()方法，进行Service的创建</strong>，ApplicationThread中的调用过程以前我们分析过很多，这里就不再赘述了;</li>
<li>如果发现不需要重新创建(比如已经创建了),那么就进行一些状态维护即可</li>
<li><p>之后<strong>调用requestServiceBindingsLocked()方法，这个方法非常重要，就是在这里，把Service的onBind()与要提供的服务关联起来了</strong>。该方法如下:</p>
<pre><code>​<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">requestServiceBindingsLocked</span><span class="params">(ServiceRecord r, <span class="keyword">boolean</span> execInFg)</span></span></div><div class="line"><span class="function">        <span class="keyword">throws</span> TransactionTooLargeException </span>&#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=r.bindings.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</div><div class="line">        IntentBindRecord ibr = r.bindings.valueAt(i);</div><div class="line">        <span class="keyword">if</span> (!requestServiceBindingLocked(r, ibr, execInFg, <span class="keyword">false</span>)) &#123;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">   ​</div></pre></td></tr></table></figure>
</code></pre></li>
</ul>
<p>显然，这里是遍历ServiceRecord中的IntentBindRecord,即所有的绑定记录，然后调用requestServiceBindingLocked()方法，只要有一个执行成功即中断。而requestServiceBindingLocked()方法如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">requestServiceBindingLocked</span><span class="params">(ServiceRecord r, IntentBindRecord i,</span></span></div><div class="line"><span class="function"><span class="params">          <span class="keyword">boolean</span> execInFg, <span class="keyword">boolean</span> rebind)</span> <span class="keyword">throws</span> TransactionTooLargeException </span>&#123;</div><div class="line">      <span class="keyword">if</span> (r.app == <span class="keyword">null</span> || r.app.thread == <span class="keyword">null</span>) &#123;</div><div class="line">          <span class="comment">// If service is not currently running, can't yet bind.</span></div><div class="line">          <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> ((!i.requested || rebind) &amp;&amp; i.apps.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">          <span class="keyword">try</span> &#123;</div><div class="line">              bumpServiceExecutingLocked(r, execInFg, <span class="string">"bind"</span>);</div><div class="line">              r.app.forceProcessStateUpTo(ActivityManager.PROCESS_STATE_SERVICE);</div><div class="line">              r.app.thread.scheduleBindService(r, i.intent.getIntent(), rebind,</div><div class="line">                      r.app.repProcState);</div><div class="line">              <span class="keyword">if</span> (!rebind) &#123;</div><div class="line">                  i.requested = <span class="keyword">true</span>;</div><div class="line">              &#125;</div><div class="line">              i.hasBound = <span class="keyword">true</span>;</div><div class="line">              i.doRebind = <span class="keyword">false</span>;</div><div class="line">          &#125; <span class="keyword">catch</span> (TransactionTooLargeException e) &#123;</div><div class="line">              <span class="comment">// Keep the executeNesting count accurate.</span></div><div class="line">              <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"Crashed while binding "</span> + r, e);</div><div class="line">              <span class="keyword">final</span> <span class="keyword">boolean</span> inDestroying = mDestroyingServices.contains(r);</div><div class="line">              serviceDoneExecutingLocked(r, inDestroying, inDestroying);</div><div class="line">              <span class="keyword">throw</span> e;</div><div class="line">          &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">              <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"Crashed while binding "</span> + r);</div><div class="line">              <span class="comment">// Keep the executeNesting count accurate.</span></div><div class="line">              <span class="keyword">final</span> <span class="keyword">boolean</span> inDestroying = mDestroyingServices.contains(r);</div><div class="line">              serviceDoneExecutingLocked(r, inDestroying, inDestroying);</div><div class="line">              <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>这个方法的重点是调用ApplicationThread的代理，通过IPC调用scheduleBindService(), 注意这里会将ServiceRecord(继承自Binder)传递过去(后面要给它赋值),而ApplicationThread中的scheduleBindService()方法如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">scheduleBindService</span><span class="params">(IBinder token, Intent intent,</span></span></div><div class="line"><span class="function"><span class="params">             <span class="keyword">boolean</span> rebind, <span class="keyword">int</span> processState)</span> </span>&#123;</div><div class="line">         updateProcessState(processState, <span class="keyword">false</span>);</div><div class="line">         BindServiceData s = <span class="keyword">new</span> BindServiceData();</div><div class="line">         s.token = token;</div><div class="line">         s.intent = intent;</div><div class="line">         s.rebind = rebind;</div><div class="line"></div><div class="line">         <span class="keyword">if</span> (DEBUG_SERVICE)</div><div class="line">             Slog.v(TAG, <span class="string">"scheduleBindService token="</span> + token + <span class="string">" intent="</span> + intent + <span class="string">" uid="</span></div><div class="line">                     + Binder.getCallingUid() + <span class="string">" pid="</span> + Binder.getCallingPid());</div><div class="line">         sendMessage(H.BIND_SERVICE, s);</div><div class="line">     &#125;</div></pre></td></tr></table></figure>
<p>这个方法很简单，就是新建了一个包装类BindServiceData对象，然后通过H传递消息到主线程，之后调用handleBindService()方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleBindService</span><span class="params">(BindServiceData data)</span> </span>&#123;</div><div class="line">    Service s = mServices.get(data.token);</div><div class="line">    <span class="keyword">if</span> (DEBUG_SERVICE)</div><div class="line">        Slog.v(TAG, <span class="string">"handleBindService s="</span> + s + <span class="string">" rebind="</span> + data.rebind);</div><div class="line">    <span class="keyword">if</span> (s != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            data.intent.setExtrasClassLoader(s.getClassLoader());</div><div class="line">            data.intent.prepareToEnterProcess();</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="keyword">if</span> (!data.rebind) &#123;</div><div class="line">                    IBinder binder = s.onBind(data.intent);</div><div class="line">                    ActivityManagerNative.getDefault().publishService(</div><div class="line">                            data.token, data.intent, binder);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    s.onRebind(data.intent);</div><div class="line">                    ActivityManagerNative.getDefault().serviceDoneExecuting(</div><div class="line">                            data.token, SERVICE_DONE_EXECUTING_ANON, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">                &#125;</div><div class="line">                ensureJitEnabled();</div><div class="line">            &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            <span class="keyword">if</span> (!mInstrumentation.onException(s, e)) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</div><div class="line">                        <span class="string">"Unable to bind to service "</span> + s</div><div class="line">                        + <span class="string">" with "</span> + data.intent + <span class="string">": "</span> + e.toString(), e);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里的data.token就是IPC调用传递过来的ServiceRecord对象，由于在前面已经通过IPC调用启动了Service对象，所以这里可以通过data.token从缓存中取出Service对象，然后分两种情况:</p>
<ul>
<li><strong>如果不是重连，那么就调用Service的onBind()方法获取IBinder,而获取的这个binder会在pushlishService()时传递到AMS中，之后又会通过AMS到client进程中，这也就是client中获取到Service中onBind()所返回的binder的原因。之后就进行IPC调用，最终会调用到AMS.publishService()方法，这个方法在后面会进行详细分析，这里先放一下</strong>;</li>
<li><strong>否则回调Service的onRebind()方法,这个方法经常被我们忽视，实际上也很重要。</strong>之后通过IPC调用到AMS的serviceDoneExecuting()方法。</li>
</ul>
<p>至此，Service侧的调用就基本结束了，主要是AMS对其的两次IPC调用，分别是IApplicationThread的scheduleCreateService()和scheduleBindService(), 前者是为了新建Service, 而后者是获取Service的onBind()所返回的IBinder对象。</p>
<h3 id="继续ActiveServices-bringUpServiceLocked-方法分析"><a href="#继续ActiveServices-bringUpServiceLocked-方法分析" class="headerlink" title="继续ActiveServices.bringUpServiceLocked()方法分析"></a>继续ActiveServices.bringUpServiceLocked()方法分析</h3><p>再回到ActiveServices的bringUpServiceLocked()方法中，对于还未启动或者进程已经回收的进程的情况，需要先调用AMS.startProcessLocked()方法来启动进程，并且等到进程启动完成之后再进行绑定。</p>
<p>那它是如何实现这点的呢？</p>
<p>其实很简单，就是将ServiceRecord先放到mPendingServices中，代码片段如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line"> <span class="comment">// Not running -- get it started, and enqueue this service record</span></div><div class="line">        <span class="comment">// to be executed when the app comes up.</span></div><div class="line">        <span class="keyword">if</span> (app == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> ((app=mAm.startProcessLocked(procName, r.appInfo, <span class="keyword">true</span>, intentFlags,</div><div class="line">                    <span class="string">"service"</span>, r.name, <span class="keyword">false</span>, isolated, <span class="keyword">false</span>)) == <span class="keyword">null</span>) &#123;</div><div class="line">                String msg = <span class="string">"Unable to launch app "</span></div><div class="line">                        + r.appInfo.packageName + <span class="string">"/"</span></div><div class="line">                        + r.appInfo.uid + <span class="string">" for service "</span></div><div class="line">                        + r.intent.getIntent() + <span class="string">": process is bad"</span>;</div><div class="line">                Slog.w(TAG, msg);</div><div class="line">                bringDownServiceLocked(r);</div><div class="line">                <span class="keyword">return</span> msg;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (isolated) &#123;</div><div class="line">                r.isolatedProc = app;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (!mPendingServices.contains(r)) &#123;</div><div class="line">            mPendingServices.add(r);</div><div class="line">        &#125;</div><div class="line">...</div></pre></td></tr></table></figure>
<p>这个mPendingServices顾名思义，就是暂时挂起的服务，那它等到什么时候会用到呢？或者说要挂起到什么时候才能被使用呢？</p>
<p><strong>答案就在AMS的attachApplicationLocked()方法中</strong>。</p>
<p>在启动Service所在进程后，会通过IPC调用到AMS的attachApplication()—&gt;attachApplicationLocked()方法，</p>
<p>而在AMS的attachApplicationLocked()方法中，有如下代码片段:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">...  </div><div class="line"><span class="comment">// Find any services that should be running in this process...</span></div><div class="line">        <span class="keyword">if</span> (!badApp) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                didSomething |= mServices.attachApplicationLocked(app, processName);</div><div class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                Slog.wtf(TAG, <span class="string">"Exception thrown starting services in "</span> + app, e);</div><div class="line">                badApp = <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">...</div></pre></td></tr></table></figure>
<p>注释已经写得很清楚了，就是执行到这里时，查找那些本来应该运行在这个进程的Service(由于进程没启动而暂时挂起的那些), 然后调用到ActiveServices的attachApplicationLocked()方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">attachApplicationLocked</span><span class="params">(ProcessRecord proc, String processName)</span></span></div><div class="line"><span class="function">            <span class="keyword">throws</span> RemoteException </span>&#123;</div><div class="line">        <span class="keyword">boolean</span> didSomething = <span class="keyword">false</span>;</div><div class="line">        <span class="comment">// Collect any services that are waiting for this process to come up.</span></div><div class="line">        <span class="keyword">if</span> (mPendingServices.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">            ServiceRecord sr = <span class="keyword">null</span>;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;mPendingServices.size(); i++) &#123;</div><div class="line">                    sr = mPendingServices.get(i);</div><div class="line">                    <span class="keyword">if</span> (proc != sr.isolatedProc &amp;&amp; (proc.uid != sr.appInfo.uid</div><div class="line">                            || !processName.equals(sr.processName))) &#123;</div><div class="line">                        <span class="keyword">continue</span>;</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    mPendingServices.remove(i);</div><div class="line">                    i--;</div><div class="line">                    proc.addPackage(sr.appInfo.packageName, sr.appInfo.versionCode,</div><div class="line">                            mAm.mProcessStats);</div><div class="line">                    realStartServiceLocked(sr, proc, sr.createdFromFg);</div><div class="line">                    didSomething = <span class="keyword">true</span>;</div><div class="line">                    <span class="keyword">if</span> (!isServiceNeeded(sr, <span class="keyword">false</span>, <span class="keyword">false</span>)) &#123;</div><div class="line">                        <span class="comment">// We were waiting for this service to start, but it is actually no</span></div><div class="line">                        <span class="comment">// longer needed.  This could happen because bringDownServiceIfNeeded</span></div><div class="line">                        <span class="comment">// won't bring down a service that is pending...  so now the pending</span></div><div class="line">                        <span class="comment">// is done, so let's drop it.</span></div><div class="line">                        bringDownServiceLocked(sr);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">                Slog.w(TAG, <span class="string">"Exception in new application when starting service "</span></div><div class="line">                        + sr.shortName, e);</div><div class="line">                <span class="keyword">throw</span> e;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// Also, if there are any services that are waiting to restart and</span></div><div class="line">        <span class="comment">// would run in this process, now is a good time to start them.  It would</span></div><div class="line">        <span class="comment">// be weird to bring up the process but arbitrarily not let the services</span></div><div class="line">        <span class="comment">// run at this point just because their restart time hasn't come up.</span></div><div class="line">        <span class="keyword">if</span> (mRestartingServices.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">            ServiceRecord sr;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;mRestartingServices.size(); i++) &#123;</div><div class="line">                sr = mRestartingServices.get(i);</div><div class="line">                <span class="keyword">if</span> (proc != sr.isolatedProc &amp;&amp; (proc.uid != sr.appInfo.uid</div><div class="line">                        || !processName.equals(sr.processName))) &#123;</div><div class="line">                    <span class="keyword">continue</span>;</div><div class="line">                &#125;</div><div class="line">                mAm.mHandler.removeCallbacks(sr.restarter);</div><div class="line">                mAm.mHandler.post(sr.restarter);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> didSomething;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>显然，在这个方法里面，会调用realStarServiceLocked()方法完成Service的创建和绑定工作，由于前面已经分析过，这里就不再赘述了。</p>
<h3 id="AMS中更新oom-adj值"><a href="#AMS中更新oom-adj值" class="headerlink" title="AMS中更新oom_adj值"></a>AMS中更新oom_adj值</h3><p>由于在上一步可能进行启动Service所在进程的操作，所以在这里再次对s.app是否为null进行判断，然后同样也更新了ProcessRecord的LRU记录；<strong>并且，有一个很重要的操作是调用了AMS的updateOomAdjLocked()方法更新client进程的oom_adj值</strong>，该方法如下:</p>
<pre><code><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">updateOomAdjLocked</span><span class="params">(ProcessRecord app)</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> ActivityRecord TOP_ACT = resumedAppLocked();</div><div class="line">        <span class="keyword">final</span> ProcessRecord TOP_APP = TOP_ACT != <span class="keyword">null</span> ? TOP_ACT.app : <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> wasCached = app.cached;</div><div class="line">    </div><div class="line">        mAdjSeq++;</div><div class="line">    </div><div class="line">        <span class="comment">// This is the desired cached adjusment we want to tell it to use.</span></div><div class="line">        <span class="comment">// If our app is currently cached, we know it, and that is it.  Otherwise,</span></div><div class="line">        <span class="comment">// we don't know it yet, and it needs to now be cached we will then</span></div><div class="line">        <span class="comment">// need to do a complete oom adj.</span></div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> cachedAdj = app.curRawAdj &gt;= ProcessList.CACHED_APP_MIN_ADJ</div><div class="line">                ? app.curRawAdj : ProcessList.UNKNOWN_ADJ;</div><div class="line">        <span class="keyword">boolean</span> success = updateOomAdjLocked(app, cachedAdj, TOP_APP, <span class="keyword">false</span>,</div><div class="line">                SystemClock.uptimeMillis());</div><div class="line">        <span class="keyword">if</span> (wasCached != app.cached || app.curRawAdj == ProcessList.UNKNOWN_ADJ) &#123;</div><div class="line">            <span class="comment">// Changed to/from cached state, so apps after it in the LRU</span></div><div class="line">            <span class="comment">// list may also be changed.</span></div><div class="line">            updateOomAdjLocked();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> success;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</code></pre><p>注释中已经写得很清楚了，就是如果app进程(即发起bindService()的那个进程)是缓存的，那么取app进程当前的oom_adj值和ProcessList.CACHED_APP_MIN_ADJ中的较大值，然后调用updateOomAdjLocked()方法更新app进程的oom_adj值即可。该方法如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">updateOomAdjLocked</span><span class="params">(ProcessRecord app, <span class="keyword">int</span> cachedAdj,</span></span></div><div class="line"><span class="function"><span class="params">           ProcessRecord TOP_APP, <span class="keyword">boolean</span> doingAll, <span class="keyword">long</span> now)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (app.thread == <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       computeOomAdjLocked(app, cachedAdj, TOP_APP, doingAll, now);</div><div class="line"></div><div class="line">       <span class="keyword">return</span> applyOomAdjLocked(app, doingAll, now, SystemClock.elapsedRealtime());</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>可见这里主要就是调用了computeOomAdjLocked()方法对于app进程的oom_adj值进行了一次计算，然后调用applyOomAdjLocked()方法将计算结果运用上去。</p>
<p>其中computeOomAdjLocked()方法非常重要，现在市面上所谓的进程保活措施的依据有很多就是来自于这里。这个方法的分析请见下一小节。</p>
<p>另外，由于AMS的updateOomAdjLocked()方法非常复杂，以至于我觉得有必要专门用一小节来分析，详情请看下下小节。</p>
<h3 id="AMS-computeOomAdjLocked"><a href="#AMS-computeOomAdjLocked" class="headerlink" title="AMS.computeOomAdjLocked()"></a>AMS.computeOomAdjLocked()</h3><p>该方法如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div><div class="line">411</div><div class="line">412</div><div class="line">413</div><div class="line">414</div><div class="line">415</div><div class="line">416</div><div class="line">417</div><div class="line">418</div><div class="line">419</div><div class="line">420</div><div class="line">421</div><div class="line">422</div><div class="line">423</div><div class="line">424</div><div class="line">425</div><div class="line">426</div><div class="line">427</div><div class="line">428</div><div class="line">429</div><div class="line">430</div><div class="line">431</div><div class="line">432</div><div class="line">433</div><div class="line">434</div><div class="line">435</div><div class="line">436</div><div class="line">437</div><div class="line">438</div><div class="line">439</div><div class="line">440</div><div class="line">441</div><div class="line">442</div><div class="line">443</div><div class="line">444</div><div class="line">445</div><div class="line">446</div><div class="line">447</div><div class="line">448</div><div class="line">449</div><div class="line">450</div><div class="line">451</div><div class="line">452</div><div class="line">453</div><div class="line">454</div><div class="line">455</div><div class="line">456</div><div class="line">457</div><div class="line">458</div><div class="line">459</div><div class="line">460</div><div class="line">461</div><div class="line">462</div><div class="line">463</div><div class="line">464</div><div class="line">465</div><div class="line">466</div><div class="line">467</div><div class="line">468</div><div class="line">469</div><div class="line">470</div><div class="line">471</div><div class="line">472</div><div class="line">473</div><div class="line">474</div><div class="line">475</div><div class="line">476</div><div class="line">477</div><div class="line">478</div><div class="line">479</div><div class="line">480</div><div class="line">481</div><div class="line">482</div><div class="line">483</div><div class="line">484</div><div class="line">485</div><div class="line">486</div><div class="line">487</div><div class="line">488</div><div class="line">489</div><div class="line">490</div><div class="line">491</div><div class="line">492</div><div class="line">493</div><div class="line">494</div><div class="line">495</div><div class="line">496</div><div class="line">497</div><div class="line">498</div><div class="line">499</div><div class="line">500</div><div class="line">501</div><div class="line">502</div><div class="line">503</div><div class="line">504</div><div class="line">505</div><div class="line">506</div><div class="line">507</div><div class="line">508</div><div class="line">509</div><div class="line">510</div><div class="line">511</div><div class="line">512</div><div class="line">513</div><div class="line">514</div><div class="line">515</div><div class="line">516</div><div class="line">517</div><div class="line">518</div><div class="line">519</div><div class="line">520</div><div class="line">521</div><div class="line">522</div><div class="line">523</div><div class="line">524</div><div class="line">525</div><div class="line">526</div><div class="line">527</div><div class="line">528</div><div class="line">529</div><div class="line">530</div><div class="line">531</div><div class="line">532</div><div class="line">533</div><div class="line">534</div><div class="line">535</div><div class="line">536</div><div class="line">537</div><div class="line">538</div><div class="line">539</div><div class="line">540</div><div class="line">541</div><div class="line">542</div><div class="line">543</div><div class="line">544</div><div class="line">545</div><div class="line">546</div><div class="line">547</div><div class="line">548</div><div class="line">549</div><div class="line">550</div><div class="line">551</div><div class="line">552</div><div class="line">553</div><div class="line">554</div><div class="line">555</div><div class="line">556</div><div class="line">557</div><div class="line">558</div><div class="line">559</div><div class="line">560</div><div class="line">561</div><div class="line">562</div><div class="line">563</div><div class="line">564</div><div class="line">565</div><div class="line">566</div><div class="line">567</div><div class="line">568</div><div class="line">569</div><div class="line">570</div><div class="line">571</div><div class="line">572</div><div class="line">573</div><div class="line">574</div><div class="line">575</div><div class="line">576</div><div class="line">577</div><div class="line">578</div><div class="line">579</div><div class="line">580</div><div class="line">581</div><div class="line">582</div><div class="line">583</div><div class="line">584</div><div class="line">585</div><div class="line">586</div><div class="line">587</div><div class="line">588</div><div class="line">589</div><div class="line">590</div><div class="line">591</div><div class="line">592</div><div class="line">593</div><div class="line">594</div><div class="line">595</div><div class="line">596</div><div class="line">597</div><div class="line">598</div><div class="line">599</div><div class="line">600</div><div class="line">601</div><div class="line">602</div><div class="line">603</div><div class="line">604</div><div class="line">605</div><div class="line">606</div><div class="line">607</div><div class="line">608</div><div class="line">609</div><div class="line">610</div><div class="line">611</div><div class="line">612</div><div class="line">613</div><div class="line">614</div><div class="line">615</div><div class="line">616</div><div class="line">617</div><div class="line">618</div><div class="line">619</div><div class="line">620</div><div class="line">621</div><div class="line">622</div><div class="line">623</div><div class="line">624</div><div class="line">625</div><div class="line">626</div><div class="line">627</div><div class="line">628</div><div class="line">629</div><div class="line">630</div><div class="line">631</div><div class="line">632</div><div class="line">633</div><div class="line">634</div><div class="line">635</div><div class="line">636</div><div class="line">637</div><div class="line">638</div><div class="line">639</div><div class="line">640</div><div class="line">641</div><div class="line">642</div><div class="line">643</div><div class="line">644</div><div class="line">645</div><div class="line">646</div><div class="line">647</div><div class="line">648</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">computeOomAdjLocked</span><span class="params">(ProcessRecord app, <span class="keyword">int</span> cachedAdj, ProcessRecord TOP_APP,</span></span></div><div class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> doingAll, <span class="keyword">long</span> now)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (mAdjSeq == app.adjSeq) &#123;</div><div class="line">        <span class="comment">// This adjustment has already been computed.</span></div><div class="line">        <span class="keyword">return</span> app.curRawAdj;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (app.thread == <span class="keyword">null</span>) &#123;</div><div class="line">        app.adjSeq = mAdjSeq;</div><div class="line">        app.curSchedGroup = Process.THREAD_GROUP_BG_NONINTERACTIVE;</div><div class="line">        app.curProcState = ActivityManager.PROCESS_STATE_CACHED_EMPTY;</div><div class="line">        <span class="keyword">return</span> (app.curAdj=app.curRawAdj=ProcessList.CACHED_APP_MAX_ADJ);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    app.adjTypeCode = ActivityManager.RunningAppProcessInfo.REASON_UNKNOWN;</div><div class="line">    app.adjSource = <span class="keyword">null</span>;</div><div class="line">    app.adjTarget = <span class="keyword">null</span>;</div><div class="line">    app.empty = <span class="keyword">false</span>;</div><div class="line">    app.cached = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> activitiesSize = app.activities.size();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (app.maxAdj &lt;= ProcessList.FOREGROUND_APP_ADJ) &#123;  <span class="comment">//这表示app.maxAdj的优先级比ProcessList.FOREGROUND_APP_ADJ还高，那当然就要调整一下了</span></div><div class="line">        <span class="comment">// The max adjustment doesn't allow this app to be anything</span></div><div class="line">        <span class="comment">// below foreground, so it is not worth doing work for it.</span></div><div class="line">        app.adjType = <span class="string">"fixed"</span>;</div><div class="line">        app.adjSeq = mAdjSeq;</div><div class="line">        app.curRawAdj = app.maxAdj;</div><div class="line">        app.foregroundActivities = <span class="keyword">false</span>;</div><div class="line">        app.curSchedGroup = Process.THREAD_GROUP_DEFAULT;</div><div class="line">        app.curProcState = ActivityManager.PROCESS_STATE_PERSISTENT;</div><div class="line">        <span class="comment">// System processes can do UI, and when they do we want to have</span></div><div class="line">        <span class="comment">// them trim their memory after the user leaves the UI.  To</span></div><div class="line">        <span class="comment">// facilitate this, here we need to determine whether or not it</span></div><div class="line">        <span class="comment">// is currently showing UI.</span></div><div class="line">        app.systemNoUi = <span class="keyword">true</span>;</div><div class="line">        <span class="keyword">if</span> (app == TOP_APP) &#123;</div><div class="line">            app.systemNoUi = <span class="keyword">false</span>;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (activitiesSize &gt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; activitiesSize; j++) &#123;</div><div class="line">                <span class="keyword">final</span> ActivityRecord r = app.activities.get(j);</div><div class="line">                <span class="keyword">if</span> (r.visible) &#123;</div><div class="line">                    app.systemNoUi = <span class="keyword">false</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (!app.systemNoUi) &#123;</div><div class="line">            app.curProcState = ActivityManager.PROCESS_STATE_PERSISTENT_UI;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> (app.curAdj=app.maxAdj);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    app.systemNoUi = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> PROCESS_STATE_TOP = mTopProcessState;</div><div class="line"></div><div class="line">    <span class="comment">// Determine the importance of the process, starting with most</span></div><div class="line">    <span class="comment">// important to least, and assign an appropriate OOM adjustment.</span></div><div class="line">    <span class="keyword">int</span> adj;</div><div class="line">    <span class="keyword">int</span> schedGroup;</div><div class="line">    <span class="keyword">int</span> procState;</div><div class="line">    <span class="keyword">boolean</span> foregroundActivities = <span class="keyword">false</span>;</div><div class="line">    BroadcastQueue queue;</div><div class="line">    <span class="keyword">if</span> (app == TOP_APP) &#123;</div><div class="line">        <span class="comment">// The last app on the list is the foreground app.</span></div><div class="line">        adj = ProcessList.FOREGROUND_APP_ADJ;</div><div class="line">        schedGroup = Process.THREAD_GROUP_DEFAULT;</div><div class="line">        app.adjType = <span class="string">"top-activity"</span>;</div><div class="line">        foregroundActivities = <span class="keyword">true</span>;</div><div class="line">        procState = PROCESS_STATE_TOP;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (app.instrumentationClass != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// Don't want to kill running instrumentation.</span></div><div class="line">        adj = ProcessList.FOREGROUND_APP_ADJ;</div><div class="line">        schedGroup = Process.THREAD_GROUP_DEFAULT;</div><div class="line">        app.adjType = <span class="string">"instrumentation"</span>;</div><div class="line">        procState = ActivityManager.PROCESS_STATE_FOREGROUND_SERVICE;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((queue = isReceivingBroadcast(app)) != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// An app that is currently receiving a broadcast also</span></div><div class="line">        <span class="comment">// counts as being in the foreground for OOM killer purposes.</span></div><div class="line">        <span class="comment">// It's placed in a sched group based on the nature of the</span></div><div class="line">        <span class="comment">// broadcast as reflected by which queue it's active in.</span></div><div class="line">        adj = ProcessList.FOREGROUND_APP_ADJ;</div><div class="line">        schedGroup = (queue == mFgBroadcastQueue)</div><div class="line">                ? Process.THREAD_GROUP_DEFAULT : Process.THREAD_GROUP_BG_NONINTERACTIVE;</div><div class="line">        app.adjType = <span class="string">"broadcast"</span>;</div><div class="line">        procState = ActivityManager.PROCESS_STATE_RECEIVER;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (app.executingServices.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="comment">// An app that is currently executing a service callback also</span></div><div class="line">        <span class="comment">// counts as being in the foreground.</span></div><div class="line">        adj = ProcessList.FOREGROUND_APP_ADJ;</div><div class="line">        schedGroup = app.execServicesFg ?</div><div class="line">                Process.THREAD_GROUP_DEFAULT : Process.THREAD_GROUP_BG_NONINTERACTIVE;</div><div class="line">        app.adjType = <span class="string">"exec-service"</span>;</div><div class="line">        procState = ActivityManager.PROCESS_STATE_SERVICE;</div><div class="line">        <span class="comment">//Slog.i(TAG, "EXEC " + (app.execServicesFg ? "FG" : "BG") + ": " + app);</span></div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// As far as we know the process is empty.  We may change our mind later.</span></div><div class="line">        schedGroup = Process.THREAD_GROUP_BG_NONINTERACTIVE;</div><div class="line">        <span class="comment">// At this point we don't actually know the adjustment.  Use the cached adj</span></div><div class="line">        <span class="comment">// value that the caller wants us to.</span></div><div class="line">        adj = cachedAdj;</div><div class="line">        procState = ActivityManager.PROCESS_STATE_CACHED_EMPTY;</div><div class="line">        app.cached = <span class="keyword">true</span>;</div><div class="line">        app.empty = <span class="keyword">true</span>;</div><div class="line">        app.adjType = <span class="string">"cch-empty"</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Examine all activities if not already foreground.</span></div><div class="line">    <span class="keyword">if</span> (!foregroundActivities &amp;&amp; activitiesSize &gt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; activitiesSize; j++) &#123;</div><div class="line">            <span class="keyword">final</span> ActivityRecord r = app.activities.get(j);</div><div class="line">            <span class="keyword">if</span> (r.app != app) &#123;</div><div class="line">                Slog.w(TAG, <span class="string">"Wtf, activity "</span> + r + <span class="string">" in proc activity list not using proc "</span></div><div class="line">                        + app + <span class="string">"?!? Using "</span> + r.app + <span class="string">" instead."</span>);</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (r.visible) &#123;</div><div class="line">                <span class="comment">// App has a visible activity; only upgrade adjustment.</span></div><div class="line">                <span class="keyword">if</span> (adj &gt; ProcessList.VISIBLE_APP_ADJ) &#123;</div><div class="line">                    adj = ProcessList.VISIBLE_APP_ADJ;</div><div class="line">                    app.adjType = <span class="string">"visible"</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (procState &gt; PROCESS_STATE_TOP) &#123;</div><div class="line">                    procState = PROCESS_STATE_TOP;</div><div class="line">                &#125;</div><div class="line">                schedGroup = Process.THREAD_GROUP_DEFAULT;</div><div class="line">                app.cached = <span class="keyword">false</span>;</div><div class="line">                app.empty = <span class="keyword">false</span>;</div><div class="line">                foregroundActivities = <span class="keyword">true</span>;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r.state == ActivityState.PAUSING || r.state == ActivityState.PAUSED) &#123;</div><div class="line">                <span class="keyword">if</span> (adj &gt; ProcessList.PERCEPTIBLE_APP_ADJ) &#123;</div><div class="line">                    adj = ProcessList.PERCEPTIBLE_APP_ADJ;</div><div class="line">                    app.adjType = <span class="string">"pausing"</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (procState &gt; PROCESS_STATE_TOP) &#123;</div><div class="line">                    procState = PROCESS_STATE_TOP;</div><div class="line">                &#125;</div><div class="line">                schedGroup = Process.THREAD_GROUP_DEFAULT;</div><div class="line">                app.cached = <span class="keyword">false</span>;</div><div class="line">                app.empty = <span class="keyword">false</span>;</div><div class="line">                foregroundActivities = <span class="keyword">true</span>;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r.state == ActivityState.STOPPING) &#123;</div><div class="line">                <span class="keyword">if</span> (adj &gt; ProcessList.PERCEPTIBLE_APP_ADJ) &#123;</div><div class="line">                    adj = ProcessList.PERCEPTIBLE_APP_ADJ;</div><div class="line">                    app.adjType = <span class="string">"stopping"</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="comment">// For the process state, we will at this point consider the</span></div><div class="line">                <span class="comment">// process to be cached.  It will be cached either as an activity</span></div><div class="line">                <span class="comment">// or empty depending on whether the activity is finishing.  We do</span></div><div class="line">                <span class="comment">// this so that we can treat the process as cached for purposes of</span></div><div class="line">                <span class="comment">// memory trimming (determing current memory level, trim command to</span></div><div class="line">                <span class="comment">// send to process) since there can be an arbitrary number of stopping</span></div><div class="line">                <span class="comment">// processes and they should soon all go into the cached state.</span></div><div class="line">                <span class="keyword">if</span> (!r.finishing) &#123;</div><div class="line">                    <span class="keyword">if</span> (procState &gt; ActivityManager.PROCESS_STATE_LAST_ACTIVITY) &#123;</div><div class="line">                        procState = ActivityManager.PROCESS_STATE_LAST_ACTIVITY;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                app.cached = <span class="keyword">false</span>;</div><div class="line">                app.empty = <span class="keyword">false</span>;</div><div class="line">                foregroundActivities = <span class="keyword">true</span>;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">if</span> (procState &gt; ActivityManager.PROCESS_STATE_CACHED_ACTIVITY) &#123;</div><div class="line">                    procState = ActivityManager.PROCESS_STATE_CACHED_ACTIVITY;</div><div class="line">                    app.adjType = <span class="string">"cch-act"</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (adj &gt; ProcessList.PERCEPTIBLE_APP_ADJ) &#123;</div><div class="line">        <span class="keyword">if</span> (app.foregroundServices) &#123;</div><div class="line">            <span class="comment">// The user is aware of this app, so make it visible.</span></div><div class="line">            adj = ProcessList.PERCEPTIBLE_APP_ADJ;</div><div class="line">            procState = ActivityManager.PROCESS_STATE_FOREGROUND_SERVICE;</div><div class="line">            app.cached = <span class="keyword">false</span>;</div><div class="line">            app.adjType = <span class="string">"fg-service"</span>;</div><div class="line">            schedGroup = Process.THREAD_GROUP_DEFAULT;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (app.forcingToForeground != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">// The user is aware of this app, so make it visible.</span></div><div class="line">            adj = ProcessList.PERCEPTIBLE_APP_ADJ;</div><div class="line">            procState = ActivityManager.PROCESS_STATE_IMPORTANT_FOREGROUND;</div><div class="line">            app.cached = <span class="keyword">false</span>;</div><div class="line">            app.adjType = <span class="string">"force-fg"</span>;</div><div class="line">            app.adjSource = app.forcingToForeground;</div><div class="line">            schedGroup = Process.THREAD_GROUP_DEFAULT;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (app == mHeavyWeightProcess) &#123;</div><div class="line">        <span class="keyword">if</span> (adj &gt; ProcessList.HEAVY_WEIGHT_APP_ADJ) &#123;</div><div class="line">            <span class="comment">// We don't want to kill the current heavy-weight process.</span></div><div class="line">            adj = ProcessList.HEAVY_WEIGHT_APP_ADJ;</div><div class="line">            schedGroup = Process.THREAD_GROUP_BG_NONINTERACTIVE;</div><div class="line">            app.cached = <span class="keyword">false</span>;</div><div class="line">            app.adjType = <span class="string">"heavy"</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (procState &gt; ActivityManager.PROCESS_STATE_HEAVY_WEIGHT) &#123;</div><div class="line">            procState = ActivityManager.PROCESS_STATE_HEAVY_WEIGHT;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (app == mHomeProcess) &#123;</div><div class="line">        <span class="keyword">if</span> (adj &gt; ProcessList.HOME_APP_ADJ) &#123;</div><div class="line">            <span class="comment">// This process is hosting what we currently consider to be the</span></div><div class="line">            <span class="comment">// home app, so we don't want to let it go into the background.</span></div><div class="line">            adj = ProcessList.HOME_APP_ADJ;</div><div class="line">            schedGroup = Process.THREAD_GROUP_BG_NONINTERACTIVE;</div><div class="line">            app.cached = <span class="keyword">false</span>;</div><div class="line">            app.adjType = <span class="string">"home"</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (procState &gt; ActivityManager.PROCESS_STATE_HOME) &#123;</div><div class="line">            procState = ActivityManager.PROCESS_STATE_HOME;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (app == mPreviousProcess &amp;&amp; app.activities.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (adj &gt; ProcessList.PREVIOUS_APP_ADJ) &#123;</div><div class="line">            <span class="comment">// This was the previous process that showed UI to the user.</span></div><div class="line">            <span class="comment">// We want to try to keep it around more aggressively, to give</span></div><div class="line">            <span class="comment">// a good experience around switching between two apps.</span></div><div class="line">            adj = ProcessList.PREVIOUS_APP_ADJ;</div><div class="line">            schedGroup = Process.THREAD_GROUP_BG_NONINTERACTIVE;</div><div class="line">            app.cached = <span class="keyword">false</span>;</div><div class="line">            app.adjType = <span class="string">"previous"</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (procState &gt; ActivityManager.PROCESS_STATE_LAST_ACTIVITY) &#123;</div><div class="line">            procState = ActivityManager.PROCESS_STATE_LAST_ACTIVITY;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">false</span>) Slog.i(TAG, <span class="string">"OOM "</span> + app + <span class="string">": initial adj="</span> + adj</div><div class="line">            + <span class="string">" reason="</span> + app.adjType);</div><div class="line"></div><div class="line">    <span class="comment">// By default, we use the computed adjustment.  It may be changed if</span></div><div class="line">    <span class="comment">// there are applications dependent on our services or providers, but</span></div><div class="line">    <span class="comment">// this gives us a baseline and makes sure we don't get into an</span></div><div class="line">    <span class="comment">// infinite recursion.</span></div><div class="line">    app.adjSeq = mAdjSeq;</div><div class="line">    app.curRawAdj = adj;</div><div class="line">    app.hasStartedServices = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (mBackupTarget != <span class="keyword">null</span> &amp;&amp; app == mBackupTarget.app) &#123;</div><div class="line">        <span class="comment">// If possible we want to avoid killing apps while they're being backed up</span></div><div class="line">        <span class="keyword">if</span> (adj &gt; ProcessList.BACKUP_APP_ADJ) &#123;</div><div class="line">            <span class="keyword">if</span> (DEBUG_BACKUP) Slog.v(TAG_BACKUP, <span class="string">"oom BACKUP_APP_ADJ for "</span> + app);</div><div class="line">            adj = ProcessList.BACKUP_APP_ADJ;</div><div class="line">            <span class="keyword">if</span> (procState &gt; ActivityManager.PROCESS_STATE_IMPORTANT_BACKGROUND) &#123;</div><div class="line">                procState = ActivityManager.PROCESS_STATE_IMPORTANT_BACKGROUND;</div><div class="line">            &#125;</div><div class="line">            app.adjType = <span class="string">"backup"</span>;</div><div class="line">            app.cached = <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (procState &gt; ActivityManager.PROCESS_STATE_BACKUP) &#123;</div><div class="line">            procState = ActivityManager.PROCESS_STATE_BACKUP;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> mayBeTop = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> is = app.services.size()-<span class="number">1</span>;</div><div class="line">            is &gt;= <span class="number">0</span> &amp;&amp; (adj &gt; ProcessList.FOREGROUND_APP_ADJ</div><div class="line">                    || schedGroup == Process.THREAD_GROUP_BG_NONINTERACTIVE</div><div class="line">                    || procState &gt; ActivityManager.PROCESS_STATE_TOP);</div><div class="line">            is--) &#123;</div><div class="line">        ServiceRecord s = app.services.valueAt(is);</div><div class="line">        <span class="keyword">if</span> (s.startRequested) &#123;</div><div class="line">            app.hasStartedServices = <span class="keyword">true</span>;</div><div class="line">            <span class="keyword">if</span> (procState &gt; ActivityManager.PROCESS_STATE_SERVICE) &#123;</div><div class="line">                procState = ActivityManager.PROCESS_STATE_SERVICE;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (app.hasShownUi &amp;&amp; app != mHomeProcess) &#123;</div><div class="line">                <span class="comment">// If this process has shown some UI, let it immediately</span></div><div class="line">                <span class="comment">// go to the LRU list because it may be pretty heavy with</span></div><div class="line">                <span class="comment">// UI stuff.  We'll tag it with a label just to help</span></div><div class="line">                <span class="comment">// debug and understand what is going on.</span></div><div class="line">                <span class="keyword">if</span> (adj &gt; ProcessList.SERVICE_ADJ) &#123;</div><div class="line">                    app.adjType = <span class="string">"cch-started-ui-services"</span>;</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">if</span> (now &lt; (s.lastActivity + ActiveServices.MAX_SERVICE_INACTIVITY)) &#123;</div><div class="line">                    <span class="comment">// This service has seen some activity within</span></div><div class="line">                    <span class="comment">// recent memory, so we will keep its process ahead</span></div><div class="line">                    <span class="comment">// of the background processes.</span></div><div class="line">                    <span class="keyword">if</span> (adj &gt; ProcessList.SERVICE_ADJ) &#123;</div><div class="line">                        adj = ProcessList.SERVICE_ADJ;</div><div class="line">                        app.adjType = <span class="string">"started-services"</span>;</div><div class="line">                        app.cached = <span class="keyword">false</span>;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                <span class="comment">// If we have let the service slide into the background</span></div><div class="line">                <span class="comment">// state, still have some text describing what it is doing</span></div><div class="line">                <span class="comment">// even though the service no longer has an impact.</span></div><div class="line">                <span class="keyword">if</span> (adj &gt; ProcessList.SERVICE_ADJ) &#123;</div><div class="line">                    app.adjType = <span class="string">"cch-started-services"</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> conni = s.connections.size()-<span class="number">1</span>;</div><div class="line">                conni &gt;= <span class="number">0</span> &amp;&amp; (adj &gt; ProcessList.FOREGROUND_APP_ADJ</div><div class="line">                        || schedGroup == Process.THREAD_GROUP_BG_NONINTERACTIVE</div><div class="line">                        || procState &gt; ActivityManager.PROCESS_STATE_TOP);</div><div class="line">                conni--) &#123;</div><div class="line">            ArrayList&lt;ConnectionRecord&gt; clist = s.connections.valueAt(conni);</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">                    i &lt; clist.size() &amp;&amp; (adj &gt; ProcessList.FOREGROUND_APP_ADJ</div><div class="line">                            || schedGroup == Process.THREAD_GROUP_BG_NONINTERACTIVE</div><div class="line">                            || procState &gt; ActivityManager.PROCESS_STATE_TOP);</div><div class="line">                    i++) &#123;</div><div class="line">                <span class="comment">// XXX should compute this based on the max of</span></div><div class="line">                <span class="comment">// all connected clients.</span></div><div class="line">                ConnectionRecord cr = clist.get(i);</div><div class="line">                <span class="keyword">if</span> (cr.binding.client == app) &#123;</div><div class="line">                    <span class="comment">// Binding to ourself is not interesting.</span></div><div class="line">                    <span class="keyword">continue</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> ((cr.flags&amp;Context.BIND_WAIVE_PRIORITY) == <span class="number">0</span>) &#123;</div><div class="line">                    ProcessRecord client = cr.binding.client;</div><div class="line">                    <span class="keyword">int</span> clientAdj = computeOomAdjLocked(client, cachedAdj,</div><div class="line">                            TOP_APP, doingAll, now);</div><div class="line">                    <span class="keyword">int</span> clientProcState = client.curProcState;</div><div class="line">                    <span class="keyword">if</span> (clientProcState &gt;= ActivityManager.PROCESS_STATE_CACHED_ACTIVITY) &#123;</div><div class="line">                        <span class="comment">// If the other app is cached for any reason, for purposes here</span></div><div class="line">                        <span class="comment">// we are going to consider it empty.  The specific cached state</span></div><div class="line">                        <span class="comment">// doesn't propagate except under certain conditions.</span></div><div class="line">                        clientProcState = ActivityManager.PROCESS_STATE_CACHED_EMPTY;</div><div class="line">                    &#125;</div><div class="line">                    String adjType = <span class="keyword">null</span>;</div><div class="line">                    <span class="keyword">if</span> ((cr.flags&amp;Context.BIND_ALLOW_OOM_MANAGEMENT) != <span class="number">0</span>) &#123;</div><div class="line">                        <span class="comment">// Not doing bind OOM management, so treat</span></div><div class="line">                        <span class="comment">// this guy more like a started service.</span></div><div class="line">                        <span class="keyword">if</span> (app.hasShownUi &amp;&amp; app != mHomeProcess) &#123;</div><div class="line">                            <span class="comment">// If this process has shown some UI, let it immediately</span></div><div class="line">                            <span class="comment">// go to the LRU list because it may be pretty heavy with</span></div><div class="line">                            <span class="comment">// UI stuff.  We'll tag it with a label just to help</span></div><div class="line">                            <span class="comment">// debug and understand what is going on.</span></div><div class="line">                            <span class="keyword">if</span> (adj &gt; clientAdj) &#123;</div><div class="line">                                adjType = <span class="string">"cch-bound-ui-services"</span>;</div><div class="line">                            &#125;</div><div class="line">                            app.cached = <span class="keyword">false</span>;</div><div class="line">                            clientAdj = adj;</div><div class="line">                            clientProcState = procState;</div><div class="line">                        &#125; <span class="keyword">else</span> &#123;</div><div class="line">                            <span class="keyword">if</span> (now &gt;= (s.lastActivity</div><div class="line">                                    + ActiveServices.MAX_SERVICE_INACTIVITY)) &#123;</div><div class="line">                                <span class="comment">// This service has not seen activity within</span></div><div class="line">                                <span class="comment">// recent memory, so allow it to drop to the</span></div><div class="line">                                <span class="comment">// LRU list if there is no other reason to keep</span></div><div class="line">                                <span class="comment">// it around.  We'll also tag it with a label just</span></div><div class="line">                                <span class="comment">// to help debug and undertand what is going on.</span></div><div class="line">                                <span class="keyword">if</span> (adj &gt; clientAdj) &#123;</div><div class="line">                                    adjType = <span class="string">"cch-bound-services"</span>;</div><div class="line">                                &#125;</div><div class="line">                                clientAdj = adj;</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">if</span> (adj &gt; clientAdj) &#123;</div><div class="line">                        <span class="comment">// If this process has recently shown UI, and</span></div><div class="line">                        <span class="comment">// the process that is binding to it is less</span></div><div class="line">                        <span class="comment">// important than being visible, then we don't</span></div><div class="line">                        <span class="comment">// care about the binding as much as we care</span></div><div class="line">                        <span class="comment">// about letting this process get into the LRU</span></div><div class="line">                        <span class="comment">// list to be killed and restarted if needed for</span></div><div class="line">                        <span class="comment">// memory.</span></div><div class="line">                        <span class="keyword">if</span> (app.hasShownUi &amp;&amp; app != mHomeProcess</div><div class="line">                                &amp;&amp; clientAdj &gt; ProcessList.PERCEPTIBLE_APP_ADJ) &#123;</div><div class="line">                            adjType = <span class="string">"cch-bound-ui-services"</span>;</div><div class="line">                        &#125; <span class="keyword">else</span> &#123;</div><div class="line">                            <span class="keyword">if</span> ((cr.flags&amp;(Context.BIND_ABOVE_CLIENT</div><div class="line">                                    |Context.BIND_IMPORTANT)) != <span class="number">0</span>) &#123;</div><div class="line">                                adj = clientAdj &gt;= ProcessList.PERSISTENT_SERVICE_ADJ</div><div class="line">                                        ? clientAdj : ProcessList.PERSISTENT_SERVICE_ADJ;</div><div class="line">                            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((cr.flags&amp;Context.BIND_NOT_VISIBLE) != <span class="number">0</span></div><div class="line">                                    &amp;&amp; clientAdj &lt; ProcessList.PERCEPTIBLE_APP_ADJ</div><div class="line">                                    &amp;&amp; adj &gt; ProcessList.PERCEPTIBLE_APP_ADJ) &#123;</div><div class="line">                                adj = ProcessList.PERCEPTIBLE_APP_ADJ;</div><div class="line">                            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (clientAdj &gt; ProcessList.VISIBLE_APP_ADJ) &#123;</div><div class="line">                                adj = clientAdj;</div><div class="line">                            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                                <span class="keyword">if</span> (adj &gt; ProcessList.VISIBLE_APP_ADJ) &#123;</div><div class="line">                                    adj = ProcessList.VISIBLE_APP_ADJ;</div><div class="line">                                &#125;</div><div class="line">                            &#125;</div><div class="line">                            <span class="keyword">if</span> (!client.cached) &#123;</div><div class="line">                                app.cached = <span class="keyword">false</span>;</div><div class="line">                            &#125;</div><div class="line">                            adjType = <span class="string">"service"</span>;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">if</span> ((cr.flags&amp;Context.BIND_NOT_FOREGROUND) == <span class="number">0</span>) &#123;</div><div class="line">                        <span class="keyword">if</span> (client.curSchedGroup == Process.THREAD_GROUP_DEFAULT) &#123;</div><div class="line">                            schedGroup = Process.THREAD_GROUP_DEFAULT;</div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">if</span> (clientProcState &lt;= ActivityManager.PROCESS_STATE_TOP) &#123;</div><div class="line">                            <span class="keyword">if</span> (clientProcState == ActivityManager.PROCESS_STATE_TOP) &#123;</div><div class="line">                                <span class="comment">// Special handling of clients who are in the top state.</span></div><div class="line">                                <span class="comment">// We *may* want to consider this process to be in the</span></div><div class="line">                                <span class="comment">// top state as well, but only if there is not another</span></div><div class="line">                                <span class="comment">// reason for it to be running.  Being on the top is a</span></div><div class="line">                                <span class="comment">// special state, meaning you are specifically running</span></div><div class="line">                                <span class="comment">// for the current top app.  If the process is already</span></div><div class="line">                                <span class="comment">// running in the background for some other reason, it</span></div><div class="line">                                <span class="comment">// is more important to continue considering it to be</span></div><div class="line">                                <span class="comment">// in the background state.</span></div><div class="line">                                mayBeTop = <span class="keyword">true</span>;</div><div class="line">                                clientProcState = ActivityManager.PROCESS_STATE_CACHED_EMPTY;</div><div class="line">                            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                                <span class="comment">// Special handling for above-top states (persistent</span></div><div class="line">                                <span class="comment">// processes).  These should not bring the current process</span></div><div class="line">                                <span class="comment">// into the top state, since they are not on top.  Instead</span></div><div class="line">                                <span class="comment">// give them the best state after that.</span></div><div class="line">                                <span class="keyword">if</span> ((cr.flags&amp;Context.BIND_FOREGROUND_SERVICE) != <span class="number">0</span>) &#123;</div><div class="line">                                    clientProcState =</div><div class="line">                                            ActivityManager.PROCESS_STATE_BOUND_FOREGROUND_SERVICE;</div><div class="line">                                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mWakefulness</div><div class="line">                                                == PowerManagerInternal.WAKEFULNESS_AWAKE &amp;&amp;</div><div class="line">                                        (cr.flags&amp;Context.BIND_FOREGROUND_SERVICE_WHILE_AWAKE)</div><div class="line">                                                != <span class="number">0</span>) &#123;</div><div class="line">                                    clientProcState =</div><div class="line">                                            ActivityManager.PROCESS_STATE_BOUND_FOREGROUND_SERVICE;</div><div class="line">                                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                                    clientProcState =</div><div class="line">                                            ActivityManager.PROCESS_STATE_IMPORTANT_FOREGROUND;</div><div class="line">                                &#125;</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        <span class="keyword">if</span> (clientProcState &lt;</div><div class="line">                                ActivityManager.PROCESS_STATE_IMPORTANT_BACKGROUND) &#123;</div><div class="line">                            clientProcState =</div><div class="line">                                    ActivityManager.PROCESS_STATE_IMPORTANT_BACKGROUND;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">if</span> (procState &gt; clientProcState) &#123;</div><div class="line">                        procState = clientProcState;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">if</span> (procState &lt; ActivityManager.PROCESS_STATE_IMPORTANT_BACKGROUND</div><div class="line">                            &amp;&amp; (cr.flags&amp;Context.BIND_SHOWING_UI) != <span class="number">0</span>) &#123;</div><div class="line">                        app.pendingUiClean = <span class="keyword">true</span>;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">if</span> (adjType != <span class="keyword">null</span>) &#123;</div><div class="line">                        app.adjType = adjType;</div><div class="line">                        app.adjTypeCode = ActivityManager.RunningAppProcessInfo</div><div class="line">                                .REASON_SERVICE_IN_USE;</div><div class="line">                        app.adjSource = cr.binding.client;</div><div class="line">                        app.adjSourceProcState = clientProcState;</div><div class="line">                        app.adjTarget = s.name;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> ((cr.flags&amp;Context.BIND_TREAT_LIKE_ACTIVITY) != <span class="number">0</span>) &#123;</div><div class="line">                    app.treatLikeActivity = <span class="keyword">true</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">final</span> ActivityRecord a = cr.activity;</div><div class="line">                <span class="keyword">if</span> ((cr.flags&amp;Context.BIND_ADJUST_WITH_ACTIVITY) != <span class="number">0</span>) &#123;</div><div class="line">                    <span class="keyword">if</span> (a != <span class="keyword">null</span> &amp;&amp; adj &gt; ProcessList.FOREGROUND_APP_ADJ &amp;&amp;</div><div class="line">                            (a.visible || a.state == ActivityState.RESUMED</div><div class="line">                             || a.state == ActivityState.PAUSING)) &#123;</div><div class="line">                        adj = ProcessList.FOREGROUND_APP_ADJ;</div><div class="line">                        <span class="keyword">if</span> ((cr.flags&amp;Context.BIND_NOT_FOREGROUND) == <span class="number">0</span>) &#123;</div><div class="line">                            schedGroup = Process.THREAD_GROUP_DEFAULT;</div><div class="line">                        &#125;</div><div class="line">                        app.cached = <span class="keyword">false</span>;</div><div class="line">                        app.adjType = <span class="string">"service"</span>;</div><div class="line">                        app.adjTypeCode = ActivityManager.RunningAppProcessInfo</div><div class="line">                                .REASON_SERVICE_IN_USE;</div><div class="line">                        app.adjSource = a;</div><div class="line">                        app.adjSourceProcState = procState;</div><div class="line">                        app.adjTarget = s.name;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> provi = app.pubProviders.size()-<span class="number">1</span>;</div><div class="line">            provi &gt;= <span class="number">0</span> &amp;&amp; (adj &gt; ProcessList.FOREGROUND_APP_ADJ</div><div class="line">                    || schedGroup == Process.THREAD_GROUP_BG_NONINTERACTIVE</div><div class="line">                    || procState &gt; ActivityManager.PROCESS_STATE_TOP);</div><div class="line">            provi--) &#123;</div><div class="line">        ContentProviderRecord cpr = app.pubProviders.valueAt(provi);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = cpr.connections.size()-<span class="number">1</span>;</div><div class="line">                i &gt;= <span class="number">0</span> &amp;&amp; (adj &gt; ProcessList.FOREGROUND_APP_ADJ</div><div class="line">                        || schedGroup == Process.THREAD_GROUP_BG_NONINTERACTIVE</div><div class="line">                        || procState &gt; ActivityManager.PROCESS_STATE_TOP);</div><div class="line">                i--) &#123;</div><div class="line">            ContentProviderConnection conn = cpr.connections.get(i);</div><div class="line">            ProcessRecord client = conn.client;</div><div class="line">            <span class="keyword">if</span> (client == app) &#123;</div><div class="line">                <span class="comment">// Being our own client is not interesting.</span></div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">int</span> clientAdj = computeOomAdjLocked(client, cachedAdj, TOP_APP, doingAll, now);</div><div class="line">            <span class="keyword">int</span> clientProcState = client.curProcState;</div><div class="line">            <span class="keyword">if</span> (clientProcState &gt;= ActivityManager.PROCESS_STATE_CACHED_ACTIVITY) &#123;</div><div class="line">                <span class="comment">// If the other app is cached for any reason, for purposes here</span></div><div class="line">                <span class="comment">// we are going to consider it empty.</span></div><div class="line">                clientProcState = ActivityManager.PROCESS_STATE_CACHED_EMPTY;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (adj &gt; clientAdj) &#123;</div><div class="line">                <span class="keyword">if</span> (app.hasShownUi &amp;&amp; app != mHomeProcess</div><div class="line">                        &amp;&amp; clientAdj &gt; ProcessList.PERCEPTIBLE_APP_ADJ) &#123;</div><div class="line">                    app.adjType = <span class="string">"cch-ui-provider"</span>;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    adj = clientAdj &gt; ProcessList.FOREGROUND_APP_ADJ</div><div class="line">                            ? clientAdj : ProcessList.FOREGROUND_APP_ADJ;</div><div class="line">                    app.adjType = <span class="string">"provider"</span>;</div><div class="line">                &#125;</div><div class="line">                app.cached &amp;= client.cached;</div><div class="line">                app.adjTypeCode = ActivityManager.RunningAppProcessInfo</div><div class="line">                        .REASON_PROVIDER_IN_USE;</div><div class="line">                app.adjSource = client;</div><div class="line">                app.adjSourceProcState = clientProcState;</div><div class="line">                app.adjTarget = cpr.name;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (clientProcState &lt;= ActivityManager.PROCESS_STATE_TOP) &#123;</div><div class="line">                <span class="keyword">if</span> (clientProcState == ActivityManager.PROCESS_STATE_TOP) &#123;</div><div class="line">                    <span class="comment">// Special handling of clients who are in the top state.</span></div><div class="line">                    <span class="comment">// We *may* want to consider this process to be in the</span></div><div class="line">                    <span class="comment">// top state as well, but only if there is not another</span></div><div class="line">                    <span class="comment">// reason for it to be running.  Being on the top is a</span></div><div class="line">                    <span class="comment">// special state, meaning you are specifically running</span></div><div class="line">                    <span class="comment">// for the current top app.  If the process is already</span></div><div class="line">                    <span class="comment">// running in the background for some other reason, it</span></div><div class="line">                    <span class="comment">// is more important to continue considering it to be</span></div><div class="line">                    <span class="comment">// in the background state.</span></div><div class="line">                    mayBeTop = <span class="keyword">true</span>;</div><div class="line">                    clientProcState = ActivityManager.PROCESS_STATE_CACHED_EMPTY;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="comment">// Special handling for above-top states (persistent</span></div><div class="line">                    <span class="comment">// processes).  These should not bring the current process</span></div><div class="line">                    <span class="comment">// into the top state, since they are not on top.  Instead</span></div><div class="line">                    <span class="comment">// give them the best state after that.</span></div><div class="line">                    clientProcState =</div><div class="line">                            ActivityManager.PROCESS_STATE_BOUND_FOREGROUND_SERVICE;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (procState &gt; clientProcState) &#123;</div><div class="line">                procState = clientProcState;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (client.curSchedGroup == Process.THREAD_GROUP_DEFAULT) &#123;</div><div class="line">                schedGroup = Process.THREAD_GROUP_DEFAULT;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// If the provider has external (non-framework) process</span></div><div class="line">        <span class="comment">// dependencies, ensure that its adjustment is at least</span></div><div class="line">        <span class="comment">// FOREGROUND_APP_ADJ.</span></div><div class="line">        <span class="keyword">if</span> (cpr.hasExternalProcessHandles()) &#123;</div><div class="line">            <span class="keyword">if</span> (adj &gt; ProcessList.FOREGROUND_APP_ADJ) &#123;</div><div class="line">                adj = ProcessList.FOREGROUND_APP_ADJ;</div><div class="line">                schedGroup = Process.THREAD_GROUP_DEFAULT;</div><div class="line">                app.cached = <span class="keyword">false</span>;</div><div class="line">                app.adjType = <span class="string">"provider"</span>;</div><div class="line">                app.adjTarget = cpr.name;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (procState &gt; ActivityManager.PROCESS_STATE_IMPORTANT_FOREGROUND) &#123;</div><div class="line">                procState = ActivityManager.PROCESS_STATE_IMPORTANT_FOREGROUND;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (mayBeTop &amp;&amp; procState &gt; ActivityManager.PROCESS_STATE_TOP) &#123;</div><div class="line">        <span class="comment">// A client of one of our services or providers is in the top state.  We</span></div><div class="line">        <span class="comment">// *may* want to be in the top state, but not if we are already running in</span></div><div class="line">        <span class="comment">// the background for some other reason.  For the decision here, we are going</span></div><div class="line">        <span class="comment">// to pick out a few specific states that we want to remain in when a client</span></div><div class="line">        <span class="comment">// is top (states that tend to be longer-term) and otherwise allow it to go</span></div><div class="line">        <span class="comment">// to the top state.</span></div><div class="line">        <span class="keyword">switch</span> (procState) &#123;</div><div class="line">            <span class="keyword">case</span> ActivityManager.PROCESS_STATE_IMPORTANT_FOREGROUND:</div><div class="line">            <span class="keyword">case</span> ActivityManager.PROCESS_STATE_IMPORTANT_BACKGROUND:</div><div class="line">            <span class="keyword">case</span> ActivityManager.PROCESS_STATE_SERVICE:</div><div class="line">                <span class="comment">// These all are longer-term states, so pull them up to the top</span></div><div class="line">                <span class="comment">// of the background states, but not all the way to the top state.</span></div><div class="line">                procState = ActivityManager.PROCESS_STATE_BOUND_FOREGROUND_SERVICE;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">default</span>:</div><div class="line">                <span class="comment">// Otherwise, top is a better choice, so take it.</span></div><div class="line">                procState = ActivityManager.PROCESS_STATE_TOP;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (procState &gt;= ActivityManager.PROCESS_STATE_CACHED_EMPTY) &#123;</div><div class="line">        <span class="keyword">if</span> (app.hasClientActivities) &#123;</div><div class="line">            <span class="comment">// This is a cached process, but with client activities.  Mark it so.</span></div><div class="line">            procState = ActivityManager.PROCESS_STATE_CACHED_ACTIVITY_CLIENT;</div><div class="line">            app.adjType = <span class="string">"cch-client-act"</span>;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (app.treatLikeActivity) &#123;</div><div class="line">            <span class="comment">// This is a cached process, but somebody wants us to treat it like it has</span></div><div class="line">            <span class="comment">// an activity, okay!</span></div><div class="line">            procState = ActivityManager.PROCESS_STATE_CACHED_ACTIVITY;</div><div class="line">            app.adjType = <span class="string">"cch-as-act"</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (adj == ProcessList.SERVICE_ADJ) &#123;</div><div class="line">        <span class="keyword">if</span> (doingAll) &#123;</div><div class="line">            app.serviceb = mNewNumAServiceProcs &gt; (mNumServiceProcs/<span class="number">3</span>);</div><div class="line">            mNewNumServiceProcs++;</div><div class="line">            <span class="comment">//Slog.i(TAG, "ADJ " + app + " serviceb=" + app.serviceb);</span></div><div class="line">            <span class="keyword">if</span> (!app.serviceb) &#123;</div><div class="line">                <span class="comment">// This service isn't far enough down on the LRU list to</span></div><div class="line">                <span class="comment">// normally be a B service, but if we are low on RAM and it</span></div><div class="line">                <span class="comment">// is large we want to force it down since we would prefer to</span></div><div class="line">                <span class="comment">// keep launcher over it.</span></div><div class="line">                <span class="keyword">if</span> (mLastMemoryLevel &gt; ProcessStats.ADJ_MEM_FACTOR_NORMAL</div><div class="line">                        &amp;&amp; app.lastPss &gt;= mProcessList.getCachedRestoreThresholdKb()) &#123;</div><div class="line">                    app.serviceHighRam = <span class="keyword">true</span>;</div><div class="line">                    app.serviceb = <span class="keyword">true</span>;</div><div class="line">                    <span class="comment">//Slog.i(TAG, "ADJ " + app + " high ram!");</span></div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    mNewNumAServiceProcs++;</div><div class="line">                    <span class="comment">//Slog.i(TAG, "ADJ " + app + " not high ram!");</span></div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                app.serviceHighRam = <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (app.serviceb) &#123;</div><div class="line">            adj = ProcessList.SERVICE_B_ADJ;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    app.curRawAdj = adj;</div><div class="line"></div><div class="line">    <span class="comment">//Slog.i(TAG, "OOM ADJ " + app + ": pid=" + app.pid +</span></div><div class="line">    <span class="comment">//      " adj=" + adj + " curAdj=" + app.curAdj + " maxAdj=" + app.maxAdj);</span></div><div class="line">    <span class="keyword">if</span> (adj &gt; app.maxAdj) &#123;</div><div class="line">        adj = app.maxAdj;</div><div class="line">        <span class="keyword">if</span> (app.maxAdj &lt;= ProcessList.PERCEPTIBLE_APP_ADJ) &#123;</div><div class="line">            schedGroup = Process.THREAD_GROUP_DEFAULT;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Do final modification to adj.  Everything we do between here and applying</span></div><div class="line">    <span class="comment">// the final setAdj must be done in this function, because we will also use</span></div><div class="line">    <span class="comment">// it when computing the final cached adj later.  Note that we don't need to</span></div><div class="line">    <span class="comment">// worry about this for max adj above, since max adj will always be used to</span></div><div class="line">    <span class="comment">// keep it out of the cached vaues.</span></div><div class="line">    app.curAdj = app.modifyRawOomAdj(adj);</div><div class="line">    app.curSchedGroup = schedGroup;</div><div class="line">    app.curProcState = procState;</div><div class="line">    app.foregroundActivities = foregroundActivities;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> app.curRawAdj;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>吐槽一下，这个方法有600多行，只能分成以下几个部分来分析了:</p>
<p>1)如果当前service所在进程的oom_adj值已经被计算过了，那就无需再次计算，直接使用当前的值即可;</p>
<p>2)如果app.thread==null,表明这个进程在缓存中，那么返回ProcessList.CACHED_APP_MAX_ADJ值即可,而这个值的优先级并不高，因为这个数值为15;</p>
<p>3)如果app.maxAdj值小于等于ProcessList.FOREGROUND_APP_ADJ(数值为0),表明最大的调整都不允许Service进程达到ProcessList.FOREGROUND_APP_ADJ,那么就不值得为这个客户端进程工作，所以此时要进行调整，以使app.maxAdj的值能够达到ProcessList.FOREGROUND_APP_ADJ值;</p>
<p>4)根据service进程的情况来为其设置oom_adj值，分别考虑前台app进程，运行instrumentation的进程，正在接收广播的进程，正在执行service callback的进程以及空进程这5种情况。</p>
<p>5)如果不是前台进程，并且service所在进程的Activity数量大于0，就需要依次检查所有activity以更新ProcessRecord和foregroundActivities的状态;</p>
<p>6)如果adj值比ProcessList.PERCEPTIBLE_APP_ADJ(值为2)还大，则要对结果进行调整，如果是ProcessRecord是前台service进程，或者forcingToForeground不为null,则会将adj值调整到ProcessList.PERCEPTIBLE_APP_ADJ值;</p>
<p>7)如果service所在进程对应的ProcessRecord正在执行重量级任务，如果adj&gt;ProcessList.HEAVY_WEIGHT_APP_ADJ值，那么会调整到ProcessList.HEAVY_WEIGHT_APP_ADJ值，这显然是一种均衡策略，不让某个太繁重的任务影响到其他进程的流畅运行;</p>
<p>8)如果服务进程就是mHomeProcess,那么也会依据adj值进行调整;</p>
<p>9)如果服务进程是前一个进程，并且它有activity的话，那么会调整到ProcessList.PREVIOUS_APP_ADJ值;</p>
<p>10)下面根据ProcessRecord中所有ServiceRecord的状态来更新adj和ProcessRecord的值，分以下情况:</p>
<ul>
<li>如果Service是显式启动的,并且进程还拥有activity,则将其adj值设置为ProcessList.SERVICE_ADJ;</li>
<li>之后遍历每个ServiceRecord中包含的ConnectionRecord,根据ConnectionRecord的值进行adj和ProcessRecord的状态更新，此时会涉及到client端的oom_adj值;</li>
</ul>
<p>11)最后根据ProcessRecord中所有ContentProviderRecord的状态，逐个分析每个ContentProviderRecord的状态，根据其状态进行adj值和ProcessRecord状态的调整;</p>
<p>12)最后将计算的adj值存放到ProcessRecord中的curRawAdj值中。并且调用ProcessRecord的modifyRawOomAdj()方法来对计算得到的原始adj值进行可能的调整，最后将结果赋值结ProcessRecord的curAdj值中。</p>
<p>###AMS.updateOomAdjLocked()</p>
<p>updateOomAdjLocked()方法如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">updateOomAdjLocked</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">final</span> ActivityRecord TOP_ACT = resumedAppLocked();</div><div class="line">       <span class="keyword">final</span> ProcessRecord TOP_APP = TOP_ACT != <span class="keyword">null</span> ? TOP_ACT.app : <span class="keyword">null</span>;</div><div class="line">       <span class="keyword">final</span> <span class="keyword">long</span> now = SystemClock.uptimeMillis();</div><div class="line">       <span class="keyword">final</span> <span class="keyword">long</span> nowElapsed = SystemClock.elapsedRealtime();</div><div class="line">       <span class="keyword">final</span> <span class="keyword">long</span> oldTime = now - ProcessList.MAX_EMPTY_TIME;</div><div class="line">       <span class="keyword">final</span> <span class="keyword">int</span> N = mLruProcesses.size();</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</div><div class="line">           RuntimeException e = <span class="keyword">new</span> RuntimeException();</div><div class="line">           e.fillInStackTrace();</div><div class="line">           Slog.i(TAG, <span class="string">"updateOomAdj: top="</span> + TOP_ACT, e);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">// Reset state in all uid records.</span></div><div class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i=mActiveUids.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</div><div class="line">           <span class="keyword">final</span> UidRecord uidRec = mActiveUids.valueAt(i);</div><div class="line">           <span class="keyword">if</span> (<span class="keyword">false</span> &amp;&amp; DEBUG_UID_OBSERVERS) Slog.i(TAG_UID_OBSERVERS,</div><div class="line">                   <span class="string">"Starting update of "</span> + uidRec);</div><div class="line">           uidRec.reset();</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       mAdjSeq++;</div><div class="line">       mNewNumServiceProcs = <span class="number">0</span>;</div><div class="line">       mNewNumAServiceProcs = <span class="number">0</span>;</div><div class="line"></div><div class="line">       <span class="keyword">final</span> <span class="keyword">int</span> emptyProcessLimit;</div><div class="line">       <span class="keyword">final</span> <span class="keyword">int</span> cachedProcessLimit;</div><div class="line">       <span class="keyword">if</span> (mProcessLimit &lt;= <span class="number">0</span>) &#123;</div><div class="line">           emptyProcessLimit = cachedProcessLimit = <span class="number">0</span>;</div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mProcessLimit == <span class="number">1</span>) &#123;</div><div class="line">           emptyProcessLimit = <span class="number">1</span>;</div><div class="line">           cachedProcessLimit = <span class="number">0</span>;</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           emptyProcessLimit = ProcessList.computeEmptyProcessLimit(mProcessLimit);</div><div class="line">           cachedProcessLimit = mProcessLimit - emptyProcessLimit;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">// Let's determine how many processes we have running vs.</span></div><div class="line">       <span class="comment">// how many slots we have for background processes; we may want</span></div><div class="line">       <span class="comment">// to put multiple processes in a slot of there are enough of</span></div><div class="line">       <span class="comment">// them.</span></div><div class="line">       <span class="keyword">int</span> numSlots = (ProcessList.CACHED_APP_MAX_ADJ</div><div class="line">               - ProcessList.CACHED_APP_MIN_ADJ + <span class="number">1</span>) / <span class="number">2</span>;</div><div class="line">       <span class="keyword">int</span> numEmptyProcs = N - mNumNonCachedProcs - mNumCachedHiddenProcs;</div><div class="line">       <span class="keyword">if</span> (numEmptyProcs &gt; cachedProcessLimit) &#123;</div><div class="line">           <span class="comment">// If there are more empty processes than our limit on cached</span></div><div class="line">           <span class="comment">// processes, then use the cached process limit for the factor.</span></div><div class="line">           <span class="comment">// This ensures that the really old empty processes get pushed</span></div><div class="line">           <span class="comment">// down to the bottom, so if we are running low on memory we will</span></div><div class="line">           <span class="comment">// have a better chance at keeping around more cached processes</span></div><div class="line">           <span class="comment">// instead of a gazillion empty processes.</span></div><div class="line">           numEmptyProcs = cachedProcessLimit;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">int</span> emptyFactor = numEmptyProcs/numSlots;</div><div class="line">       <span class="keyword">if</span> (emptyFactor &lt; <span class="number">1</span>) emptyFactor = <span class="number">1</span>;</div><div class="line">       <span class="keyword">int</span> cachedFactor = (mNumCachedHiddenProcs &gt; <span class="number">0</span> ? mNumCachedHiddenProcs : <span class="number">1</span>)/numSlots;</div><div class="line">       <span class="keyword">if</span> (cachedFactor &lt; <span class="number">1</span>) cachedFactor = <span class="number">1</span>;</div><div class="line">       <span class="keyword">int</span> stepCached = <span class="number">0</span>;</div><div class="line">       <span class="keyword">int</span> stepEmpty = <span class="number">0</span>;</div><div class="line">       <span class="keyword">int</span> numCached = <span class="number">0</span>;</div><div class="line">       <span class="keyword">int</span> numEmpty = <span class="number">0</span>;</div><div class="line">       <span class="keyword">int</span> numTrimming = <span class="number">0</span>;</div><div class="line"></div><div class="line">       mNumNonCachedProcs = <span class="number">0</span>;</div><div class="line">       mNumCachedHiddenProcs = <span class="number">0</span>;</div><div class="line"></div><div class="line">       <span class="comment">// First update the OOM adjustment for each of the</span></div><div class="line">       <span class="comment">// application processes based on their current state.</span></div><div class="line">       <span class="keyword">int</span> curCachedAdj = ProcessList.CACHED_APP_MIN_ADJ;</div><div class="line">       <span class="keyword">int</span> nextCachedAdj = curCachedAdj+<span class="number">1</span>;</div><div class="line">       <span class="keyword">int</span> curEmptyAdj = ProcessList.CACHED_APP_MIN_ADJ;</div><div class="line">       <span class="keyword">int</span> nextEmptyAdj = curEmptyAdj+<span class="number">2</span>;</div><div class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i=N-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</div><div class="line">           ProcessRecord app = mLruProcesses.get(i);</div><div class="line">           <span class="keyword">if</span> (!app.killedByAm &amp;&amp; app.thread != <span class="keyword">null</span>) &#123;</div><div class="line">               app.procStateChanged = <span class="keyword">false</span>;</div><div class="line">               computeOomAdjLocked(app, ProcessList.UNKNOWN_ADJ, TOP_APP, <span class="keyword">true</span>, now);</div><div class="line"></div><div class="line">               <span class="comment">// If we haven't yet assigned the final cached adj</span></div><div class="line">               <span class="comment">// to the process, do that now.</span></div><div class="line">               <span class="keyword">if</span> (app.curAdj &gt;= ProcessList.UNKNOWN_ADJ) &#123; <span class="comment">//KP 注意:oom_adj值是越大则优先级越小，所以这里的app.curAdj&gt;=ProcessList.UNKNOWN_ADJ表示比ProcessList.UNKNOWN_ADJ的优先级还低，即表示还没更新它的oom_adj值</span></div><div class="line">                   <span class="keyword">switch</span> (app.curProcState) &#123;</div><div class="line">                       <span class="keyword">case</span> ActivityManager.PROCESS_STATE_CACHED_ACTIVITY:</div><div class="line">                       <span class="keyword">case</span> ActivityManager.PROCESS_STATE_CACHED_ACTIVITY_CLIENT:</div><div class="line">                           <span class="comment">// This process is a cached process holding activities...</span></div><div class="line">                           <span class="comment">// assign it the next cached value for that type, and then</span></div><div class="line">                           <span class="comment">// step that cached level.</span></div><div class="line">                           app.curRawAdj = curCachedAdj;</div><div class="line">                           app.curAdj = app.modifyRawOomAdj(curCachedAdj);</div><div class="line">                           <span class="keyword">if</span> (DEBUG_LRU &amp;&amp; <span class="keyword">false</span>) Slog.d(TAG_LRU, <span class="string">"Assigning activity LRU #"</span> + i</div><div class="line">                                   + <span class="string">" adj: "</span> + app.curAdj + <span class="string">" (curCachedAdj="</span> + curCachedAdj</div><div class="line">                                   + <span class="string">")"</span>);</div><div class="line">                           <span class="keyword">if</span> (curCachedAdj != nextCachedAdj) &#123;</div><div class="line">                               stepCached++;</div><div class="line">                               <span class="keyword">if</span> (stepCached &gt;= cachedFactor) &#123;</div><div class="line">                                   stepCached = <span class="number">0</span>;</div><div class="line">                                   curCachedAdj = nextCachedAdj;</div><div class="line">                                   nextCachedAdj += <span class="number">2</span>;</div><div class="line">                                   <span class="keyword">if</span> (nextCachedAdj &gt; ProcessList.CACHED_APP_MAX_ADJ) &#123;</div><div class="line">                                       nextCachedAdj = ProcessList.CACHED_APP_MAX_ADJ;</div><div class="line">                                   &#125;</div><div class="line">                               &#125;</div><div class="line">                           &#125;</div><div class="line">                           <span class="keyword">break</span>;</div><div class="line">                       <span class="keyword">default</span>:</div><div class="line">                           <span class="comment">// For everything else, assign next empty cached process</span></div><div class="line">                           <span class="comment">// level and bump that up.  Note that this means that</span></div><div class="line">                           <span class="comment">// long-running services that have dropped down to the</span></div><div class="line">                           <span class="comment">// cached level will be treated as empty (since their process</span></div><div class="line">                           <span class="comment">// state is still as a service), which is what we want.</span></div><div class="line">                           app.curRawAdj = curEmptyAdj;</div><div class="line">                           app.curAdj = app.modifyRawOomAdj(curEmptyAdj);</div><div class="line">                           <span class="keyword">if</span> (DEBUG_LRU &amp;&amp; <span class="keyword">false</span>) Slog.d(TAG_LRU, <span class="string">"Assigning empty LRU #"</span> + i</div><div class="line">                                   + <span class="string">" adj: "</span> + app.curAdj + <span class="string">" (curEmptyAdj="</span> + curEmptyAdj</div><div class="line">                                   + <span class="string">")"</span>);</div><div class="line">                           <span class="keyword">if</span> (curEmptyAdj != nextEmptyAdj) &#123;</div><div class="line">                               stepEmpty++;</div><div class="line">                               <span class="keyword">if</span> (stepEmpty &gt;= emptyFactor) &#123;</div><div class="line">                                   stepEmpty = <span class="number">0</span>;</div><div class="line">                                   curEmptyAdj = nextEmptyAdj;</div><div class="line">                                   nextEmptyAdj += <span class="number">2</span>;</div><div class="line">                                   <span class="keyword">if</span> (nextEmptyAdj &gt; ProcessList.CACHED_APP_MAX_ADJ) &#123;</div><div class="line">                                       nextEmptyAdj = ProcessList.CACHED_APP_MAX_ADJ;</div><div class="line">                                   &#125;</div><div class="line">                               &#125;</div><div class="line">                           &#125;</div><div class="line">                           <span class="keyword">break</span>;</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line"></div><div class="line">               applyOomAdjLocked(app, <span class="keyword">true</span>, now, nowElapsed);</div><div class="line"></div><div class="line">               <span class="comment">// Count the number of process types.</span></div><div class="line">               <span class="keyword">switch</span> (app.curProcState) &#123;</div><div class="line">                   <span class="keyword">case</span> ActivityManager.PROCESS_STATE_CACHED_ACTIVITY:</div><div class="line">                   <span class="keyword">case</span> ActivityManager.PROCESS_STATE_CACHED_ACTIVITY_CLIENT:</div><div class="line">                       mNumCachedHiddenProcs++;</div><div class="line">                       numCached++;</div><div class="line">                       <span class="keyword">if</span> (numCached &gt; cachedProcessLimit) &#123;</div><div class="line">                           app.kill(<span class="string">"cached #"</span> + numCached, <span class="keyword">true</span>);</div><div class="line">                       &#125;</div><div class="line">                       <span class="keyword">break</span>;</div><div class="line">                   <span class="keyword">case</span> ActivityManager.PROCESS_STATE_CACHED_EMPTY:</div><div class="line">                       <span class="keyword">if</span> (numEmpty &gt; ProcessList.TRIM_EMPTY_APPS</div><div class="line">                               &amp;&amp; app.lastActivityTime &lt; oldTime) &#123;</div><div class="line">                           app.kill(<span class="string">"empty for "</span></div><div class="line">                                   + ((oldTime + ProcessList.MAX_EMPTY_TIME - app.lastActivityTime)</div><div class="line">                                   / <span class="number">1000</span>) + <span class="string">"s"</span>, <span class="keyword">true</span>);</div><div class="line">                       &#125; <span class="keyword">else</span> &#123;</div><div class="line">                           numEmpty++;</div><div class="line">                           <span class="keyword">if</span> (numEmpty &gt; emptyProcessLimit) &#123;</div><div class="line">                               app.kill(<span class="string">"empty #"</span> + numEmpty, <span class="keyword">true</span>);</div><div class="line">                           &#125;</div><div class="line">                       &#125;</div><div class="line">                       <span class="keyword">break</span>;</div><div class="line">                   <span class="keyword">default</span>:</div><div class="line">                       mNumNonCachedProcs++;</div><div class="line">                       <span class="keyword">break</span>;</div><div class="line">               &#125;</div><div class="line"></div><div class="line">               <span class="keyword">if</span> (app.isolated &amp;&amp; app.services.size() &lt;= <span class="number">0</span>) &#123;</div><div class="line">                   <span class="comment">// If this is an isolated process, and there are no</span></div><div class="line">                   <span class="comment">// services running in it, then the process is no longer</span></div><div class="line">                   <span class="comment">// needed.  We agressively kill these because we can by</span></div><div class="line">                   <span class="comment">// definition not re-use the same process again, and it is</span></div><div class="line">                   <span class="comment">// good to avoid having whatever code was running in them</span></div><div class="line">                   <span class="comment">// left sitting around after no longer needed.</span></div><div class="line">                   app.kill(<span class="string">"isolated not needed"</span>, <span class="keyword">true</span>);</div><div class="line">               &#125; <span class="keyword">else</span> &#123;</div><div class="line">                   <span class="comment">// Keeping this process, update its uid.</span></div><div class="line">                   <span class="keyword">final</span> UidRecord uidRec = app.uidRecord;</div><div class="line">                   <span class="keyword">if</span> (uidRec != <span class="keyword">null</span> &amp;&amp; uidRec.curProcState &gt; app.curProcState) &#123;</div><div class="line">                       uidRec.curProcState = app.curProcState;</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line"></div><div class="line">               <span class="keyword">if</span> (app.curProcState &gt;= ActivityManager.PROCESS_STATE_HOME</div><div class="line">                       &amp;&amp; !app.killedByAm) &#123;</div><div class="line">                   numTrimming++;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       mNumServiceProcs = mNewNumServiceProcs;</div><div class="line"></div><div class="line">       <span class="comment">// Now determine the memory trimming level of background processes.</span></div><div class="line">       <span class="comment">// Unfortunately we need to start at the back of the list to do this</span></div><div class="line">       <span class="comment">// properly.  We only do this if the number of background apps we</span></div><div class="line">       <span class="comment">// are managing to keep around is less than half the maximum we desire;</span></div><div class="line">       <span class="comment">// if we are keeping a good number around, we'll let them use whatever</span></div><div class="line">       <span class="comment">// memory they want.</span></div><div class="line">       <span class="keyword">final</span> <span class="keyword">int</span> numCachedAndEmpty = numCached + numEmpty;</div><div class="line">       <span class="keyword">int</span> memFactor;</div><div class="line">       <span class="keyword">if</span> (numCached &lt;= ProcessList.TRIM_CACHED_APPS</div><div class="line">               &amp;&amp; numEmpty &lt;= ProcessList.TRIM_EMPTY_APPS) &#123;</div><div class="line">           <span class="keyword">if</span> (numCachedAndEmpty &lt;= ProcessList.TRIM_CRITICAL_THRESHOLD) &#123;</div><div class="line">               memFactor = ProcessStats.ADJ_MEM_FACTOR_CRITICAL;</div><div class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (numCachedAndEmpty &lt;= ProcessList.TRIM_LOW_THRESHOLD) &#123;</div><div class="line">               memFactor = ProcessStats.ADJ_MEM_FACTOR_LOW;</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               memFactor = ProcessStats.ADJ_MEM_FACTOR_MODERATE;</div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           memFactor = ProcessStats.ADJ_MEM_FACTOR_NORMAL;</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// We always allow the memory level to go up (better).  We only allow it to go</span></div><div class="line">       <span class="comment">// down if we are in a state where that is allowed, *and* the total number of processes</span></div><div class="line">       <span class="comment">// has gone down since last time.</span></div><div class="line">       <span class="keyword">if</span> (DEBUG_OOM_ADJ) Slog.d(TAG_OOM_ADJ, <span class="string">"oom: memFactor="</span> + memFactor</div><div class="line">               + <span class="string">" last="</span> + mLastMemoryLevel + <span class="string">" allowLow="</span> + mAllowLowerMemLevel</div><div class="line">               + <span class="string">" numProcs="</span> + mLruProcesses.size() + <span class="string">" last="</span> + mLastNumProcesses);</div><div class="line">       <span class="keyword">if</span> (memFactor &gt; mLastMemoryLevel) &#123;</div><div class="line">           <span class="keyword">if</span> (!mAllowLowerMemLevel || mLruProcesses.size() &gt;= mLastNumProcesses) &#123;</div><div class="line">               memFactor = mLastMemoryLevel;</div><div class="line">               <span class="keyword">if</span> (DEBUG_OOM_ADJ) Slog.d(TAG_OOM_ADJ, <span class="string">"Keeping last mem factor!"</span>);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       mLastMemoryLevel = memFactor;</div><div class="line">       mLastNumProcesses = mLruProcesses.size();</div><div class="line">       <span class="keyword">boolean</span> allChanged = mProcessStats.setMemFactorLocked(memFactor, !isSleeping(), now);</div><div class="line">       <span class="keyword">final</span> <span class="keyword">int</span> trackerMemFactor = mProcessStats.getMemFactorLocked();</div><div class="line">       <span class="keyword">if</span> (memFactor != ProcessStats.ADJ_MEM_FACTOR_NORMAL) &#123;</div><div class="line">           <span class="keyword">if</span> (mLowRamStartTime == <span class="number">0</span>) &#123;</div><div class="line">               mLowRamStartTime = now;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">int</span> step = <span class="number">0</span>;</div><div class="line">           <span class="keyword">int</span> fgTrimLevel;</div><div class="line">           <span class="keyword">switch</span> (memFactor) &#123;</div><div class="line">               <span class="keyword">case</span> ProcessStats.ADJ_MEM_FACTOR_CRITICAL:</div><div class="line">                   fgTrimLevel = ComponentCallbacks2.TRIM_MEMORY_RUNNING_CRITICAL;</div><div class="line">                   <span class="keyword">break</span>;</div><div class="line">               <span class="keyword">case</span> ProcessStats.ADJ_MEM_FACTOR_LOW:</div><div class="line">                   fgTrimLevel = ComponentCallbacks2.TRIM_MEMORY_RUNNING_LOW;</div><div class="line">                   <span class="keyword">break</span>;</div><div class="line">               <span class="keyword">default</span>:</div><div class="line">                   fgTrimLevel = ComponentCallbacks2.TRIM_MEMORY_RUNNING_MODERATE;</div><div class="line">                   <span class="keyword">break</span>;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">int</span> factor = numTrimming/<span class="number">3</span>;</div><div class="line">           <span class="keyword">int</span> minFactor = <span class="number">2</span>;</div><div class="line">           <span class="keyword">if</span> (mHomeProcess != <span class="keyword">null</span>) minFactor++;</div><div class="line">           <span class="keyword">if</span> (mPreviousProcess != <span class="keyword">null</span>) minFactor++;</div><div class="line">           <span class="keyword">if</span> (factor &lt; minFactor) factor = minFactor;</div><div class="line">           <span class="keyword">int</span> curLevel = ComponentCallbacks2.TRIM_MEMORY_COMPLETE;</div><div class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> i=N-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</div><div class="line">               ProcessRecord app = mLruProcesses.get(i);</div><div class="line">               <span class="keyword">if</span> (allChanged || app.procStateChanged) &#123;</div><div class="line">                   setProcessTrackerStateLocked(app, trackerMemFactor, now);</div><div class="line">                   app.procStateChanged = <span class="keyword">false</span>;</div><div class="line">               &#125;</div><div class="line">               <span class="keyword">if</span> (app.curProcState &gt;= ActivityManager.PROCESS_STATE_HOME</div><div class="line">                       &amp;&amp; !app.killedByAm) &#123;</div><div class="line">                   <span class="keyword">if</span> (app.trimMemoryLevel &lt; curLevel &amp;&amp; app.thread != <span class="keyword">null</span>) &#123;</div><div class="line">                       <span class="keyword">try</span> &#123;</div><div class="line">                           <span class="keyword">if</span> (DEBUG_SWITCH || DEBUG_OOM_ADJ) Slog.v(TAG_OOM_ADJ,</div><div class="line">                                   <span class="string">"Trimming memory of "</span> + app.processName + <span class="string">" to "</span> + curLevel);</div><div class="line">                           app.thread.scheduleTrimMemory(curLevel);</div><div class="line">                       &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">                       &#125;</div><div class="line">                       <span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</div><div class="line">                           <span class="comment">// For now we won't do this; our memory trimming seems</span></div><div class="line">                           <span class="comment">// to be good enough at this point that destroying</span></div><div class="line">                           <span class="comment">// activities causes more harm than good.</span></div><div class="line">                           <span class="keyword">if</span> (curLevel &gt;= ComponentCallbacks2.TRIM_MEMORY_COMPLETE</div><div class="line">                                   &amp;&amp; app != mHomeProcess &amp;&amp; app != mPreviousProcess) &#123;</div><div class="line">                               <span class="comment">// Need to do this on its own message because the stack may not</span></div><div class="line">                               <span class="comment">// be in a consistent state at this point.</span></div><div class="line">                               <span class="comment">// For these apps we will also finish their activities</span></div><div class="line">                               <span class="comment">// to help them free memory.</span></div><div class="line">                               mStackSupervisor.scheduleDestroyAllActivities(app, <span class="string">"trim"</span>);</div><div class="line">                           &#125;</div><div class="line">                       &#125;</div><div class="line">                   &#125;</div><div class="line">                   app.trimMemoryLevel = curLevel;</div><div class="line">                   step++;</div><div class="line">                   <span class="keyword">if</span> (step &gt;= factor) &#123;</div><div class="line">                       step = <span class="number">0</span>;</div><div class="line">                       <span class="keyword">switch</span> (curLevel) &#123;</div><div class="line">                           <span class="keyword">case</span> ComponentCallbacks2.TRIM_MEMORY_COMPLETE:</div><div class="line">                               curLevel = ComponentCallbacks2.TRIM_MEMORY_MODERATE;</div><div class="line">                               <span class="keyword">break</span>;</div><div class="line">                           <span class="keyword">case</span> ComponentCallbacks2.TRIM_MEMORY_MODERATE:</div><div class="line">                               curLevel = ComponentCallbacks2.TRIM_MEMORY_BACKGROUND;</div><div class="line">                               <span class="keyword">break</span>;</div><div class="line">                       &#125;</div><div class="line">                   &#125;</div><div class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (app.curProcState == ActivityManager.PROCESS_STATE_HEAVY_WEIGHT) &#123;</div><div class="line">                   <span class="keyword">if</span> (app.trimMemoryLevel &lt; ComponentCallbacks2.TRIM_MEMORY_BACKGROUND</div><div class="line">                           &amp;&amp; app.thread != <span class="keyword">null</span>) &#123;</div><div class="line">                       <span class="keyword">try</span> &#123;</div><div class="line">                           <span class="keyword">if</span> (DEBUG_SWITCH || DEBUG_OOM_ADJ) Slog.v(TAG_OOM_ADJ,</div><div class="line">                                   <span class="string">"Trimming memory of heavy-weight "</span> + app.processName</div><div class="line">                                   + <span class="string">" to "</span> + ComponentCallbacks2.TRIM_MEMORY_BACKGROUND);</div><div class="line">                           app.thread.scheduleTrimMemory(</div><div class="line">                                   ComponentCallbacks2.TRIM_MEMORY_BACKGROUND);</div><div class="line">                       &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">                       &#125;</div><div class="line">                   &#125;</div><div class="line">                   app.trimMemoryLevel = ComponentCallbacks2.TRIM_MEMORY_BACKGROUND;</div><div class="line">               &#125; <span class="keyword">else</span> &#123;</div><div class="line">                   <span class="keyword">if</span> ((app.curProcState &gt;= ActivityManager.PROCESS_STATE_IMPORTANT_BACKGROUND</div><div class="line">                           || app.systemNoUi) &amp;&amp; app.pendingUiClean) &#123;</div><div class="line">                       <span class="comment">// If this application is now in the background and it</span></div><div class="line">                       <span class="comment">// had done UI, then give it the special trim level to</span></div><div class="line">                       <span class="comment">// have it free UI resources.</span></div><div class="line">                       <span class="keyword">final</span> <span class="keyword">int</span> level = ComponentCallbacks2.TRIM_MEMORY_UI_HIDDEN;</div><div class="line">                       <span class="keyword">if</span> (app.trimMemoryLevel &lt; level &amp;&amp; app.thread != <span class="keyword">null</span>) &#123;</div><div class="line">                           <span class="keyword">try</span> &#123;</div><div class="line">                               <span class="keyword">if</span> (DEBUG_SWITCH || DEBUG_OOM_ADJ) Slog.v(TAG_OOM_ADJ,</div><div class="line">                                       <span class="string">"Trimming memory of bg-ui "</span> + app.processName</div><div class="line">                                       + <span class="string">" to "</span> + level);</div><div class="line">                               app.thread.scheduleTrimMemory(level);</div><div class="line">                           &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">                           &#125;</div><div class="line">                       &#125;</div><div class="line">                       app.pendingUiClean = <span class="keyword">false</span>;</div><div class="line">                   &#125;</div><div class="line">                   <span class="keyword">if</span> (app.trimMemoryLevel &lt; fgTrimLevel &amp;&amp; app.thread != <span class="keyword">null</span>) &#123;</div><div class="line">                       <span class="keyword">try</span> &#123;</div><div class="line">                           <span class="keyword">if</span> (DEBUG_SWITCH || DEBUG_OOM_ADJ) Slog.v(TAG_OOM_ADJ,</div><div class="line">                                   <span class="string">"Trimming memory of fg "</span> + app.processName</div><div class="line">                                   + <span class="string">" to "</span> + fgTrimLevel);</div><div class="line">                           app.thread.scheduleTrimMemory(fgTrimLevel);</div><div class="line">                       &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">                       &#125;</div><div class="line">                   &#125;</div><div class="line">                   app.trimMemoryLevel = fgTrimLevel;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           <span class="keyword">if</span> (mLowRamStartTime != <span class="number">0</span>) &#123;</div><div class="line">               mLowRamTimeSinceLastIdle += now - mLowRamStartTime;</div><div class="line">               mLowRamStartTime = <span class="number">0</span>;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> i=N-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</div><div class="line">               ProcessRecord app = mLruProcesses.get(i);</div><div class="line">               <span class="keyword">if</span> (allChanged || app.procStateChanged) &#123;</div><div class="line">                   setProcessTrackerStateLocked(app, trackerMemFactor, now);</div><div class="line">                   app.procStateChanged = <span class="keyword">false</span>;</div><div class="line">               &#125;</div><div class="line">               <span class="keyword">if</span> ((app.curProcState &gt;= ActivityManager.PROCESS_STATE_IMPORTANT_BACKGROUND</div><div class="line">                       || app.systemNoUi) &amp;&amp; app.pendingUiClean) &#123;</div><div class="line">                   <span class="keyword">if</span> (app.trimMemoryLevel &lt; ComponentCallbacks2.TRIM_MEMORY_UI_HIDDEN</div><div class="line">                           &amp;&amp; app.thread != <span class="keyword">null</span>) &#123;</div><div class="line">                       <span class="keyword">try</span> &#123;</div><div class="line">                           <span class="keyword">if</span> (DEBUG_SWITCH || DEBUG_OOM_ADJ) Slog.v(TAG_OOM_ADJ,</div><div class="line">                                   <span class="string">"Trimming memory of ui hidden "</span> + app.processName</div><div class="line">                                   + <span class="string">" to "</span> + ComponentCallbacks2.TRIM_MEMORY_UI_HIDDEN);</div><div class="line">                           app.thread.scheduleTrimMemory(</div><div class="line">                                   ComponentCallbacks2.TRIM_MEMORY_UI_HIDDEN);</div><div class="line">                       &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">                       &#125;</div><div class="line">                   &#125;</div><div class="line">                   app.pendingUiClean = <span class="keyword">false</span>;</div><div class="line">               &#125;</div><div class="line">               app.trimMemoryLevel = <span class="number">0</span>;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (mAlwaysFinishActivities) &#123;</div><div class="line">           <span class="comment">// Need to do this on its own message because the stack may not</span></div><div class="line">           <span class="comment">// be in a consistent state at this point.</span></div><div class="line">           mStackSupervisor.scheduleDestroyAllActivities(<span class="keyword">null</span>, <span class="string">"always-finish"</span>);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (allChanged) &#123;</div><div class="line">           requestPssAllProcsLocked(now, <span class="keyword">false</span>, mProcessStats.isMemFactorLowered());</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">// Update from any uid changes.</span></div><div class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i=mActiveUids.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</div><div class="line">           <span class="keyword">final</span> UidRecord uidRec = mActiveUids.valueAt(i);</div><div class="line">           <span class="keyword">if</span> (uidRec.setProcState != uidRec.curProcState) &#123;</div><div class="line">               <span class="keyword">if</span> (DEBUG_UID_OBSERVERS) Slog.i(TAG_UID_OBSERVERS,</div><div class="line">                       <span class="string">"Changes in "</span> + uidRec + <span class="string">": proc state from "</span> + uidRec.setProcState</div><div class="line">                       + <span class="string">" to "</span> + uidRec.curProcState);</div><div class="line">               uidRec.setProcState = uidRec.curProcState;</div><div class="line">               enqueueUidChangeLocked(uidRec, <span class="keyword">false</span>);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (mProcessStats.shouldWriteNowLocked(now)) &#123;</div><div class="line">           mHandler.post(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">               <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                   <span class="keyword">synchronized</span> (ActivityManagerService.<span class="keyword">this</span>) &#123;</div><div class="line">                       mProcessStats.writeStateAsyncLocked();</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">           &#125;);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (DEBUG_OOM_ADJ) &#123;</div><div class="line">           <span class="keyword">final</span> <span class="keyword">long</span> duration = SystemClock.uptimeMillis() - now;</div><div class="line">           <span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</div><div class="line">               Slog.d(TAG_OOM_ADJ, <span class="string">"Did OOM ADJ in "</span> + duration + <span class="string">"ms"</span>,</div><div class="line">                       <span class="keyword">new</span> RuntimeException(<span class="string">"here"</span>).fillInStackTrace());</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               Slog.d(TAG_OOM_ADJ, <span class="string">"Did OOM ADJ in "</span> + duration + <span class="string">"ms"</span>);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>吐槽一下这个400多行的方法，还好这个方法的注释写得比较全面，主要就是做了以下事情:</p>
<ul>
<li>首先基于app当前状态更新每个app进程的oom_adj值，在这里面也可以看到，对于孤立的进程(即无service在其中运行的进程)，AMS会有很大的概率将其杀死(原话是agressively kill these)，所以如果想保活的话，要尽可能避免这种情况的出现</li>
<li>然后决定后台进程的memory trimming level</li>
<li>最后会根据uid的改变来更新oom_adj值</li>
</ul>
<h3 id="client端的连接回调"><a href="#client端的连接回调" class="headerlink" title="client端的连接回调"></a>client端的连接回调</h3><p>再回到ActiveServices中的bindServiceLocked()方法中，在更新完Service所在进程的oom_adj值之后，会通过IServiceConnection进行IPC调用，对应的代码片段为:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">... </div><div class="line"><span class="keyword">if</span> (s.app != <span class="keyword">null</span> &amp;&amp; b.intent.received) &#123;</div><div class="line">                <span class="comment">// Service is already running, so we can immediately</span></div><div class="line">                <span class="comment">// publish the connection.</span></div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    c.conn.connected(s.name, b.intent.binder);</div><div class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                    Slog.w(TAG, <span class="string">"Failure sending service "</span> + s.shortName</div><div class="line">                            + <span class="string">" to connection "</span> + c.conn.asBinder()</div><div class="line">                            + <span class="string">" (in "</span> + c.binding.client.processName + <span class="string">")"</span>, e);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">// If this is the first app connected back to this binding,</span></div><div class="line">                <span class="comment">// and the service had previously asked to be told when</span></div><div class="line">                <span class="comment">// rebound, then do so.</span></div><div class="line">                <span class="keyword">if</span> (b.intent.apps.size() == <span class="number">1</span> &amp;&amp; b.intent.doRebind) &#123;</div><div class="line">                    requestServiceBindingLocked(s, b.intent, callerFg, <span class="keyword">true</span>);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!b.intent.requested) &#123;</div><div class="line">                requestServiceBindingLocked(s, b.intent, callerFg, <span class="keyword">false</span>);</div><div class="line">            &#125;</div><div class="line">            ....</div></pre></td></tr></table></figure>
<p>显然是调用IServiceConnection的connected()方法，再回到ContextImpl中，IServiceConnection的真正实现在ServiceDispatcher中的InnerConnection中:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">InnerConnection</span> <span class="keyword">extends</span> <span class="title">IServiceConnection</span>.<span class="title">Stub</span> </span>&#123;</div><div class="line">     <span class="keyword">final</span> WeakReference&lt;LoadedApk.ServiceDispatcher&gt; mDispatcher;</div><div class="line"></div><div class="line">     InnerConnection(LoadedApk.ServiceDispatcher sd) &#123;</div><div class="line">         mDispatcher = <span class="keyword">new</span> WeakReference&lt;LoadedApk.ServiceDispatcher&gt;(sd);</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">connected</span><span class="params">(ComponentName name, IBinder service)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</div><div class="line">         LoadedApk.ServiceDispatcher sd = mDispatcher.get();</div><div class="line">         <span class="keyword">if</span> (sd != <span class="keyword">null</span>) &#123;</div><div class="line">             sd.connected(name, service);</div><div class="line">         &#125;</div><div class="line">     &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>显然，通过IPC调用之后会调用ServiceDispatcher的connected()方法，该方法如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">connected</span><span class="params">(ComponentName name, IBinder service)</span> </span>&#123;</div><div class="line">           <span class="keyword">if</span> (mActivityThread != <span class="keyword">null</span>) &#123;</div><div class="line">               mActivityThread.post(<span class="keyword">new</span> RunConnection(name, service, <span class="number">0</span>));</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               doConnected(name, service);</div><div class="line">           &#125;</div><div class="line">       &#125;</div></pre></td></tr></table></figure>
<p>到这里就很好理解了，由于回调是在binder线程中，这里通过ActivityThread中的Handler将事件发布到主线程中，其中RunConnection如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">RunConnection</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">           RunConnection(ComponentName name, IBinder service, <span class="keyword">int</span> command) &#123;</div><div class="line">               mName = name;</div><div class="line">               mService = service;</div><div class="line">               mCommand = command;</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">               <span class="keyword">if</span> (mCommand == <span class="number">0</span>) &#123;</div><div class="line">                   doConnected(mName, mService);</div><div class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mCommand == <span class="number">1</span>) &#123;</div><div class="line">                   doDeath(mName, mService);</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="keyword">final</span> ComponentName mName;</div><div class="line">           <span class="keyword">final</span> IBinder mService;</div><div class="line">           <span class="keyword">final</span> <span class="keyword">int</span> mCommand;</div><div class="line">       &#125;</div></pre></td></tr></table></figure>
<p>而doConnected()方法如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doConnected</span><span class="params">(ComponentName name, IBinder service)</span> </span>&#123;</div><div class="line">          ServiceDispatcher.ConnectionInfo old;</div><div class="line">          ServiceDispatcher.ConnectionInfo info;</div><div class="line"></div><div class="line">          <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">              <span class="keyword">if</span> (mForgotten) &#123;</div><div class="line">                  <span class="comment">// We unbound before receiving the connection; ignore</span></div><div class="line">                  <span class="comment">// any connection received.</span></div><div class="line">                  <span class="keyword">return</span>;</div><div class="line">              &#125;</div><div class="line">              old = mActiveConnections.get(name);</div><div class="line">              <span class="keyword">if</span> (old != <span class="keyword">null</span> &amp;&amp; old.binder == service) &#123;</div><div class="line">                  <span class="comment">// Huh, already have this one.  Oh well!</span></div><div class="line">                  <span class="keyword">return</span>;</div><div class="line">              &#125;</div><div class="line"></div><div class="line">              <span class="keyword">if</span> (service != <span class="keyword">null</span>) &#123;</div><div class="line">                  <span class="comment">// A new service is being connected... set it all up.</span></div><div class="line">                  mDied = <span class="keyword">false</span>;</div><div class="line">                  info = <span class="keyword">new</span> ConnectionInfo();</div><div class="line">                  info.binder = service;</div><div class="line">                  info.deathMonitor = <span class="keyword">new</span> DeathMonitor(name, service);</div><div class="line">                  <span class="keyword">try</span> &#123;</div><div class="line">                      service.linkToDeath(info.deathMonitor, <span class="number">0</span>);</div><div class="line">                      mActiveConnections.put(name, info);</div><div class="line">                  &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">                      <span class="comment">// This service was dead before we got it...  just</span></div><div class="line">                      <span class="comment">// don't do anything with it.</span></div><div class="line">                      mActiveConnections.remove(name);</div><div class="line">                      <span class="keyword">return</span>;</div><div class="line">                  &#125;</div><div class="line"></div><div class="line">              &#125; <span class="keyword">else</span> &#123;</div><div class="line">                  <span class="comment">// The named service is being disconnected... clean up.</span></div><div class="line">                  mActiveConnections.remove(name);</div><div class="line">              &#125;</div><div class="line"></div><div class="line">              <span class="keyword">if</span> (old != <span class="keyword">null</span>) &#123;</div><div class="line">                  old.binder.unlinkToDeath(old.deathMonitor, <span class="number">0</span>);</div><div class="line">              &#125;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          <span class="comment">// If there was an old service, it is not disconnected.</span></div><div class="line">          <span class="keyword">if</span> (old != <span class="keyword">null</span>) &#123;</div><div class="line">              mConnection.onServiceDisconnected(name);</div><div class="line">          &#125;</div><div class="line">          <span class="comment">// If there is a new service, it is now connected.</span></div><div class="line">          <span class="keyword">if</span> (service != <span class="keyword">null</span>) &#123;</div><div class="line">              mConnection.onServiceConnected(name, service);</div><div class="line">          &#125;</div><div class="line">      &#125;</div></pre></td></tr></table></figure>
<p>可以发现，这个方法看似很长，实际上主要就是做了三件事:</p>
<ul>
<li>处理之前的ServiceConnection</li>
<li>为IBinder添加DeathMonitor,一旦发现binderDied()回调，就进行连接记录的修改，以及调用ServiceConnection的onDisconnected()方法</li>
<li><strong>调用我们创建的ServiceConnection的onServiceConnected()方法</strong>。</li>
</ul>
<h3 id="继续AMS中的bindServiceLocked-方法"><a href="#继续AMS中的bindServiceLocked-方法" class="headerlink" title="继续AMS中的bindServiceLocked()方法"></a>继续AMS中的bindServiceLocked()方法</h3><p>再回到AMS的bindServiceLocked()方法，最后面的一个代码片段如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (s.app != <span class="keyword">null</span> &amp;&amp; b.intent.received) &#123;</div><div class="line">     <span class="comment">// Service is already running, so we can immediately</span></div><div class="line">     <span class="comment">// publish the connection.</span></div><div class="line">     <span class="keyword">try</span> &#123;</div><div class="line">         c.conn.connected(s.name, b.intent.binder);</div><div class="line">     &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">         Slog.w(TAG, <span class="string">"Failure sending service "</span> + s.shortName</div><div class="line">                 + <span class="string">" to connection "</span> + c.conn.asBinder()</div><div class="line">                 + <span class="string">" (in "</span> + c.binding.client.processName + <span class="string">")"</span>, e);</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     <span class="comment">// If this is the first app connected back to this binding,</span></div><div class="line">     <span class="comment">// and the service had previously asked to be told when</span></div><div class="line">     <span class="comment">// rebound, then do so.</span></div><div class="line">     <span class="keyword">if</span> (b.intent.apps.size() == <span class="number">1</span> &amp;&amp; b.intent.doRebind) &#123;</div><div class="line">         requestServiceBindingLocked(s, b.intent, callerFg, <span class="keyword">true</span>);</div><div class="line">     &#125;</div><div class="line"> &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!b.intent.requested) &#123;</div><div class="line">     requestServiceBindingLocked(s, b.intent, callerFg, <span class="keyword">false</span>);</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>这段代码非常有意思，即有两种情形，一种是某个进程重连到远程Service时，会调用requestServiceBindingLocked()方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">requestServiceBindingLocked</span><span class="params">(ServiceRecord r, IntentBindRecord i,</span></span></div><div class="line"><span class="function"><span class="params">           <span class="keyword">boolean</span> execInFg, <span class="keyword">boolean</span> rebind)</span> <span class="keyword">throws</span> TransactionTooLargeException </span>&#123;</div><div class="line">       <span class="keyword">if</span> (r.app == <span class="keyword">null</span> || r.app.thread == <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="comment">// If service is not currently running, can't yet bind.</span></div><div class="line">           <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> ((!i.requested || rebind) &amp;&amp; i.apps.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">           <span class="keyword">try</span> &#123;</div><div class="line">               bumpServiceExecutingLocked(r, execInFg, <span class="string">"bind"</span>);</div><div class="line">               r.app.forceProcessStateUpTo(ActivityManager.PROCESS_STATE_SERVICE);</div><div class="line">               r.app.thread.scheduleBindService(r, i.intent.getIntent(), rebind,</div><div class="line">                       r.app.repProcState);</div><div class="line">               <span class="keyword">if</span> (!rebind) &#123;</div><div class="line">                   i.requested = <span class="keyword">true</span>;</div><div class="line">               &#125;</div><div class="line">               i.hasBound = <span class="keyword">true</span>;</div><div class="line">               i.doRebind = <span class="keyword">false</span>;</div><div class="line">           &#125; <span class="keyword">catch</span> (TransactionTooLargeException e) &#123;</div><div class="line">               <span class="comment">// Keep the executeNesting count accurate.</span></div><div class="line">               <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"Crashed while binding "</span> + r, e);</div><div class="line">               <span class="keyword">final</span> <span class="keyword">boolean</span> inDestroying = mDestroyingServices.contains(r);</div><div class="line">               serviceDoneExecutingLocked(r, inDestroying, inDestroying);</div><div class="line">               <span class="keyword">throw</span> e;</div><div class="line">           &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">               <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"Crashed while binding "</span> + r);</div><div class="line">               <span class="comment">// Keep the executeNesting count accurate.</span></div><div class="line">               <span class="keyword">final</span> <span class="keyword">boolean</span> inDestroying = mDestroyingServices.contains(r);</div><div class="line">               serviceDoneExecutingLocked(r, inDestroying, inDestroying);</div><div class="line">               <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>忽略其它细节，注意r.app.thread.scheduleBindService()这个调用，这其实是<strong>会IPC调用到Service所在进程的ApplicationThread的scheduleBindService()方法</strong>,之后通过Handler在主线程调用handleBindService()方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleBindService</span><span class="params">(BindServiceData data)</span> </span>&#123;</div><div class="line">        Service s = mServices.get(data.token);</div><div class="line">        <span class="keyword">if</span> (DEBUG_SERVICE)</div><div class="line">            Slog.v(TAG, <span class="string">"handleBindService s="</span> + s + <span class="string">" rebind="</span> + data.rebind);</div><div class="line">        <span class="keyword">if</span> (s != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                data.intent.setExtrasClassLoader(s.getClassLoader());</div><div class="line">                data.intent.prepareToEnterProcess();</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    <span class="keyword">if</span> (!data.rebind) &#123;</div><div class="line">                        IBinder binder = s.onBind(data.intent);</div><div class="line">                        ActivityManagerNative.getDefault().publishService(</div><div class="line">                                data.token, data.intent, binder);</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        s.onRebind(data.intent);</div><div class="line">                        ActivityManagerNative.getDefault().serviceDoneExecuting(</div><div class="line">                                data.token, SERVICE_DONE_EXECUTING_ANON, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">                    &#125;</div><div class="line">                    ensureJitEnabled();</div><div class="line">                &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                <span class="keyword">if</span> (!mInstrumentation.onException(s, e)) &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</div><div class="line">                            <span class="string">"Unable to bind to service "</span> + s</div><div class="line">                            + <span class="string">" with "</span> + data.intent + <span class="string">": "</span> + e.toString(), e);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>在这里可以看到分两种情况，如果不是重新连接，调用AMP的publishService()方法;否则调用AMP的serviceDoneExecuting()方法，这个方法其实是一个IPC调用，告诉AMS重新连接上了，然后AMS就会更新它的ServiceRecord和相应进程的oom_adj值。下一小节我们将分析AMS的publishService()方法。</p>
<h3 id="AMS-publishService"><a href="#AMS-publishService" class="headerlink" title="AMS.publishService()"></a>AMS.publishService()</h3><p>publishService()方法如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">publishService</span><span class="params">(IBinder token, Intent intent, IBinder service)</span> </span>&#123;</div><div class="line">        <span class="comment">// Refuse possible leaked file descriptors</span></div><div class="line">        <span class="keyword">if</span> (intent != <span class="keyword">null</span> &amp;&amp; intent.hasFileDescriptors() == <span class="keyword">true</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"File descriptors passed in Intent"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (!(token <span class="keyword">instanceof</span> ServiceRecord)) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Invalid service token"</span>);</div><div class="line">            &#125;</div><div class="line">            mServices.publishServiceLocked((ServiceRecord)token, intent, service);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>类似的，调用到ActiveServices的publishServiceLocked()方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">publishServiceLocked</span><span class="params">(ServiceRecord r, Intent intent, IBinder service)</span> </span>&#123;</div><div class="line">       <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           ...</div><div class="line">           <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</div><div class="line">               Intent.FilterComparison filter</div><div class="line">                       = <span class="keyword">new</span> Intent.FilterComparison(intent);</div><div class="line">               IntentBindRecord b = r.bindings.get(filter);</div><div class="line">               <span class="keyword">if</span> (b != <span class="keyword">null</span> &amp;&amp; !b.received) &#123;</div><div class="line">                   b.binder = service;</div><div class="line">                   b.requested = <span class="keyword">true</span>;</div><div class="line">                   b.received = <span class="keyword">true</span>;</div><div class="line">                   <span class="keyword">for</span> (<span class="keyword">int</span> conni=r.connections.size()-<span class="number">1</span>; conni&gt;=<span class="number">0</span>; conni--) &#123;</div><div class="line">                       ArrayList&lt;ConnectionRecord&gt; clist = r.connections.valueAt(conni);</div><div class="line">                       <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;clist.size(); i++) &#123;</div><div class="line">                           ConnectionRecord c = clist.get(i);</div><div class="line">                           <span class="keyword">if</span> (!filter.equals(c.binding.intent.intent)) &#123;</div><div class="line">                               ...</div><div class="line">                               <span class="keyword">continue</span>;</div><div class="line">                           &#125;</div><div class="line">                           ...</div><div class="line">                           <span class="keyword">try</span> &#123;</div><div class="line">                               c.conn.connected(r.name, service);</div><div class="line">                           &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                               ...</div><div class="line">                           &#125;</div><div class="line">                       &#125;</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line"></div><div class="line">               serviceDoneExecutingLocked(r, mDestroyingServices.contains(r), <span class="keyword">false</span>);</div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">finally</span> &#123;</div><div class="line">           Binder.restoreCallingIdentity(origId);</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>这个方法主要做了两件事:</p>
<ul>
<li>给IntentBindRecord赋值，其中的binder就是Service中onBind()所返回的binder;</li>
</ul>
<ul>
<li>这里会先判断b.received是否为false,如果为false说明发起绑定流程的进程还没收到绑定回调，从而此时会再次通过IPC调用到InnerConnection的connected()方法。</li>
</ul>
<p>最后再来看一下serviceDoneExecutingLocked()方法，这个方法也很重要:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">serviceDoneExecutingLocked</span><span class="params">(ServiceRecord r, <span class="keyword">boolean</span> inDestroying,</span></span></div><div class="line"><span class="function"><span class="params">          <span class="keyword">boolean</span> finishing)</span> </span>&#123;</div><div class="line">      <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"&lt;&lt;&lt; DONE EXECUTING "</span> + r</div><div class="line">              + <span class="string">": nesting="</span> + r.executeNesting</div><div class="line">              + <span class="string">", inDestroying="</span> + inDestroying + <span class="string">", app="</span> + r.app);</div><div class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (DEBUG_SERVICE_EXECUTING) Slog.v(TAG_SERVICE_EXECUTING,</div><div class="line">              <span class="string">"&lt;&lt;&lt; DONE EXECUTING "</span> + r.shortName);</div><div class="line">      r.executeNesting--;</div><div class="line">      <span class="keyword">if</span> (r.executeNesting &lt;= <span class="number">0</span>) &#123;</div><div class="line">          <span class="keyword">if</span> (r.app != <span class="keyword">null</span>) &#123;</div><div class="line">              <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE,</div><div class="line">                      <span class="string">"Nesting at 0 of "</span> + r.shortName);</div><div class="line">              r.app.execServicesFg = <span class="keyword">false</span>;</div><div class="line">              r.app.executingServices.remove(r);</div><div class="line">              <span class="keyword">if</span> (r.app.executingServices.size() == <span class="number">0</span>) &#123;</div><div class="line">                  <span class="keyword">if</span> (DEBUG_SERVICE || DEBUG_SERVICE_EXECUTING) Slog.v(TAG_SERVICE_EXECUTING,</div><div class="line">                          <span class="string">"No more executingServices of "</span> + r.shortName);</div><div class="line">                  mAm.mHandler.removeMessages(ActivityManagerService.SERVICE_TIMEOUT_MSG, r.app);</div><div class="line">              &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r.executeFg) &#123;</div><div class="line">                  <span class="comment">// Need to re-evaluate whether the app still needs to be in the foreground.</span></div><div class="line">                  <span class="keyword">for</span> (<span class="keyword">int</span> i=r.app.executingServices.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</div><div class="line">                      <span class="keyword">if</span> (r.app.executingServices.valueAt(i).executeFg) &#123;</div><div class="line">                          r.app.execServicesFg = <span class="keyword">true</span>;</div><div class="line">                          <span class="keyword">break</span>;</div><div class="line">                      &#125;</div><div class="line">                  &#125;</div><div class="line">              &#125;</div><div class="line">              <span class="keyword">if</span> (inDestroying) &#123;</div><div class="line">                  <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE,</div><div class="line">                          <span class="string">"doneExecuting remove destroying "</span> + r);</div><div class="line">                  mDestroyingServices.remove(r);</div><div class="line">                  r.bindings.clear();</div><div class="line">              &#125;</div><div class="line">              mAm.updateOomAdjLocked(r.app);</div><div class="line">          &#125;</div><div class="line">          r.executeFg = <span class="keyword">false</span>;</div><div class="line">          <span class="keyword">if</span> (r.tracker != <span class="keyword">null</span>) &#123;</div><div class="line">              r.tracker.setExecuting(<span class="keyword">false</span>, mAm.mProcessStats.getMemFactorLocked(),</div><div class="line">                      SystemClock.uptimeMillis());</div><div class="line">              <span class="keyword">if</span> (finishing) &#123;</div><div class="line">                  r.tracker.clearCurrentOwner(r, <span class="keyword">false</span>);</div><div class="line">                  r.tracker = <span class="keyword">null</span>;</div><div class="line">              &#125;</div><div class="line">          &#125;</div><div class="line">          <span class="keyword">if</span> (finishing) &#123;</div><div class="line">              <span class="keyword">if</span> (r.app != <span class="keyword">null</span> &amp;&amp; !r.app.persistent) &#123;</div><div class="line">                  r.app.services.remove(r);</div><div class="line">              &#125;</div><div class="line">              r.app = <span class="keyword">null</span>;</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>整个方法中，对我们来说最重要的就是mAm.updateOomAdjLocked(r.app);这个方法了,因为它涉及到更新Service所在进程的oom_adj值，而oom_adj值直接关系到内存回收。由于AMS.updateOomAdjLocked()方法我们在前面已经分析过了，这里就不再赘述了。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>通过前面的分析，可以知道bindService()其实主要做了以下事情:</p>
<ul>
<li>在client侧，ServiceConnection对象会保存在ServiceDispatcher对象中，并且利用IServiceConnection进行IPC</li>
<li>AMS会根据bindService中的Intent信息，会对Service侧进行两次IPC调用，分别是IApplicationThread的scheduleCreateService()和scheduleBindService(), 前者是为了新建Service, 而后者是获取Service的onBind()所返回的IBinder对象</li>
<li>之后AMS会根据client端和Service本身的的情况来调整Service所在进程的oom_adj值</li>
<li>最后通过IServiceConnection的proxy进行IPC,最终调用到client端的ServiceConnection的onServiceConnected()方法</li>
</ul>
<p>用图片展示整个流程的关键节点如下:</p>
<img src="/images/ipc/bindService_flow.png">

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/android-deep-analysis/" rel="tag"># android_deep_analysis</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/02/07/SkipList的原理与实现/" rel="next" title="SkipList的原理与实现">
                <i class="fa fa-chevron-left"></i> SkipList的原理与实现
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/05/16/跨进程路由方案Andromeda和InterStellar/" rel="prev" title="Andromeda:适用于多进程架构的组件通信框架">
                Andromeda:适用于多进程架构的组件通信框架 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="Allen Wang" />
          <p class="site-author-name" itemprop="name">Allen Wang</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">152</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">25</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">8</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#引言"><span class="nav-number">1.</span> <span class="nav-text">引言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#bindService-过程"><span class="nav-number">2.</span> <span class="nav-text">bindService()过程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Client端bindService"><span class="nav-number">2.1.</span> <span class="nav-text">Client端bindService()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AMS中bindService"><span class="nav-number">2.2.</span> <span class="nav-text">AMS中bindService()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Service侧进程启动以及Service启动"><span class="nav-number">2.3.</span> <span class="nav-text">Service侧进程启动以及Service启动</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#继续ActiveServices-bringUpServiceLocked-方法分析"><span class="nav-number">2.4.</span> <span class="nav-text">继续ActiveServices.bringUpServiceLocked()方法分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AMS中更新oom-adj值"><span class="nav-number">2.5.</span> <span class="nav-text">AMS中更新oom_adj值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AMS-computeOomAdjLocked"><span class="nav-number">2.6.</span> <span class="nav-text">AMS.computeOomAdjLocked()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#client端的连接回调"><span class="nav-number">2.7.</span> <span class="nav-text">client端的连接回调</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#继续AMS中的bindServiceLocked-方法"><span class="nav-number">2.8.</span> <span class="nav-text">继续AMS中的bindServiceLocked()方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AMS-publishService"><span class="nav-number">2.9.</span> <span class="nav-text">AMS.publishService()</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">3.</span> <span class="nav-text">总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Allen Wang</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






  





  

  

  

  

  

  

</body>
</html>
