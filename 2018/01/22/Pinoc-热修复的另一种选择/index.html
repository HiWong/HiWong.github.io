<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="hot_fix," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="引言从Qzone的超级补丁，阿里的AndFix, 到微信的Tinker再到美团的Robust,热修复经历了dex分包，方法hook到dex全量替换以及利用Instant Run原理往每个方法中插入一段跳转代码来实现，而这4种方法中，除了阿里的AndFix之外，其他三种都依赖DexClassLoader，这样做容易带来的问题有:  兼容性问题，比如国产手机厂商对于ROM进行了魔改，那么就可能会在某些">
<meta name="keywords" content="hot_fix">
<meta property="og:type" content="article">
<meta property="og:title" content="Pinoc:热修复的另一种可能性">
<meta property="og:url" content="http://yoursite.com/2018/01/22/Pinoc-热修复的另一种选择/index.html">
<meta property="og:site_name" content="AllenWang的个人博客">
<meta property="og:description" content="引言从Qzone的超级补丁，阿里的AndFix, 到微信的Tinker再到美团的Robust,热修复经历了dex分包，方法hook到dex全量替换以及利用Instant Run原理往每个方法中插入一段跳转代码来实现，而这4种方法中，除了阿里的AndFix之外，其他三种都依赖DexClassLoader，这样做容易带来的问题有:  兼容性问题，比如国产手机厂商对于ROM进行了魔改，那么就可能会在某些">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://yoursite.com/images/android/pinoc/pinoc_application.png">
<meta property="og:image" content="http://yoursite.com/images/android/pinoc/build_structure.png">
<meta property="og:image" content="http://yoursite.com/images/android/pinoc/runtime_config.png">
<meta property="og:image" content="http://yoursite.com/images/android/pinoc/pinoc_runtime.png">
<meta property="og:image" content="http://yoursite.com/images/android/pinoc/compiler_flow.png">
<meta property="og:image" content="http://yoursite.com/images/android/pinoc/Zlang_Compiler_flow.png">
<meta property="og:updated_time" content="2018-03-14T07:43:34.639Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Pinoc:热修复的另一种可能性">
<meta name="twitter:description" content="引言从Qzone的超级补丁，阿里的AndFix, 到微信的Tinker再到美团的Robust,热修复经历了dex分包，方法hook到dex全量替换以及利用Instant Run原理往每个方法中插入一段跳转代码来实现，而这4种方法中，除了阿里的AndFix之外，其他三种都依赖DexClassLoader，这样做容易带来的问题有:  兼容性问题，比如国产手机厂商对于ROM进行了魔改，那么就可能会在某些">
<meta name="twitter:image" content="http://yoursite.com/images/android/pinoc/pinoc_application.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/01/22/Pinoc-热修复的另一种选择/"/>





  <title>Pinoc:热修复的另一种可能性 | AllenWang的个人博客</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">AllenWang的个人博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">小楼一夜听春雨</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-ad">
          <a href="/ad/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            menu.ad
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/22/Pinoc-热修复的另一种选择/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Allen Wang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="AllenWang的个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Pinoc:热修复的另一种可能性</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-22T00:35:12+08:00">
                2018-01-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h3 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h3><p>从Qzone的超级补丁，阿里的AndFix, 到微信的Tinker再到美团的Robust,热修复经历了dex分包，方法hook到dex全量替换以及利用Instant Run原理往每个方法中插入一段跳转代码来实现，而这4种方法中，除了阿里的AndFix之外，其他三种都依赖DexClassLoader，这样做容易带来的问题有:</p>
<ul>
<li>兼容性问题，比如国产手机厂商对于ROM进行了魔改，那么就可能会在某些机型上失效甚至crash</li>
<li>审核无法通过的问题，由于国内应用商店其实还处于群龙无首的激烈竞争状态，所以一般国内的应用商店不会对App有太严格的审核要求，但是对于那些想要进入国外市场的App,则会遭遇到Google Play严苛的审核，其中热修复又是最为敏感的，而且DexClassLoader类也不可能进行混淆，所以很容易被扫描到。</li>
</ul>
<p>考虑到AndFix在5.0之后其实就已经由于ART的兼容性问题力不从心(虽然后面的Sophix在此基础上做了很多改进，但是在最新的系统上还是有一些兼容性问题)，如果想要实现稳定的热修复，同时又能够使App能够顺利通过Google Play的审核，有什么好的办法呢<a id="more"></a>?</p>
<p>今天要介绍的Pinoc,就通过<strong>精心设计的动态语言Zlang</strong>, 达到了上面的要求。</p>
<h3 id="Pinoc简介"><a href="#Pinoc简介" class="headerlink" title="Pinoc简介"></a>Pinoc简介</h3><p>Pinoc是一种新型的无需使用类加载器的动态代码修改方案，目前已经开源，github地址为 <a href="https://github.com/iqiyi/pinoc" target="_blank" rel="external">pinoc</a></p>
<p>Pinoc可以在Java方法入口处进行代码注入，对整个方法进行替换，也可以新增方法。</p>
<p>它的优点如下:</p>
<ul>
<li>提供一种无需ClassLoader进行类加载的热修复方案</li>
<li>提供一种新型的动态事件跟踪方案</li>
<li>兼容性强，能在任何基于Java虚拟机的平台上运行</li>
<li>实时生效，一旦读取配置文件便可以立即替换或修改对应方法</li>
</ul>
<p>Pinoc进行热修复的流程如下:</p>
<img src="/images/android/pinoc/pinoc_application.png">
<h3 id="使用及Demo"><a href="#使用及Demo" class="headerlink" title="使用及Demo"></a>使用及Demo</h3><p>使用Pinoc，请在<code>build.gradle</code>中添加如下代码：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">buildscript &#123;</div><div class="line">    repositories &#123;</div><div class="line">        jcenter()</div><div class="line">    &#125;</div><div class="line">    dependencies &#123;</div><div class="line">        classpath <span class="string">'com.iqiyi:pinoc-plugin:0.2.1'</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">apply <span class="string">plugin:</span> <span class="string">"pinoc"</span></div></pre></td></tr></table></figure>
<p>另外，你可以暂时禁用Pinoc，只需在项目或者模块的的<code>gradle.properties</code>中，添加如下配置：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pinoc-plugin.enabled=<span class="literal">false</span> <span class="comment">// default is true</span></div></pre></td></tr></table></figure>
<p>假设有如下代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">        Intent intent = getIntent();</div><div class="line">        TextView textView = (TextView) findViewById(com.iqiyi.pinocdemo.R.id.tv);</div><div class="line">        textView.setText(intent.getStringExtra(<span class="string">"tmp"</span>).toUpperCase());</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(com.iqiyi.pinocdemo.R.layout.activity_demo);</div><div class="line">        init();</div><div class="line">        findViewById(com.iqiyi.pinocdemo.R.id.bn).setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">                Toast.makeText(getApplicationContext(), <span class="string">"Click"</span>, Toast.LENGTH_SHORT).show();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上线后发现如下问题:</p>
<ul>
<li>init()方法中intent.getStringExtra(“tmp”)中的key有误，其实应该是”temp”</li>
<li>onClick()方法中忘了添加统计信息</li>
</ul>
<p>为了修复这个空指针错误为了修复这个空指针错误，同时为点击操作增加统计代码，使用Pinoc的话，只需要下发如下json信息:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">&#123;targets:[</div><div class="line">    &#123;class: "com/iqiyi/trojantest/DemoActivity", method_name: "init", method_sig: "()V", library: 0&#125;,</div><div class="line">    &#123;class: "com/iqiyi/trojantest/DemoActivity$1", method_name: "onClick", method_sig: "(Landroid/view/View;)V", library: 1&#125;</div><div class="line">],</div><div class="line">libraries:[</div><div class="line"><span class="string">"function main(className, methodName, methodSignature, this, parameters) \&#123;\</span></div><div class="line"><span class="string">   intent = _invoke_method(this, \"getIntent\");\</span></div><div class="line"><span class="string">   tmp = _invoke_public_method(intent, \"getStringExtra\", \"temp\");\</span></div><div class="line"><span class="string">   if (tmp != null) \&#123;\</span></div><div class="line"><span class="string">      textView = _invoke_method(this, \"findViewById\", _get_static_field(\"com.iqiyi.trojantest.R$id\", \"tv\"));\</span></div><div class="line"><span class="string">      _invoke_public_method(textView, \"setText\", _invoke_public_method(tmp, \"toUpperCase\"));\</span></div><div class="line"><span class="string">   \&#125;\</span></div><div class="line"><span class="string">   return null;\</span></div><div class="line">\&#125;",</div><div class="line"><span class="string">"function main(className, methodName, methodSignature, this, parameters) \&#123;\</span></div><div class="line"><span class="string">   context = get_outer_context(this);\</span></div><div class="line"><span class="string">   id = _invoke_public_method(parameters[0], \"getId\");\</span></div><div class="line"><span class="string">   track(_get_class_name(context), id);\</span></div><div class="line"><span class="string">\&#125;"</span></div><div class="line">]&#125;</div></pre></td></tr></table></figure>
<p>其中targets字段对应要修复的类名+方法名+签名，以及修复所使用的libraries字段数组中的index; 而libraries字段中就是修复所使用的Zlang代码，关于Zlang语言的介绍和原理在本文的后面分析，这里先讲解Pinoc的使用。</p>
<p>到这里可以看到，使用Pinoc进行热修复是极为方便和快捷的，而且可以不用担心兼容性问题。</p>
<p>可能对于业务方来说，唯一不便的地方就是Zlang的学习成本吧，不过Zlang是一种极为简单的动态语言，相信你们即使还没学习过它的语法，上面的代码也能看懂大半，实际上它的学习成本也很低，有一个学习就完全有搞定。</p>
<h3 id="Pinoc原理"><a href="#Pinoc原理" class="headerlink" title="Pinoc原理"></a>Pinoc原理</h3><p>Pinoc的原理为，在App构建的过程中，使用gradle插件将app中的每个Java方法都替换成它的变种方法(这一点其实跟Robust是一样的),如下图所示:</p>
<img src="/images/android/pinoc/build_structure.png">
<img src="/images/android/pinoc/runtime_config.png">
<p>经过gradle插件处理后的代码如下(以DemoActivity为例):</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (Pinoc.onEnterMethod(<span class="string">"com/iqiyi/pinocdemo/DemoActivity"</span>, <span class="string">"init"</span>, <span class="string">"()V"</span>, <span class="keyword">this</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]) == Library.NO_RETURN_VALUE) &#123;</div><div class="line">            ((TextView) findViewById(R.id.tv)).setText(getIntent().getStringExtra(<span class="string">"tmp"</span>).toUpperCase());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle bundle)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (Pinoc.onEnterMethod(<span class="string">"com/iqiyi/pinocdemo/DemoActivity"</span>, <span class="string">"onCreate"</span>, <span class="string">"(Landroid/os/Bundle;)V"</span>, <span class="keyword">this</span>, <span class="keyword">new</span> Object[]&#123;bundle&#125;) == Library.NO_RETURN_VALUE) &#123;</div><div class="line">            <span class="keyword">super</span>.onCreate(bundle);</div><div class="line">            setContentView((<span class="keyword">int</span>) R.layout.activity_demo);</div><div class="line">            init();</div><div class="line">            findViewById(R.id.bn).setOnClickListener(<span class="keyword">new</span> OnClickListener() &#123;</div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">                    <span class="keyword">if</span> (Pinoc.onEnterMethod(<span class="string">"com/iqiyi/pinocdemo/DemoActivity$1"</span>, <span class="string">"onClick"</span>, <span class="string">"(Landroid/view/View;)V"</span>, <span class="keyword">this</span>, <span class="keyword">new</span> Object[]&#123;view&#125;) == Library.NO_RETURN_VALUE) &#123;</div><div class="line">                        Toast.makeText(DemoActivity.<span class="keyword">this</span>.getApplicationContext(), <span class="string">"Click"</span>, <span class="number">0</span>).show();</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到，在app运行时，当一个方法被调用，实际上是调用了原始方法的变种方法，再由变种方法调用原始方法。不过在这之前，变种方法首先将原始方法的调用信息传给Pinoc,Pinoc根据配置文件决定是否替换或修改原始方法，这个配置文件可能是从服务器下发的。</p>
<img src="/images/android/pinoc/pinoc_runtime.png">
<p><strong>为避免Java类加载器产生的一些麻烦，Pinoc不采用Java的类加载器来执行方法的替换体或者修改体，所以方法的替换体或者修改体不是用Java语言编写的。它们是用<a href="https://github.com/Xiaofei-it/Zlang" target="_blank" rel="external">Zlang</a>编写的，Zlang是一种运行在Java虚拟机的动态灵活的编程语言，支持Java对象的调用，在运行时可以与Java环境交互</strong>。开发者可以轻易地将Java代码转化为Zlang代码。</p>
<p>所以在运行时，如果Pinoc决定修改或替换某个方法，它将方法的替代体或者修改体用Zlang编译器编译成Zlang字节码，传入Zlang执行器执行。这样替换体或者修改体就被执行了，原方法也被替换或修改了。</p>
<p>具体的实现在PinocCore的onEnterMethod()方法中:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="function">Object <span class="title">onEnterMethod</span><span class="params">(String className, String methodName, String methodSignature, Object thiz, Object[] parameters)</span> </span>&#123;</div><div class="line">       <span class="comment">//Logger.i(TAG, "enter " + className + " " + methodName + " " + methodSignature);</span></div><div class="line">       <span class="comment">// We can *not* append a target to the string because if the target class has override toString, it will cause a stack-over-flow.</span></div><div class="line">       ConcurrentHashMap&lt;String, LibraryWrapper&gt; libraries = mLibraries.get(className);</div><div class="line">       <span class="keyword">if</span> (libraries == <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">return</span> Library.NO_RETURN_VALUE;</div><div class="line">       &#125;</div><div class="line">       LibraryWrapper wrapper = libraries.get(getMethodId(methodName, methodSignature));</div><div class="line">       <span class="keyword">final</span> Library library = wrapper.mLibrary;</div><div class="line">       <span class="keyword">if</span> (library == <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">return</span> Library.NO_RETURN_VALUE;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">final</span> Object[] objects = <span class="keyword">new</span> Object[]&#123;className, methodName, methodSignature, thiz, parameters&#125;;</div><div class="line">       Callable callable = <span class="keyword">new</span> Callable() &#123;</div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> Object <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">               <span class="keyword">return</span> library.execute(<span class="string">"main"</span>, objects);</div><div class="line">           &#125;</div><div class="line">       &#125;;</div><div class="line"></div><div class="line">       Object result = Library.NO_RETURN_VALUE;</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           <span class="keyword">switch</span> (wrapper.mMode.getMode()) &#123;</div><div class="line">               <span class="keyword">case</span> ThreadMode.CURRENT:</div><div class="line">                   result = callable.call();</div><div class="line">                   <span class="keyword">break</span>;</div><div class="line">               <span class="keyword">case</span> ThreadMode.MAIN:</div><div class="line">                   result = Schedulers.MAIN.call(callable);</div><div class="line">                   <span class="keyword">break</span>;</div><div class="line">               <span class="keyword">case</span> ThreadMode.BACKGROUND:</div><div class="line">                   result = Schedulers.BACKGROUND.call(callable);</div><div class="line">                   <span class="keyword">break</span>;</div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">catch</span> (ZlangRuntimeException e) &#123;</div><div class="line">           Logger.e(TAG, <span class="string">"Execution error."</span>, e);</div><div class="line">           <span class="keyword">return</span> Library.NO_RETURN_VALUE;</div><div class="line">       &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">           Logger.e(TAG, <span class="string">"Unknown error."</span>, t);</div><div class="line">           <span class="keyword">return</span> Library.NO_RETURN_VALUE;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> result;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>这个方法的逻辑非常简单，就是将配置信息与当前方法信息进行对比，如果发现当前方法需要替换，就执行配置文件中的Zlang方法(都是main方法，所以是library.execute(“main”,objects))，同时，对于方法的执行，可以选择在当前线程、主线程和背景线程中执行。</p>
<p>至于其他读取配置信息之类的代码都很简单，就不赘述了，查看Pinoc的更多信息请访问：<a href="https://github.com/iqiyi/pinoc/blob/master/docs/pinoc_principle.md" target="_blank" rel="external">Pinoc 设计原理</a></p>
<h3 id="Zlang简介"><a href="#Zlang简介" class="headerlink" title="Zlang简介"></a>Zlang简介</h3><p>Zlang是一种运行于JVM上并且能够在运行时访问java对象的动态语言。它有如下特性:</p>
<ul>
<li>容易学习和使用</li>
<li>动态类型</li>
<li>能够在运行时与java交互，从而提供了无需classloader即可实现热修复的能力</li>
<li>在未来将支持函数式编程</li>
<li>未来将支持面向对象功能(目前跟C语言一样，只支持函数调用)</li>
</ul>
<p>目前Zlang已经开源，github地址为<a href="https://github.com/Xiaofei-it/Zlang" target="_blank" rel="external">Zlang</a></p>
<h3 id="Zlang使用"><a href="#Zlang使用" class="headerlink" title="Zlang使用"></a>Zlang使用</h3><h4 id="接入方式"><a href="#接入方式" class="headerlink" title="接入方式"></a>接入方式</h4><p>首先是添加gradle依赖:</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">compile <span class="string">'xiaofei.library:zlang:1.0.0'</span></div></pre></td></tr></table></figure>
<p>然后是构建library,在调用一个Zlang函数之前，需要先构建library:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Library library = <span class="keyword">new</span> Library.Builder()</div><div class="line">                    .addFunctions(<span class="string">"function f(a) &#123;return a + 1;&#125; function g(a) &#123;return a + 2;&#125;"</span>)</div><div class="line">                    .addFunctions(<span class="string">"function h(a) &#123;return a + 3;&#125;"</span>)</div><div class="line">                    .build();</div></pre></td></tr></table></figure>
<p>之后就可以开始调用了:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> a = (<span class="keyword">int</span>) library.execute(<span class="string">"f"</span>, <span class="keyword">new</span> Object[]&#123;<span class="number">3</span>&#125;);</div><div class="line">System.out.println(a);</div></pre></td></tr></table></figure>
<h4 id="基本语法"><a href="#基本语法" class="headerlink" title="基本语法"></a>基本语法</h4><p>如下是Zlang的Hello World：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function">function <span class="title">print_hello_world</span><span class="params">()</span></span>&#123;</div><div class="line">  println(<span class="string">"Hello World!"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到跟java的语法很相似。</p>
<p>如下是一个复杂一点的示例:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function">function <span class="title">sum</span><span class="params">(a, b)</span> </span>&#123;</div><div class="line">  result = <span class="number">0</span>;</div><div class="line">  <span class="keyword">for</span> i = a to b step <span class="number">1</span> &#123;</div><div class="line">    result = result + i;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function">function <span class="title">print_sum</span><span class="params">(a, b)</span> </span>&#123;</div><div class="line">  println(sum(a, b));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当然，对于递归也是支持的，如下是计算阶乘的方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function">function <span class="title">factorial</span><span class="params">(n)</span> </span>&#123;</div><div class="line">  <span class="keyword">if</span> (n == <span class="number">0</span>) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="keyword">return</span> n * factorial(n - <span class="number">1</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如下是一个二维数组的使用示例:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function">function <span class="title">max</span><span class="params">(arr)</span> </span>&#123;</div><div class="line">  len1 = _length(arr);</div><div class="line">  <span class="comment">/* Get the minimum integer. */</span></div><div class="line">  result = _get_static_field(<span class="string">"java.lang.Integer"</span>, <span class="string">"MIN_VALUE"</span>);</div><div class="line">  <span class="keyword">for</span> i = <span class="number">0</span> to len1 - <span class="number">1</span> step <span class="number">1</span> &#123;</div><div class="line">    len2 = _length(arr[i]);</div><div class="line">    <span class="keyword">for</span> j = <span class="number">0</span> to len2 - <span class="number">1</span> step <span class="number">1</span> &#123;</div><div class="line">      <span class="keyword">if</span> (arr[i][j] &gt; result) &#123;</div><div class="line">        result = arr[i][j];</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="java对象访问"><a href="#java对象访问" class="headerlink" title="java对象访问"></a>java对象访问</h4><p>如下是利用Zlang打印当前时间的方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function">function <span class="title">print_time</span><span class="params">()</span> </span>&#123;</div><div class="line">  calendar = _invoke_static_method(<span class="string">"java.util.Calendar"</span>, <span class="string">"getInstance"</span>);</div><div class="line">  format = _new_instance(<span class="string">"java.text.SimpleDateFormat"</span>, <span class="string">"yyyy-MM-dd"</span>);</div><div class="line">  println(_invoke_method(format, <span class="string">"format"</span>, _invoke_method(calendar, <span class="string">"getTime"</span>)));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>又比如，有如下类定义:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Foo</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">int</span> f;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fun</span><span class="params">()</span> </span>&#123;</div><div class="line">    Library library = <span class="keyword">new</span> Library.Builder()</div><div class="line">                        .addFunctions(ZlangFunctions.getFunction())</div><div class="line">                        .build();</div><div class="line">    library.execute(<span class="string">"dynamic_fun"</span>, <span class="keyword">new</span> Object[]&#123;<span class="keyword">this</span>&#125;);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在，我们可以通过修改dynamic_fun这个Zlang函数来达到动态修改Foo对象的目的:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function">function <span class="title">dynamic_fun</span><span class="params">(<span class="keyword">this</span>)</span> </span>&#123;</div><div class="line">  f = _get_field(<span class="keyword">this</span>, <span class="string">"f"</span>);</div><div class="line">  _set_field(<span class="keyword">this</span>, <span class="string">"f"</span>, f + <span class="number">1</span>);</div><div class="line">  println(<span class="string">"The value changes from "</span> + f + <span class="string">" to "</span> + (f + <span class="number">1</span>));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>这里，其实就是通过Zlang拥有热修复能力的原因。</strong></p>
<h3 id="Zlang编译器设计原理"><a href="#Zlang编译器设计原理" class="headerlink" title="Zlang编译器设计原理"></a>Zlang编译器设计原理</h3><h3 id="Zlang编译器简介"><a href="#Zlang编译器简介" class="headerlink" title="Zlang编译器简介"></a>Zlang编译器简介</h3><p>在讲Zlang之前，以一个简单的语句为例，看一下普通的编译器的编译流程:</p>
<img src="/images/android/pinoc/compiler_flow.png">
<p>可见，一个典型的编译器需要具备词法分析、语法分析、语义分析、中间代码生成、代码优化以及目标代码生成的功能。</p>
<p>而Zlang说白了就是一个栈指令解释器，在java运行时对Zlang代码进行编译，然后在执行时不断地从栈中取出指令进行执行。</p>
<p><strong>再加上Zlang目前只支持函数(不支持类和对象)调用，并且支持的文法也较简单，所以Zlang的实现也简单得多，把词法分析、语法分析和语义分析都融合在一起实现在Compiler类中，总代码量也就不到800行。</strong></p>
<h4 id="Zlang指令及符号表"><a href="#Zlang指令及符号表" class="headerlink" title="Zlang指令及符号表"></a>Zlang指令及符号表</h4><p>它有如下指令:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">enum</span> Fct &#123;</div><div class="line">    LIT,  <span class="comment">//常量，或者说字面值</span></div><div class="line">    LOD,  <span class="comment">//加载变量的指令，表示要加载变量到栈顶</span></div><div class="line">    ALOD,  <span class="comment">//将数组中的各元素加载到栈顶</span></div><div class="line">    STO,  <span class="comment">//栈顶值赋值给变量，注意，此时不弹栈顶</span></div><div class="line">    ASTO, <span class="comment">//将栈顶内容赋值给数组各元素</span></div><div class="line">    OPR,  <span class="comment">//操作符</span></div><div class="line">    INT,  <span class="comment">//活动记录分配栈空间</span></div><div class="line">    JMP, <span class="comment">//跳转指令</span></div><div class="line">    JPF, <span class="comment">//如果是false就跳转</span></div><div class="line">    JPF_SC, <span class="comment">// Short circuit,SC就是short circuit的缩写，表示短路计算</span></div><div class="line">    JPT_SC, <span class="comment">// Short circuit</span></div><div class="line">    FUN,    <span class="comment">//方法调用</span></div><div class="line">    PROC,  <span class="comment">//产生式</span></div><div class="line">    FUN_RETURN, <span class="comment">//返回值</span></div><div class="line">    VOID_RETURN, <span class="comment">//无返回值</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>而符号表如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">enum</span> Symbol &#123;</div><div class="line">    END,</div><div class="line">    FUNCTION,</div><div class="line">    IF,</div><div class="line">    ELSE,</div><div class="line">    WHILE,</div><div class="line">    FOR,</div><div class="line">    TO,</div><div class="line">    STEP,</div><div class="line">    BREAK,</div><div class="line">    CONTINUE,</div><div class="line">    RETURN,</div><div class="line">    ID,</div><div class="line">    BOOLEAN,</div><div class="line">    NULL,</div><div class="line">    NUMBER,</div><div class="line">    CHARACTER,</div><div class="line">    STRING,</div><div class="line">    LESS_EQUAL,</div><div class="line">    LESS,</div><div class="line">    GREATER_EQUAL,</div><div class="line">    GREATER,</div><div class="line">    EQUAL,</div><div class="line">    ASSIGN,</div><div class="line">    NOT_EQUAL,</div><div class="line">    NOT,</div><div class="line">    AND,</div><div class="line">    OR,</div><div class="line">    COMMA,</div><div class="line">    SEMICOLON,</div><div class="line">    LEFT_PARENTHESIS, <span class="comment">//左圆括号</span></div><div class="line">    RIGHT_PARENTHESIS, <span class="comment">//右圆括号</span></div><div class="line">    LEFT_BRACE, <span class="comment">// &#123;</span></div><div class="line">    RIGHT_BRACE,</div><div class="line">    LEFT_BRACKET, <span class="comment">// [</span></div><div class="line">    RIGHT_BRACKET,</div><div class="line">    PLUS,</div><div class="line">    MINUS,</div><div class="line">    TIMES,  <span class="comment">//乘法</span></div><div class="line">    DIVIDE,  <span class="comment">//除法</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>与符号表对应的保留字如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> HashMap&lt;String, Symbol&gt; RESERVED_WORDS_SYMBOLS = <span class="keyword">new</span> HashMap&lt;String, Symbol&gt;() &#123;</div><div class="line">        &#123;</div><div class="line">            put(<span class="string">"END"</span>, Symbol.END);</div><div class="line">            put(<span class="string">"function"</span>, Symbol.FUNCTION);</div><div class="line">            put(<span class="string">"if"</span>, Symbol.IF);</div><div class="line">            put(<span class="string">"else"</span>, Symbol.ELSE);</div><div class="line">            put(<span class="string">"while"</span>, Symbol.WHILE);</div><div class="line">            put(<span class="string">"for"</span>, Symbol.FOR);</div><div class="line">            put(<span class="string">"to"</span>, Symbol.TO);</div><div class="line">            put(<span class="string">"step"</span>, Symbol.STEP);</div><div class="line">            put(<span class="string">"break"</span>, Symbol.BREAK);</div><div class="line">            put(<span class="string">"continue"</span>,Symbol.CONTINUE);</div><div class="line">            put(<span class="string">"return"</span>, Symbol.RETURN);</div><div class="line">        &#125;</div><div class="line">    &#125;;</div></pre></td></tr></table></figure>
<h4 id="Zlang文法"><a href="#Zlang文法" class="headerlink" title="Zlang文法"></a>Zlang文法</h4><p>Zlang目前支持的文法如下:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">or_expression = and_exp || and_exp</div><div class="line"> </div><div class="line">and_exp = comparison_exp &amp;&amp; comparison_exp</div><div class="line"> </div><div class="line">comparison_exp = numeric_exp &gt; numeric_exp</div><div class="line"> </div><div class="line">numeric_exp = term + term</div><div class="line"> </div><div class="line">term = factor * factor</div></pre></td></tr></table></figure>
<p>是很典型的上下文无关文法，显然文法支持了或语句、与语句、比较语句、四则运算。</p>
<h4 id="Zlang编译过程分析"><a href="#Zlang编译过程分析" class="headerlink" title="Zlang编译过程分析"></a>Zlang编译过程分析</h4><p>其实确定了文法，编译过程的分析就简单了，至少词法分析是有迹可循的。</p>
<p>入口是compile()方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">compile</span><span class="params">()</span> </span>&#123;</div><div class="line">        program += <span class="string">"END "</span>;</div><div class="line">        <span class="keyword">do</span> &#123;</div><div class="line">            function();</div><div class="line">            <span class="keyword">if</span> (nextSymbol == Symbol.END) &#123;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nextSymbol != Symbol.FUNCTION) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> CompileException(CompileError.MISSING_SYMBOL, linePos == <span class="number">0</span> ? lineNumber - <span class="number">1</span> : lineNumber, previousLinePos, <span class="string">"function"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">while</span> (<span class="keyword">true</span>);</div><div class="line"><span class="comment">//        library.compileDependencies();</span></div><div class="line">        <span class="keyword">for</span> (FunctionWrapper functionWrapper : neededFunctions) &#123;</div><div class="line">            <span class="keyword">if</span> (!library.containsFunction(functionWrapper.functionName, functionWrapper.parameterNumber)) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> CompileException(</div><div class="line">                        CompileError.UNDEFINED_FUNCTION, linePos == <span class="number">0</span> ? lineNumber - <span class="number">1</span> : lineNumber, previousLinePos,</div><div class="line">                        <span class="string">"Function name: "</span> + functionWrapper.functionName</div><div class="line">                                + <span class="string">" Parameter number: "</span> + functionWrapper.parameterNumber);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>这个方法很简单，就是循环地调用function()来编译Zlang代码中的各个函数，直到遇到结束符。</p>
<p>function()方法则稍微复杂一些，代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">function</span><span class="params">()</span> </span>&#123;</div><div class="line">	breakRecorder.init();</div><div class="line">       continueRecorder.init();</div><div class="line">       symbolTable.clear();</div><div class="line">       codes = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">       codeIndex = -<span class="number">1</span>;</div><div class="line">       <span class="keyword">if</span> (nextSymbol == <span class="keyword">null</span>) &#123;</div><div class="line">           moveToNextSymbol(); <span class="comment">//获取第一个符号，要求必须是Symbol.FUNCTION</span></div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (nextSymbol != Symbol.FUNCTION) &#123; <span class="comment">//第一个符号必须是Symbol.FUNCTION,因为目前Zlang只支持函数</span></div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> CompileException(CompileError.MISSING_SYMBOL, linePos == <span class="number">0</span> ? lineNumber - <span class="number">1</span> : lineNumber, previousLinePos, <span class="string">"function"</span>);</div><div class="line">       &#125;</div><div class="line">       moveToNextSymbol();  <span class="comment">//获取第二个符号，要求必须是函数名</span></div><div class="line">       <span class="keyword">if</span> (nextSymbol != Symbol.ID) &#123;  <span class="comment">//第二个符号必须是ID(其实是必须为函数名),注意ID包含函数名，变量名等</span></div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> CompileException(CompileError.ILLEGAL_SYMBOL, linePos == <span class="number">0</span> ? lineNumber - <span class="number">1</span> : lineNumber, previousLinePos, <span class="string">""</span> + nextSymbol);</div><div class="line">       &#125;</div><div class="line">       String functionName = (String) nextObject;</div><div class="line">       moveToNextSymbol();</div><div class="line">       <span class="keyword">int</span> parameterNumber = <span class="number">0</span>;</div><div class="line">       offset = -<span class="number">1</span>;</div><div class="line">       <span class="keyword">if</span> (nextSymbol == Symbol.LEFT_PARENTHESIS) &#123; <span class="comment">//函数名之后的下一个符号必须是左括号，如果不是就要抛异常</span></div><div class="line">           moveToNextSymbol();</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> CompileException(CompileError.MISSING_SYMBOL, linePos == <span class="number">0</span> ? lineNumber - <span class="number">1</span> : lineNumber, previousLinePos, <span class="string">"("</span>);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">while</span> (nextSymbol != Symbol.RIGHT_PARENTHESIS) &#123; <span class="comment">//函数名--&gt;左括号--&gt;参数名或右括号，所以如果不是右括号的话就必须是变量定义</span></div><div class="line">           <span class="keyword">if</span> (nextSymbol != Symbol.ID) &#123;</div><div class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> CompileException(CompileError.ILLEGAL_SYMBOL, linePos == <span class="number">0</span> ? lineNumber - <span class="number">1</span> : lineNumber, previousLinePos, <span class="string">""</span> + nextSymbol);</div><div class="line">           &#125;</div><div class="line">           String id = (String) nextObject;</div><div class="line">           ++parameterNumber;</div><div class="line">           ++offset;</div><div class="line">           symbolTable.put(id, offset);  <span class="comment">//将这个参数放入符号表，比如参数a</span></div><div class="line">           moveToNextSymbol();</div><div class="line">           <span class="keyword">if</span> (nextSymbol != Symbol.RIGHT_PARENTHESIS &amp;&amp; nextSymbol != Symbol.COMMA) &#123; <span class="comment">//下一个符号只能是逗号，右括号或参数名中的一个，如果都不是就抛出异常</span></div><div class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> CompileException(CompileError.MISSING_SYMBOL, linePos == <span class="number">0</span> ? lineNumber - <span class="number">1</span> : lineNumber, previousLinePos, <span class="string">") or ,"</span>);</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">if</span> (nextSymbol == Symbol.COMMA) &#123; <span class="comment">//如果是逗号，就读取下一个符号(其实是下一个参数)</span></div><div class="line">               moveToNextSymbol();</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       moveToNextSymbol(); <span class="comment">//读取大括号</span></div><div class="line">       generateCode(Fct.INT, <span class="number">0</span>);  <span class="comment">//函数开始处，操作数为0</span></div><div class="line">       <span class="keyword">int</span> tmp = codeIndex;</div><div class="line">       statement(<span class="keyword">false</span>);</div><div class="line">       generateCode(Fct.VOID_RETURN, <span class="number">0</span>); <span class="comment">//函数执行完，操作数归0</span></div><div class="line">       modifyCodeOperand(tmp, offset + <span class="number">1</span>);</div><div class="line">       library.put(functionName, parameterNumber, codes);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>结合我在代码中的注释，其实就很好理解了，function()中主要做了以下几件事:</p>
<ul>
<li>首先是一些变量(比如符号表)的初始化</li>
<li>然后读取第一个符号，这个符号如果不是Symbol.FUNCTION的话，就不符合Zlang的文法了，从而抛出异常</li>
<li>然后读取第二个符号，这个符号只能是函数名(所以必须是Symbol.ID类型)，否则便违反了Zlang的文法</li>
<li>再读取第三个符号，类似地，必须是左圆括号</li>
<li>之后在遇到右圆括号之前，循环读取函数参数</li>
<li>之后读取大括号，并且产生Fct.INT这个指令，表示需要分配空间</li>
<li>在大括号内部的就是Zlang语句了，所以后面进入statement()中</li>
<li>所有语句分析完成之后，产生一个Fct.VOID_RETURN指令(如果有返回值，会在这之前产生Fct.FUN_RETURN指令)</li>
<li>最后是将编译结果codes存储到library中</li>
</ul>
<p>function()是Compiler中最核心的一个方法，这个方法分析完之后，后面的流程从statement()出发，很容易就能梳理出来，这里不再赘述。</p>
<p>如下是编译过程的主流程图:</p>
<img src="/images/android/pinoc/Zlang_Compiler_flow.png">
<p>其中function()在前面分析过，而<strong>statement()方法最终会调用到comparisonExpression(), numericExpression(), term()和factor()方法，这4个方法和前面提到的文法相对应。</strong></p>
<p>到这里，编译流程就基本梳理完毕了，可以看到Zlang使用极简的代码就实现了一个自顶向下的LL(2)编译器。</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/hot-fix/" rel="tag"># hot_fix</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/12/22/Annotation-Processing-101-译文/" rel="next" title="Annotation Processing 101 译文">
                <i class="fa fa-chevron-left"></i> Annotation Processing 101 译文
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/02/07/SkipList的原理与实现/" rel="prev" title="SkipList的原理与实现">
                SkipList的原理与实现 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="Allen Wang" />
          <p class="site-author-name" itemprop="name">Allen Wang</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">150</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">25</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">8</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#引言"><span class="nav-number">1.</span> <span class="nav-text">引言</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Pinoc简介"><span class="nav-number">2.</span> <span class="nav-text">Pinoc简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用及Demo"><span class="nav-number">3.</span> <span class="nav-text">使用及Demo</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Pinoc原理"><span class="nav-number">4.</span> <span class="nav-text">Pinoc原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Zlang简介"><span class="nav-number">5.</span> <span class="nav-text">Zlang简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Zlang使用"><span class="nav-number">6.</span> <span class="nav-text">Zlang使用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#接入方式"><span class="nav-number">6.1.</span> <span class="nav-text">接入方式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#基本语法"><span class="nav-number">6.2.</span> <span class="nav-text">基本语法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#java对象访问"><span class="nav-number">6.3.</span> <span class="nav-text">java对象访问</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Zlang编译器设计原理"><span class="nav-number">7.</span> <span class="nav-text">Zlang编译器设计原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Zlang编译器简介"><span class="nav-number">8.</span> <span class="nav-text">Zlang编译器简介</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Zlang指令及符号表"><span class="nav-number">8.1.</span> <span class="nav-text">Zlang指令及符号表</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Zlang文法"><span class="nav-number">8.2.</span> <span class="nav-text">Zlang文法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Zlang编译过程分析"><span class="nav-number">8.3.</span> <span class="nav-text">Zlang编译过程分析</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Allen Wang</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






  





  

  

  

  

  

  

</body>
</html>
