<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta property="og:type" content="website">
<meta property="og:title" content="AllenWang的个人博客">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="AllenWang的个人博客">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="AllenWang的个人博客">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>AllenWang的个人博客</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">AllenWang的个人博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">小楼一夜听春雨</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/22/关于注解你需要知道的一切/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Allen Wang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="AllenWang的个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/22/关于注解你需要知道的一切/" itemprop="url">关于注解你需要知道的一切</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-22T14:41:26+08:00">
                2017-12-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h3><p>还是在两年前看的一篇关于注解的文章，当时看的时候惊为天人，因为确实是把几乎所有注解的用法都总结好了。正好最近又要用到，就先引用一下，后面有时间再翻译。</p>
<p>原文出自 <a href="http://hannesdorfmann.com/annotation-processing/annotationprocessing101" target="_blank" rel="external">Annotation Processing 101</a> ,由于是2015 的droidcon上的一个话题，所以还有相应的视频，作者在视频里有详细的讲解，有梯子的小伙伴可以看下视频: <a href="https://youtu.be/43FFfTyDYEg" target="_blank" rel="external">Hannes Dorfmann-AnnotationProcessing 101</a>.</p>
<p>如下是blog正文&lt;!—more—&gt;。</p>
<h3 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h3><p>In this blog entry I would like to explain how to write an annotation processor. So here is my tutorial. First, I am going to explain to you what annotation processing is, what you can do with that powerful tool and finally what you cannot do with it. In a second step we will implement a simple annotation processor step by step.</p>
<h3 id="The-Basics"><a href="#The-Basics" class="headerlink" title="The Basics"></a>The Basics</h3><p>To clarify a very important thing from the very beginning: we are not talking about evaluating annotations by using reflections at runtime (run time = the time when the application runs). Annotation processing takes place at compile time (compile time = the time when the java compiler compiles your java source code).</p>
<p>Annotation processing is a tool build in javac for scanning and processing annotations <strong>at compile time</strong>. You can register your own annotation processor for certain annotations. At this point I assume that you already know what an annotation is and how to declare an annotation type. If you are not familar with annotations you can find more information in the <a href="http://docs.oracle.com/javase/tutorial/java/annotations/index.html" target="_blank" rel="external">official java documentation</a>. Annotation processing is already available since Java 5 but a useable API is available since Java 6 (released in December 2006). It took some time until the java world realized the power of annotation processing. So it has become popular in the last few years.</p>
<p>An annotation processor for a certain annotation takes java code (or compiled byte code) as input and generate files (usually .java files) as output. What does that exactly means? You can generate java code! The generated java code is in a generated <strong>.java</strong> file. So you <strong>can not</strong>manipulate an existing java class for instance adding a method. The generated java file will be compiled by javac as any other hand written java source file.</p>
<h3 id="AbstractProcessor"><a href="#AbstractProcessor" class="headerlink" title="AbstractProcessor"></a>AbstractProcessor</h3><p>Let’s have a look at the Processor API. Every Processor extends from <strong>AbstractProcessor</strong> as follows:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.example;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyProcessor</span> <span class="keyword">extends</span> <span class="title">AbstractProcessor</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ProcessingEnvironment env)</span></span>&#123; &#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; annoations, RoundEnvironment env)</span> </span>&#123; &#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">getSupportedAnnotationTypes</span><span class="params">()</span> </span>&#123; &#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> SourceVersion <span class="title">getSupportedSourceVersion</span><span class="params">()</span> </span>&#123; &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><strong>init(ProcessingEnvironment env)</strong>: Every annotation processor class <strong>must have an empty constructor</strong>. However, there is a special init() method which is invoked by the annotation processing tool with the <strong>ProcessingEnviroment</strong> as parameter. The ProcessingEnviroment provides some useful util classes <strong>Elements</strong>, <strong>Types</strong> and <strong>Filer</strong>. We will use them later.</li>
<li><strong>process(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment env)</strong>: This is kind of <strong>main()</strong> method of each processor. Here you write your code for scanning, evaluating and processing annotations and generating java files. With <strong>RoundEnviroment</strong>passed as parameter you can query for elements annotated with a certain annotation as we will see later.</li>
<li><strong>getSupportedAnnotationTypes()</strong>: Here you have to specify for which annotations this annotation processor should be registered for. Note that the return type is a set of strings containing full qualified names for your annotation types you want to process with this annotation processor. In other words, you define here for which annotations you register your annotation processor.</li>
<li><strong>getSupportedSourceVersion()</strong>: Used to specify which java version you use. Usually you will return <strong>SourceVersion.latestSupported()</strong>. However, you could also return <strong>SourceVersion.RELEASE_6</strong> if you have good reasons for stick with Java 6. I recommend to use <strong>SourceVersion.latestSupported();</strong></li>
</ul>
<p>With Java 7 you could also use annotations instead of overriding <strong>getSupportedAnnotationTypes()</strong> and <strong>getSupportedSourceVersion()</strong> like that:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@SupportedSourceVersion</span>(SourceVersion.latestSupported())</div><div class="line"><span class="meta">@SupportedAnnotationTypes</span>(&#123;</div><div class="line">   <span class="comment">// Set of full qullified annotation type names</span></div><div class="line"> &#125;)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyProcessor</span> <span class="keyword">extends</span> <span class="title">AbstractProcessor</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ProcessingEnvironment env)</span></span>&#123; &#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; annoations, RoundEnvironment env)</span> </span>&#123; &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>For compatibility reasons, especially for android, I recommend to override <strong>getSupportedAnnotationTypes()</strong> and <strong>getSupportedSourceVersion()</strong> instead of using <strong>@SupportedAnnotationTypes</strong> and <strong>@SupportedSourceVersion</strong></p>
<p>The next thing you have to know is that the annotation processor runs in it’s own jvm. Yes you read correctly. javac starts a complete java virtual machine for running annotation processors. So what that means for you? You can use anything you would use in any other java application. Use guava! If you want to you can use dependency injection tools like dagger or any other library you want to. But don’t forget. Even if it’s just a small processor you should take care about efficient algorithms and design patterns like you would do for any other java application.</p>
<h1 id="Register-Your-Processor"><a href="#Register-Your-Processor" class="headerlink" title="Register Your Processor"></a>Register Your Processor</h1><p>You may ask yourself <em>“How do I register MyProcessor to javac?”</em>. You have to provide a <strong>.jar</strong>file. Like any other .jar file you pack your (compiled) annotation processor in that file. Furthermore you also have to pack a special file called <strong>javax.annotation.processing.Processor</strong> located in <strong>META-INF/services</strong> in your .jar file. So the content of your .jar file looks like this:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">MyProcessor.jar</div><div class="line">	- com</div><div class="line">		- example</div><div class="line">			- MyProcessor.class</div><div class="line"></div><div class="line">	- META-INF</div><div class="line">		- services</div><div class="line">			- javax.annotation.processing.Processor</div></pre></td></tr></table></figure>
<p>The content of the file <strong>javax.annotation.processing.Processor</strong> (packed in MyProcessor.jar) is a list with full qualified class names to the processors with new line as delimiter:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">com.example.MyProcessor</div><div class="line">com.foo.OtherProcessor</div><div class="line">net.blabla.SpecialProcessor</div></pre></td></tr></table></figure>
<p>With <strong>MyProcessor.jar</strong> in your buildpath javac automatically detects and reads the <strong>javax.annotation.processing.Processor</strong> file and registers <strong>MyProcessor</strong> as annotation processor.</p>
<h1 id="Example-Factory-Pattern"><a href="#Example-Factory-Pattern" class="headerlink" title="Example: Factory Pattern"></a>Example: Factory Pattern</h1><p>It’s time to for a concrete example. We will use maven as our build system and dependency management tool. If you are not familiar with maven, don’t worry maven is not necessary. The whole code can be found <a href="https://github.com/sockeqwe/annotationprocessing101" target="_blank" rel="external">on github</a>.</p>
<p>First of all I have to say, that it’s not so easy to find a simple problem for a tutorial that we can solve with an annotation processor. Here we gonna implement a very simple factory pattern (not abstract factory pattern). It should give you just a brief introduction on the annotation processing API. So the problem statement may be a little bit dump and not a real world one. Once again, you will learn about annotation processing and not about design patterns.</p>
<p>So here is the problem: We want to implement a pizza store. The pizza store offers to it’s customers 2 Pizzas (“Margherita” and “Calzone”) and Tiramisu for dessert.</p>
<p>Have a look at this code snippets, which should not need any further explanation:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Meal</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getPrice</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MargheritaPizza</span> <span class="keyword">implements</span> <span class="title">Meal</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getPrice</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="number">6.0f</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CalzonePizza</span> <span class="keyword">implements</span> <span class="title">Meal</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getPrice</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="number">8.5f</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Tiramisu</span> <span class="keyword">implements</span> <span class="title">Meal</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getPrice</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="number">4.5f</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>To order in our <strong>PizzaStore</strong> the customer has to enter the name of the meal:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PizzaStore</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> Meal <span class="title">order</span><span class="params">(String mealName)</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (mealName == <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Name of the meal is null!"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="string">"Margherita"</span>.equals(mealName)) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> MargheritaPizza();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="string">"Calzone"</span>.equals(mealName)) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> CalzonePizza();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="string">"Tiramisu"</span>.equals(mealName)) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> Tiramisu();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unknown meal '"</span> + mealName + <span class="string">"'"</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    PizzaStore pizzaStore = <span class="keyword">new</span> PizzaStore();</div><div class="line">    Meal meal = pizzaStore.order(readConsole());</div><div class="line">    System.out.println(<span class="string">"Bill: $"</span> + meal.getPrice());</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>As you see, we have a lot of <em>if statements</em> in the <strong>order()</strong> method and whenever we add a new type of pizza we have to add a new if statement. But wait, with annotation processing and the factory pattern we can let an annotation processor generate this <em>if statements</em>. So what we want to have is something like that:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PizzaStore</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> MealFactory factory = <span class="keyword">new</span> MealFactory();</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> Meal <span class="title">order</span><span class="params">(String mealName)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> factory.create(mealName);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    PizzaStore pizzaStore = <span class="keyword">new</span> PizzaStore();</div><div class="line">    Meal meal = pizzaStore.order(readConsole());</div><div class="line">    System.out.println(<span class="string">"Bill: $"</span> + meal.getPrice());</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>The <strong>MealFactory</strong> should look as follows:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MealFactory</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> Meal <span class="title">create</span><span class="params">(String id)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (id == <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"id is null!"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (<span class="string">"Calzone"</span>.equals(id)) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> CalzonePizza();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="string">"Tiramisu"</span>.equals(id)) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> Tiramisu();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="string">"Margherita"</span>.equals(id)) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> MargheritaPizza();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unknown id = "</span> + id);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Factory-Annotation"><a href="#Factory-Annotation" class="headerlink" title="@Factory Annotation"></a>@Factory Annotation</h2><p>Guess what: We want to generate the <strong>MealFactory</strong> by using annotation processing. To be more general, we want to provide an annotation and a processor for generating factory classes.</p>
<p>Let’s have a look at the <strong>@Factory</strong> annotation:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Target</span>(ElementType.TYPE) <span class="meta">@Retention</span>(RetentionPolicy.CLASS)</div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Factory &#123;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * The name of the factory</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="function">Class <span class="title">type</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * The identifier for determining which item should be instantiated</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="function">String <span class="title">id</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>The idea is that we annotate classes which should belong to the same factory with the same <strong>type()</strong> and with <strong>id()</strong> we do the mapping from <strong>“Calzone”</strong> to <strong>CalzonePizza</strong> class. Let’s apply <strong>@Factory</strong> to our classes:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Factory</span>(</div><div class="line">    id = <span class="string">"Margherita"</span>,</div><div class="line">    type = Meal.class</div><div class="line">)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MargheritaPizza</span> <span class="keyword">implements</span> <span class="title">Meal</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getPrice</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="number">6f</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Factory</span>(</div><div class="line">    id = <span class="string">"Calzone"</span>,</div><div class="line">    type = Meal.class</div><div class="line">)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CalzonePizza</span> <span class="keyword">implements</span> <span class="title">Meal</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getPrice</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="number">8.5f</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Factory</span>(</div><div class="line">    id = <span class="string">"Tiramisu"</span>,</div><div class="line">    type = Meal.class</div><div class="line">)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Tiramisu</span> <span class="keyword">implements</span> <span class="title">Meal</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getPrice</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="number">4.5f</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>You may ask yourself if we could just apply <strong>@Factory</strong> on the <strong>Meal</strong> interface. Annotations are not inherited. Annotating <strong>class X</strong> with an annotation does not mean that <strong>class Y extends X</strong>is automatically annotated. Before we start writing the processor code we have to specify some rules:</p>
<ol>
<li>Only classes can be annotated with <strong>@Factory</strong> since interfaces or abstract classes can not be instantiated with the <strong>new</strong> operator.</li>
<li>Classes annotated with <strong>@Factory</strong> must provide at least one public empty default constructor (parameterless). Otherwise we could not instantiate a new instance.</li>
<li>Classes annotated with <strong>@Factory</strong> must inherit directly or indirectly from the specified <strong>type</strong> (or implement it if it’s an interface).</li>
<li><strong>@Factory</strong> annotations with the same <strong>type</strong> are grouped together and one Factory class will be generated. The name of the generated class has <em>“Factory”</em> as suffix, for example <strong>type = Meal.class</strong> will generate <strong>MealFactory</strong></li>
<li><strong>id</strong> are limited to Strings and must be unique in it’s type group.</li>
</ol>
<h2 id="The-Processor"><a href="#The-Processor" class="headerlink" title="The Processor"></a>The Processor</h2><p>I will guide you step by step by adding line of code followed by an explanation paragraph. Three dots (<strong>…</strong>) means that code is omitted either was discussed in the paragraph before or will be added later as next step. Goal is to make the snipped more readable. As already mentioned above the complete code can be found <a href="https://github.com/sockeqwe/annotationprocessing101" target="_blank" rel="external">on github</a>. Ok lets start with the skeleton of our <strong>FactoryProcessor</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@AutoService</span>(Processor.class)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FactoryProcessor</span> <span class="keyword">extends</span> <span class="title">AbstractProcessor</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> Types typeUtils;</div><div class="line">  <span class="keyword">private</span> Elements elementUtils;</div><div class="line">  <span class="keyword">private</span> Filer filer;</div><div class="line">  <span class="keyword">private</span> Messager messager;</div><div class="line">  <span class="keyword">private</span> Map&lt;String, FactoryGroupedClasses&gt; factoryClasses = <span class="keyword">new</span> LinkedHashMap&lt;String, FactoryGroupedClasses&gt;();</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ProcessingEnvironment processingEnv)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.init(processingEnv);</div><div class="line">    typeUtils = processingEnv.getTypeUtils();</div><div class="line">    elementUtils = processingEnv.getElementUtils();</div><div class="line">    filer = processingEnv.getFiler();</div><div class="line">    messager = processingEnv.getMessager();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">getSupportedAnnotationTypes</span><span class="params">()</span> </span>&#123;</div><div class="line">    Set&lt;String&gt; annotataions = <span class="keyword">new</span> LinkedHashSet&lt;String&gt;();</div><div class="line">    annotataions.add(Factory.class.getCanonicalName());</div><div class="line">    <span class="keyword">return</span> annotataions;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> SourceVersion <span class="title">getSupportedSourceVersion</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> SourceVersion.latestSupported();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment roundEnv)</span> </span>&#123;</div><div class="line">	...</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>In the first line you see <strong>@AutoService(Processor.class)</strong>. What’s that? It’s an annotation from another annotation processor. This <strong>AutoService</strong> annotation processor has been developed by Google and generates the <strong>META-INF/services/javax.annotation.processing.Processor</strong>file. Yes, you read correctly. We can use annotation processors in our annotation processor. Handy, isn’t it? In <strong>getSupportedAnnotationTypes()</strong> we specify that <strong>@Factory</strong> is processed by this processor.</p>
<h2 id="Elements-and-TypeMirrors"><a href="#Elements-and-TypeMirrors" class="headerlink" title="Elements and TypeMirrors"></a>Elements and TypeMirrors</h2><p>In <strong>init()</strong> we retrieve a reference to</p>
<ul>
<li><strong>Elements</strong>: A utils class to work with <strong>Element</strong> classes (more information later).</li>
<li><strong>Types</strong>: A utils class to work with <strong>TypeMirror</strong> (more information later)</li>
<li><strong>Filer</strong>: Like the name suggests with Filer you can create files.</li>
</ul>
<p>In annotation processing we are scanning java source code files. Every part of the source code is a certain type of <strong>Element</strong>. In other words: <strong>Element</strong> represents a program element such as a package, class, or method. Each element represents a static, language-level construct. In the following example I have added comments to clarify that:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.example;	<span class="comment">// PackageElement</span></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Foo</span> </span>&#123;		<span class="comment">// TypeElement</span></div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">int</span> a;		<span class="comment">// VariableElement</span></div><div class="line">	<span class="keyword">private</span> Foo other; 	<span class="comment">// VariableElement</span></div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Foo</span> <span class="params">()</span> </span>&#123;&#125; 	<span class="comment">// ExecuteableElement</span></div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setA</span> <span class="params">( 	// ExecuteableElement</span></span></div><div class="line"><span class="function"><span class="params">	                 <span class="keyword">int</span> newA	// TypeElement</span></span></div><div class="line"><span class="function"><span class="params">	                 )</span> </span>&#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>You have to change the way you see source code. It’s just structured text. It’s not executable. You can think of it like a XML file you try to parse (or an abstract syntax tree in compiler construction). Like in XML parsers there is some kind of DOM with elements. You can navigate from Element to it’s parent or child Element.</p>
<p>For instance if you have a <strong>TypeElement</strong> representing <strong>public class Foo</strong> you could iterate over its children like that:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">TypeElement fooClass = ... ;</div><div class="line"><span class="keyword">for</span> (Element e : fooClass.getEnclosedElements())&#123; <span class="comment">// iterate over children</span></div><div class="line">	Element parent = e.getEnclosingElement();  <span class="comment">// parent == fooClass</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>As you see Elements are representing source code. TypeElement represent type elements in the source code like classes. However, TypeElement does not contain information about the class itself. From TypeElement you will get the name of the class, but you will not get information about the class like the superclass. This is kind of information are accessible through a <strong>TypeMirror</strong>. You can access the TypeMirror of an Element by calling <strong>element.asType()</strong>.</p>
<h2 id="Searching-For-Factory"><a href="#Searching-For-Factory" class="headerlink" title="Searching For @Factory"></a>Searching For @Factory</h2><p>So lets implement the <strong>process()</strong> method step by step. First we start with searching for classes annotated with <strong>@Factory</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@AutoService</span>(Processor.class)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FactoryProcessor</span> <span class="keyword">extends</span> <span class="title">AbstractProcessor</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> Types typeUtils;</div><div class="line">  <span class="keyword">private</span> Elements elementUtils;</div><div class="line">  <span class="keyword">private</span> Filer filer;</div><div class="line">  <span class="keyword">private</span> Messager messager;</div><div class="line">  <span class="keyword">private</span> Map&lt;String, FactoryGroupedClasses&gt; factoryClasses = <span class="keyword">new</span> LinkedHashMap&lt;String, FactoryGroupedClasses&gt;();</div><div class="line">	...</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment roundEnv)</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// Itearate over all @Factory annotated elements</span></div><div class="line">    <span class="keyword">for</span> (Element annotatedElement : roundEnv.getElementsAnnotatedWith(Factory.class)) &#123;</div><div class="line">  		...</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line"> ...</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>No rocket science here. <strong>roundEnv.getElementsAnnotatedWith(Factory.class))</strong> returnes a list of Elements annotated with <strong>@Factory</strong>. You may have noted that I have avoited saying <em>“returns list of classes annotated with @Factory”</em>, because it really returns list of <strong>Element</strong>. Remember: <strong>Element</strong> can be a class, method, variable etc. So what we have to do next is to check if the Element is a class:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment roundEnv)</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (Element annotatedElement : roundEnv.getElementsAnnotatedWith(Factory.class)) &#123;</div><div class="line"></div><div class="line">      <span class="comment">// Check if a class has been annotated with @Factory</span></div><div class="line">      <span class="keyword">if</span> (annotatedElement.getKind() != ElementKind.CLASS) &#123;</div><div class="line">    		...</div><div class="line">      &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>What’s going on here? We want to ensure that only elements of type class are processed by our processor. Previously we have learned that classes are <strong>TypeElements</strong>. So why don’t we check <strong>if (! (annotatedElement instanceof TypeElement) )</strong>. That’s a wrong assumption because interfaces are TypeElement as well. So in annoation processing you should avoid <em>instanceof</em> but rather us <a href="http://docs.oracle.com/javase/7/docs/api/javax/lang/model/element/ElementKind.html" target="_blank" rel="external">ElementKind</a> or <a href="http://docs.oracle.com/javase/7/docs/api/javax/lang/model/type/TypeKind.html" target="_blank" rel="external">TypeKind</a> with TypeMirror.</p>
<h2 id="Error-Handling"><a href="#Error-Handling" class="headerlink" title="Error Handling"></a>Error Handling</h2><p>In <strong>init()</strong> we also retrieve a reference to <strong>Messager</strong>. A Messager provides the way for an annotation processor to report error messages, warnings and other notices. It’s not a logger for you, the developer of the annotation processor (even thought it can be used for that during development of the processor). Messager is used to write messages to the third party developer who uses your annotation processor in their projects. There are different levels of messages described in the <a href="http://docs.oracle.com/javase/7/docs/api/javax/tools/Diagnostic.Kind.html" target="_blank" rel="external">official docs</a>. Very important is <a href="http://docs.oracle.com/javase/7/docs/api/javax/tools/Diagnostic.Kind.html#ERROR" target="_blank" rel="external">Kind.ERROR</a> because this kind of message is used to indicate that our annotation processor has failed processing. Probably the third party developer is misusing our <strong>@Factory</strong> annotation (i.e. annotated an interface with @Factory). The concept is a little bit different from traditional java application where you would throw an <strong>Exception</strong>. If you throw an exception in <strong>process()</strong> then the jvm which runs annotation processing crashs (like any other java application) and the third party developer who is using our FactoryProcessor will get an error from javac with a hardly understandable Exception, because it contains the stacktrace of FactoryProcessor. Therefore Annotation Processor has this <strong>Messager</strong> class. It prints a pretty error message. Additionaly, you can link to the element who has raised this error. In modern IDEs like IntelliJ the third party developer can click on this error message and the IDE will jump to the source file and line of the third party developers project where the error source is.</p>
<p>Back to implementing the <strong>process()</strong> method. We raise a error message if the user has annotated a non class with @Factory:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment roundEnv)</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (Element annotatedElement : roundEnv.getElementsAnnotatedWith(Factory.class)) &#123;</div><div class="line"></div><div class="line">      <span class="comment">// Check if a class has been annotated with @Factory</span></div><div class="line">      <span class="keyword">if</span> (annotatedElement.getKind() != ElementKind.CLASS) &#123;</div><div class="line">        error(annotatedElement, <span class="string">"Only classes can be annotated with @%s"</span>,</div><div class="line">            Factory.class.getSimpleName());</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>; <span class="comment">// Exit processing</span></div><div class="line">      &#125;</div><div class="line"></div><div class="line">      ...</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">error</span><span class="params">(Element e, String msg, Object... args)</span> </span>&#123;</div><div class="line">    messager.printMessage(</div><div class="line">    	Diagnostic.Kind.ERROR,</div><div class="line">    	String.format(msg, args),</div><div class="line">    	e);</div><div class="line">  &#125;</div><div class="line"></div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>To get the message of the Messager displayed it’s <strong>important that the annotation processor has to complete without crashing</strong>. That’s why we <strong>return</strong> after having called <strong>error()</strong>. If we don’t return here <strong>process()</strong> will continue running since<strong>messager.printMessage( Diagnostic.Kind.ERROR)</strong> does not stop the process. So it’s very likely that if we don’t return after printing the error we will run in an internal <em>NullPointerException</em> etc. if we continue in <strong>process()</strong>. As said before, the problem is that if an unhandled exception is thrown in <strong>process()</strong> javac will print the stacktrace of the internal <em>NullPointerException</em> and NOT your error message of <strong>Messager</strong>.</p>
<h2 id="Datamodel"><a href="#Datamodel" class="headerlink" title="Datamodel"></a>Datamodel</h2><p>Before we continue with checking if classes annotated with @Factory observe our five rules (see above) we are going to introduce data structures which makes it easier for us to continue. Sometimes the problem or processor seems to be so simple that programmers tend to write the whole processor in a procedural manner. <strong>But you know what? An Annotation Processor is still a java application. So use object oriented programming, interfaces, design patterns and anything else you would use in any other java application!</strong></p>
<p>Our FactoryProcessor is quite simple but there are some information we want to store as objects. With <strong>FactoryAnnotatedClass</strong> we store the annotated class data like qualified class name along with the data of the @Factory annotation itself. So we store the TypeElement and evaluate the @Factory annotation:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FactoryAnnotatedClass</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> TypeElement annotatedClassElement;</div><div class="line">  <span class="keyword">private</span> String qualifiedSuperClassName;</div><div class="line">  <span class="keyword">private</span> String simpleTypeName;</div><div class="line">  <span class="keyword">private</span> String id;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">FactoryAnnotatedClass</span><span class="params">(TypeElement classElement)</span> <span class="keyword">throws</span> IllegalArgumentException </span>&#123;</div><div class="line">    <span class="keyword">this</span>.annotatedClassElement = classElement;</div><div class="line">    Factory annotation = classElement.getAnnotation(Factory.class);</div><div class="line">    id = annotation.id();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (StringUtils.isEmpty(id)) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</div><div class="line">          String.format(<span class="string">"id() in @%s for class %s is null or empty! that's not allowed"</span>,</div><div class="line">              Factory.class.getSimpleName(), classElement.getQualifiedName().toString()));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Get the full QualifiedTypeName</span></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      Class&lt;?&gt; clazz = annotation.type();</div><div class="line">      qualifiedSuperClassName = clazz.getCanonicalName();</div><div class="line">      simpleTypeName = clazz.getSimpleName();</div><div class="line">    &#125; <span class="keyword">catch</span> (MirroredTypeException mte) &#123;</div><div class="line">      DeclaredType classTypeMirror = (DeclaredType) mte.getTypeMirror();</div><div class="line">      TypeElement classTypeElement = (TypeElement) classTypeMirror.asElement();</div><div class="line">      qualifiedSuperClassName = classTypeElement.getQualifiedName().toString();</div><div class="line">      simpleTypeName = classTypeElement.getSimpleName().toString();</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Get the id as specified in &#123;<span class="doctag">@link</span> Factory#id()&#125;.</span></div><div class="line"><span class="comment">   * return the id</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getId</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> id;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Get the full qualified name of the type specified in  &#123;<span class="doctag">@link</span> Factory#type()&#125;.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> qualified name</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getQualifiedFactoryGroupName</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> qualifiedSuperClassName;</div><div class="line">  &#125;</div><div class="line"></div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Get the simple name of the type specified in  &#123;<span class="doctag">@link</span> Factory#type()&#125;.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> qualified name</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getSimpleFactoryGroupName</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> simpleTypeName;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * The original element that was annotated with <span class="doctag">@Factory</span></span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="function"><span class="keyword">public</span> TypeElement <span class="title">getTypeElement</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> annotatedClassElement;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Lot of code, but the most important thing happens ins the constructor where you find the following lines of code:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Factory annotation = classElement.getAnnotation(Factory.class);</div><div class="line">id = annotation.id(); <span class="comment">// Read the id value (like "Calzone" or "Tiramisu")</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> (StringUtils.isEmpty(id)) &#123;</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</div><div class="line">          String.format(<span class="string">"id() in @%s for class %s is null or empty! that's not allowed"</span>,</div><div class="line">              Factory.class.getSimpleName(), classElement.getQualifiedName().toString()));</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>Here we access the @Factory annotation and check if the id is not empty. We will throw an IllegalArgumentException if id is empty. You may be confused now because previously we said that we are not throwing exceptions but rather use <strong>Messager</strong>. That’s still correct. We throw an exception here internally and we will catch that one in <strong>process()</strong> as you will see later. We do that for two reasons:</p>
<ol>
<li>I want to demonstrate that you should still code like in any other java application. Throwing and catching exceptions is considered as good practice in java.</li>
<li>If we want to print a message right from <strong>FactoryAnnotatedClass</strong> we also have to pass the <strong>Messager</strong> and as already mentioned in “Error Handling” (scroll up) the processor has to terminate successfully to make <strong>Messager</strong> print the error message. So if we would write an error message by using <strong>Messager</strong> how do we “notify” <strong>process()</strong> that an error has occurred? The easiest and from my point of view most intuitive way is to throw an Exception and let <strong>process()</strong> chatch this one.</li>
</ol>
<p>Next we want to get the <strong>type</strong> field of the <strong>@Factory</strong> annotation. We are interessted in the full qualified name.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    Class&lt;?&gt; clazz = annotation.type();</div><div class="line">    qualifiedGroupClassName = clazz.getCanonicalName();</div><div class="line">    simpleFactoryGroupName = clazz.getSimpleName();</div><div class="line">  &#125; <span class="keyword">catch</span> (MirroredTypeException mte) &#123;</div><div class="line">    DeclaredType classTypeMirror = (DeclaredType) mte.getTypeMirror();</div><div class="line">    TypeElement classTypeElement = (TypeElement) classTypeMirror.asElement();</div><div class="line">    qualifiedGroupClassName = classTypeElement.getQualifiedName().toString();</div><div class="line">    simpleFactoryGroupName = classTypeElement.getSimpleName().toString();</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>That’s a little bit tricky, because the type is <strong>java.lang.Class</strong>. That means, that this is a real Class object. Since annotation processing runs before compiling java source code we have to consider two cases:</p>
<ol>
<li><strong>The class is already compiled</strong>: This is the case if a third party .jar contains compiled .class files with <strong>@Factory</strong> annotations. In that case we can directly access the Class like we do in the <strong>try-block</strong>.</li>
<li><strong>The class is not compiled yet</strong>: This will be the case if we try to compile our source code which has @Factory annotations. Trying to access the Class directly throws a <strong>MirroredTypeException</strong>. Fortunately MirroredTypeException contains a <strong>TypeMirror</strong>representation of our not yet compiled class. Since we know that it must be type of class (we have already checked that before) we can cast it to <strong>DeclaredType</strong> and access <strong>TypeElement</strong> to read the qualified name.</li>
</ol>
<p>Alright, now we need one more datastructure named <strong>FactoryGroupedClasses</strong> which basically groups all <strong>FactoryAnnotatedClasses</strong> together.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FactoryGroupedClasses</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> String qualifiedClassName;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> Map&lt;String, FactoryAnnotatedClass&gt; itemsMap =</div><div class="line">      <span class="keyword">new</span> LinkedHashMap&lt;String, FactoryAnnotatedClass&gt;();</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">FactoryGroupedClasses</span><span class="params">(String qualifiedClassName)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.qualifiedClassName = qualifiedClassName;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(FactoryAnnotatedClass toInsert)</span> <span class="keyword">throws</span> IdAlreadyUsedException </span>&#123;</div><div class="line"></div><div class="line">    FactoryAnnotatedClass existing = itemsMap.get(toInsert.getId());</div><div class="line">    <span class="keyword">if</span> (existing != <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IdAlreadyUsedException(existing);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    itemsMap.put(toInsert.getId(), toInsert);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">generateCode</span><span class="params">(Elements elementUtils, Filer filer)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">	...</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>As you see it’s basically just a <strong>Map<string, factoryannotatedclass=""></string,></strong>. This map is used to map an @Factory.id() to FactoryAnnotatedClass. We have chosen <strong>Map</strong> because we want to ensure that each id is unique. That can be easily done with a map lookup. <strong>generateCode()</strong>will be called to generate the Factory code (discussed later).</p>
<h2 id="Matching-Criteria"><a href="#Matching-Criteria" class="headerlink" title="Matching Criteria"></a>Matching Criteria</h2><p>Let’s proceed with the implementation of <strong>process()</strong>. Next we want to check if the annotated class has at least one public constructor, is not an abstract class, inherits the specified type and is a public class (visibility):</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FactoryProcessor</span> <span class="keyword">extends</span> <span class="title">AbstractProcessor</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment roundEnv)</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (Element annotatedElement : roundEnv.getElementsAnnotatedWith(Factory.class)) &#123;</div><div class="line"></div><div class="line">      ...</div><div class="line"></div><div class="line">      <span class="comment">// We can cast it, because we know that it of ElementKind.CLASS</span></div><div class="line">      TypeElement typeElement = (TypeElement) annotatedElement;</div><div class="line"></div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        FactoryAnnotatedClass annotatedClass =</div><div class="line">            <span class="keyword">new</span> FactoryAnnotatedClass(typeElement); <span class="comment">// throws IllegalArgumentException</span></div><div class="line"></div><div class="line">        <span class="keyword">if</span> (!isValidClass(annotatedClass)) &#123;</div><div class="line">          <span class="keyword">return</span> <span class="keyword">true</span>; <span class="comment">// Error message printed, exit processing</span></div><div class="line">         &#125;</div><div class="line">       &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</div><div class="line">        <span class="comment">// @Factory.id() is empty</span></div><div class="line">        error(typeElement, e.getMessage());</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">   	   ...</div><div class="line">   &#125;</div><div class="line"></div><div class="line"></div><div class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isValidClass</span><span class="params">(FactoryAnnotatedClass item)</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// Cast to TypeElement, has more type specific methods</span></div><div class="line">    TypeElement classElement = item.getTypeElement();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!classElement.getModifiers().contains(Modifier.PUBLIC)) &#123;</div><div class="line">      error(classElement, <span class="string">"The class %s is not public."</span>,</div><div class="line">          classElement.getQualifiedName().toString());</div><div class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Check if it's an abstract class</span></div><div class="line">    <span class="keyword">if</span> (classElement.getModifiers().contains(Modifier.ABSTRACT)) &#123;</div><div class="line">      error(classElement, <span class="string">"The class %s is abstract. You can't annotate abstract classes with @%"</span>,</div><div class="line">          classElement.getQualifiedName().toString(), Factory.class.getSimpleName());</div><div class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Check inheritance: Class must be childclass as specified in @Factory.type();</span></div><div class="line">    TypeElement superClassElement =</div><div class="line">        elementUtils.getTypeElement(item.getQualifiedFactoryGroupName());</div><div class="line">    <span class="keyword">if</span> (superClassElement.getKind() == ElementKind.INTERFACE) &#123;</div><div class="line">      <span class="comment">// Check interface implemented</span></div><div class="line">      <span class="keyword">if</span> (!classElement.getInterfaces().contains(superClassElement.asType())) &#123;</div><div class="line">        error(classElement, <span class="string">"The class %s annotated with @%s must implement the interface %s"</span>,</div><div class="line">            classElement.getQualifiedName().toString(), Factory.class.getSimpleName(),</div><div class="line">            item.getQualifiedFactoryGroupName());</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">      &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="comment">// Check subclassing</span></div><div class="line">      TypeElement currentClass = classElement;</div><div class="line">      <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">        TypeMirror superClassType = currentClass.getSuperclass();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (superClassType.getKind() == TypeKind.NONE) &#123;</div><div class="line">          <span class="comment">// Basis class (java.lang.Object) reached, so exit</span></div><div class="line">          error(classElement, <span class="string">"The class %s annotated with @%s must inherit from %s"</span>,</div><div class="line">              classElement.getQualifiedName().toString(), Factory.class.getSimpleName(),</div><div class="line">              item.getQualifiedFactoryGroupName());</div><div class="line">          <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (superClassType.toString().equals(item.getQualifiedFactoryGroupName())) &#123;</div><div class="line">          <span class="comment">// Required super class found</span></div><div class="line">          <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Moving up in inheritance tree</span></div><div class="line">        currentClass = (TypeElement) typeUtils.asElement(superClassType);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Check if an empty public constructor is given</span></div><div class="line">    <span class="keyword">for</span> (Element enclosed : classElement.getEnclosedElements()) &#123;</div><div class="line">      <span class="keyword">if</span> (enclosed.getKind() == ElementKind.CONSTRUCTOR) &#123;</div><div class="line">        ExecutableElement constructorElement = (ExecutableElement) enclosed;</div><div class="line">        <span class="keyword">if</span> (constructorElement.getParameters().size() == <span class="number">0</span> &amp;&amp; constructorElement.getModifiers()</div><div class="line">            .contains(Modifier.PUBLIC)) &#123;</div><div class="line">          <span class="comment">// Found an empty constructor</span></div><div class="line">          <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// No empty constructor found</span></div><div class="line">    error(classElement, <span class="string">"The class %s must provide an public empty default constructor"</span>,</div><div class="line">        classElement.getQualifiedName().toString());</div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>We have added a method <strong>isValidClass()</strong> and it checks if our rules are complied:</p>
<ul>
<li>Class must be public: <strong>classElement.getModifiers().contains(Modifier.PUBLIC)</strong></li>
<li>Class can not be abstract: <strong>classElement.getModifiers().contains(Modifier.ABSTRACT)</strong></li>
<li>Class must be subclass or implement the Class as specified in <strong>@Factoy.type()</strong>. First we use <strong>elementUtils.getTypeElement(item.getQualifiedFactoryGroupName())</strong> to create a Element of the passed <strong>Class</strong> (<strong>@Factoy.type()</strong>). Yes you got it, you can create <strong>TypeElement</strong>(with TypeMirror) just by knowing the qualified class name. Next we check if it’s an interface or a class: <strong>superClassElement.getKind() == ElementKind.INTERFACE</strong>. So we have two cases: If it’s an interfaces then <strong>classElement.getInterfaces().contains(superClassElement.asType())</strong>. If it’s a class, then we have to scan the inheritance hierarchy with calling <strong>currentClass.getSuperclass()</strong>. Note that this check could also be done with <strong>typeUtils.isSubtype()</strong>.</li>
<li>Class must have a public empty constructor: So we iterate over all enclosed elements <strong>classElement.getEnclosedElements()</strong> and check for <strong>ElementKind.CONSTRUCTOR</strong>, <strong>Modifier.PUBLIC</strong> and <strong>constructorElement.getParameters().size() == 0</strong></li>
</ul>
<p>If these conditions are fulfilled <strong>isValidClass()</strong> returns true, otherwise it prints a error message and returns false.</p>
<h2 id="Grouping-The-Annotated-Classes"><a href="#Grouping-The-Annotated-Classes" class="headerlink" title="Grouping The Annotated Classes"></a>Grouping The Annotated Classes</h2><p>Once we have checked <strong>isValidClass()</strong> we continue with adding <strong>FactoryAnnotatedClass</strong> to the corresponding <strong>FactoryGroupedClasses</strong> as follows:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FactoryProcessor</span> <span class="keyword">extends</span> <span class="title">AbstractProcessor</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> Map&lt;String, FactoryGroupedClasses&gt; factoryClasses =</div><div class="line">     <span class="keyword">new</span> LinkedHashMap&lt;String, FactoryGroupedClasses&gt;();</div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment roundEnv)</span> </span>&#123;</div><div class="line"></div><div class="line">     ...</div><div class="line"></div><div class="line">     <span class="keyword">try</span> &#123;</div><div class="line">       FactoryAnnotatedClass annotatedClass =</div><div class="line">           <span class="keyword">new</span> FactoryAnnotatedClass(typeElement); <span class="comment">// throws IllegalArgumentException</span></div><div class="line"></div><div class="line">         <span class="keyword">if</span> (!isValidClass(annotatedClass)) &#123;</div><div class="line">         <span class="keyword">return</span> <span class="keyword">true</span>; <span class="comment">// Error message printed, exit processing</span></div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">// Everything is fine, so try to add</span></div><div class="line">       FactoryGroupedClasses factoryClass =</div><div class="line">           factoryClasses.get(annotatedClass.getQualifiedFactoryGroupName());</div><div class="line">       <span class="keyword">if</span> (factoryClass == <span class="keyword">null</span>) &#123;</div><div class="line">         String qualifiedGroupName = annotatedClass.getQualifiedFactoryGroupName();</div><div class="line">         factoryClass = <span class="keyword">new</span> FactoryGroupedClasses(qualifiedGroupName);</div><div class="line">         factoryClasses.put(qualifiedGroupName, factoryClass);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">// Throws IdAlreadyUsedException if id is conflicting with</span></div><div class="line">       <span class="comment">// another @Factory annotated class with the same id</span></div><div class="line">       factoryClass.add(annotatedClass);</div><div class="line">     &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</div><div class="line">       <span class="comment">// @Factory.id() is empty --&gt; printing error message</span></div><div class="line">       error(typeElement, e.getMessage());</div><div class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">     &#125; <span class="keyword">catch</span> (IdAlreadyUsedException e) &#123;</div><div class="line">       FactoryAnnotatedClass existing = e.getExisting();</div><div class="line">       <span class="comment">// Already existing</span></div><div class="line">       error(annotatedElement,</div><div class="line">           <span class="string">"Conflict: The class %s is annotated with @%s with id ='%s' but %s already uses the same id"</span>,</div><div class="line">           typeElement.getQualifiedName().toString(), Factory.class.getSimpleName(),</div><div class="line">           existing.getTypeElement().getQualifiedName().toString());</div><div class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">     &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Code-Generation"><a href="#Code-Generation" class="headerlink" title="Code Generation"></a>Code Generation</h2><p>We have collected all classes annotated with <strong>@Factory</strong> stored as <strong>FactoryAnnotatedClass</strong>and grouped into <strong>FactoryGroupedClasses</strong>. Now we are going to generate java files for each Factory:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment roundEnv)</span> </span>&#123;</div><div class="line"></div><div class="line">	...</div><div class="line"></div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">for</span> (FactoryGroupedClasses factoryClass : factoryClasses.values()) &#123;</div><div class="line">          factoryClass.generateCode(elementUtils, filer);</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">        error(<span class="keyword">null</span>, e.getMessage());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Writing a java file is pretty the same as writing any other file in java. We use an <strong>Writer</strong>provided by <strong>Filer</strong>. We could write our generated code as concatination of Strings. Fortunately, Square Inc. well known for plenty awesome open source projects gives us with <a href="https://github.com/square/javawriter" target="_blank" rel="external">JavaWriter</a> a high level library for generating Java Code:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FactoryGroupedClasses</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Will be added to the name of the generated factory class</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SUFFIX = <span class="string">"Factory"</span>;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> String qualifiedClassName;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> Map&lt;String, FactoryAnnotatedClass&gt; itemsMap =</div><div class="line">      <span class="keyword">new</span> LinkedHashMap&lt;String, FactoryAnnotatedClass&gt;();</div><div class="line"></div><div class="line">	...</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">generateCode</span><span class="params">(Elements elementUtils, Filer filer)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line"></div><div class="line">    TypeElement superClassName = elementUtils.getTypeElement(qualifiedClassName);</div><div class="line">    String factoryClassName = superClassName.getSimpleName() + SUFFIX;</div><div class="line"></div><div class="line">    JavaFileObject jfo = filer.createSourceFile(qualifiedClassName + SUFFIX);</div><div class="line">    Writer writer = jfo.openWriter();</div><div class="line">    JavaWriter jw = <span class="keyword">new</span> JavaWriter(writer);</div><div class="line"></div><div class="line">    <span class="comment">// Write package</span></div><div class="line">    PackageElement pkg = elementUtils.getPackageOf(superClassName);</div><div class="line">    <span class="keyword">if</span> (!pkg.isUnnamed()) &#123;</div><div class="line">      jw.emitPackage(pkg.getQualifiedName().toString());</div><div class="line">      jw.emitEmptyLine();</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      jw.emitPackage(<span class="string">""</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    jw.beginType(factoryClassName, <span class="string">"class"</span>, EnumSet.of(Modifier.PUBLIC));</div><div class="line">    jw.emitEmptyLine();</div><div class="line">    jw.beginMethod(qualifiedClassName, <span class="string">"create"</span>, EnumSet.of(Modifier.PUBLIC), <span class="string">"String"</span>, <span class="string">"id"</span>);</div><div class="line"></div><div class="line">    jw.beginControlFlow(<span class="string">"if (id == null)"</span>);</div><div class="line">    jw.emitStatement(<span class="string">"throw new IllegalArgumentException(\"id is null!\")"</span>);</div><div class="line">    jw.endControlFlow();</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (FactoryAnnotatedClass item : itemsMap.values()) &#123;</div><div class="line">      jw.beginControlFlow(<span class="string">"if (\"%s\".equals(id))"</span>, item.getId());</div><div class="line">      jw.emitStatement(<span class="string">"return new %s()"</span>, item.getTypeElement().getQualifiedName().toString());</div><div class="line">      jw.endControlFlow();</div><div class="line">      jw.emitEmptyLine();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    jw.emitStatement(<span class="string">"throw new IllegalArgumentException(\"Unknown id = \" + id)"</span>);</div><div class="line">    jw.endMethod();</div><div class="line"></div><div class="line">    jw.endType();</div><div class="line"></div><div class="line">    jw.close();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p><strong>Tipp:</strong> Since JavaWriter is very very popular there are many other processors, libraries and tools depending on JavaWriter. This maybe will cause problems if you use dependency management tools like maven or gradle if one library depends on a newer version of JavaWriter as another one. Therefore I recommend to copy and repackage JavaWriter directly into your annotation processor code base (it’s just one java file).</p>
</blockquote>
<p><strong>Update:</strong> Use <a href="https://github.com/square/javapoet" target="_blank" rel="external">JavaPoet</a> instead of JavaWriter.</p>
<h2 id="Processing-Rounds"><a href="#Processing-Rounds" class="headerlink" title="Processing Rounds"></a>Processing Rounds</h2><p>Annotation Processing maybe takes more than one processing round. The official javadoc define processing like as follows:</p>
<blockquote>
<p>Annotation processing happens in a sequence of rounds. On each round, a processor may be asked to process a subset of the annotations found on the source and class files produced by a prior round. The inputs to the first round of processing are the initial inputs to a run of the tool; these initial inputs can be regarded as the output of a virtual zeroth round of processing.</p>
</blockquote>
<p>A simpler definition: A processing round is calling <strong>process()</strong> of an annotation processor. To stick with our factory sample: <strong>FactoryProcessor</strong> is instantiated once (new Processor object is <strong>not</strong> created for each round), but <strong>process()</strong> can be called multiple times, if new source files has been created. Sounds a little bit strange, doesn’t it? The reason is that, the generated source code files could contain <strong>@Factory</strong> annotated classes as well, which would be processed by <strong>FactoryProcessor</strong>.</p>
<p>For example our <strong>PizzaStore</strong> sample will be processed in 3 rounds:</p>
<table>
<thead>
<tr>
<th>Round</th>
<th>Input</th>
<th>Output</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>CalzonePizza.java Tiramisu.javaMargheritaPizza.javaMeal.javaPizzaStore.java</td>
<td>MealFactory.java</td>
</tr>
<tr>
<td>2</td>
<td>MealFactory.java</td>
<td>— none —</td>
</tr>
<tr>
<td>3</td>
<td>— none —</td>
<td>— none —</td>
</tr>
</tbody>
</table>
<p>There is another reason why I’m explaining processing rounds. If you look at our <strong>FactoryProcessor</strong> code you see that we collect data and store them in private field <strong>Map<string, factorygroupedclasses=""> factoryClasses</string,></strong>. In first round we detect MagheritaPizza, CalzonePizza and Tiramisu and we generate a file MealFactory.java. In the second round we take MealFactory as input. Since there is no <strong>@Factory</strong> annotation in MealFactory no data will be collected, we would not expect to get an error. However we get one:</p>
<p><strong>Attempt to recreate a file for type com.hannesdorfmann.annotationprocessing101.factory.MealFactory</strong></p>
<p>The problem is that we never clear <strong>factoryClasses</strong>. That means, that in round two <strong>process()</strong>has still stored data from the first round and wants to generate the same file as round 1 already did which will cause this error. In our case, we know that only in the first round we will detect <strong>@Factory</strong> annotated classes and therefore we can simply fix it like that:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment roundEnv)</span> </span>&#123;</div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">      <span class="keyword">for</span> (FactoryGroupedClasses factoryClass : factoryClasses.values()) &#123;</div><div class="line">        factoryClass.generateCode(elementUtils, filer);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">// Clear to fix the problem</span></div><div class="line">      factoryClasses.clear();</div><div class="line"></div><div class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">      error(<span class="keyword">null</span>, e.getMessage());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">	...</div><div class="line">	<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>I know there are other ways to deal with that problem i.e. we could also set a boolean flag etc. The point is: Keep in mind that annotation processing is done in multiple processing rounds and you can not override or recreate already generated source files.</p>
<h2 id="Separation-of-processor-and-annotation"><a href="#Separation-of-processor-and-annotation" class="headerlink" title="Separation of processor and annotation"></a>Separation of processor and annotation</h2><p>If you have looked at the <a href="https://github.com/sockeqwe/annotationprocessing101/tree/master/factory" target="_blank" rel="external">git repository</a> of our factory processor you will see that we have organized our repository in two maven modules. We did that, because we want to give the user of our Factory example the possibility to compile just the annotation in his own project and to include the processor module just for compilation. Confused? I.e. if we would have just one single artifact another developer who wants to use our factory processor in his own project would include both the <strong>@Factory</strong> annotation and the whole <strong>FactoryProcessor</strong> code (incl. FactoryAnnotatedClass and FactoryGroupedClasses) in his project build. I’m pretty sure that the other one won’t have the processor class in his compiled project. If you are an android developer maybe you have heard of the 65k method limit (a android .dex file can only address 65.000 methods). If we would have used guava in FactoryProcessor and would provide just a single artifact containing annotation and processor code, then the android apk would not only contain FactoryProcessor code but the whole guava code as well. Guava has about 20.000 methods. Therefore a separation of annotation and processor makes sense.</p>
<h2 id="Instantiation-Of-Generated-Classes"><a href="#Instantiation-Of-Generated-Classes" class="headerlink" title="Instantiation Of Generated Classes"></a>Instantiation Of Generated Classes</h2><p>As you have seen in <strong>PizzaStore</strong> sample the generated class <strong>MealFactory</strong> is a normal java class as any other handwritten class. Furthermore, you have to instantiate it by hand (like any other java object).</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PizzaStore</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> MealFactory factory = <span class="keyword">new</span> MealFactory();</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> Meal <span class="title">order</span><span class="params">(String mealName)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> factory.create(mealName);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  ...</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>If you are an android developer you should be familiar with a great annotation processors called <a href="http://jakewharton.github.io/butterknife/" target="_blank" rel="external">ButterKnife</a>. In ButterKnife you annotate android Views with <strong>@InjectView</strong>. The ButterKnifeProcessor generates a class <strong>MyActivityViewInjector()</strong> but you can use <strong>Butterknife.inject(activity)</strong>. ButterKnife internally uses reflections to instantiate <strong>MyActivity$$ViewInjector()</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">	Class&lt;?&gt; injector = Class.forName(clsName + <span class="string">"$$ViewInjector"</span>);</div><div class="line">&#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123; ... &#125;</div></pre></td></tr></table></figure>
<p>But is reflection not slow and didn’t we tried to get rich of reflections performance issues by using annotation processing which generates native code? Yes, reflection brings perfomance issues. However, it speeds up development because the developer has not to instantiate objects by hand. ButterKnife uses a HashMap to “cache” the instantiated objects. So <strong>MyActivityViewInjector</strong> is needed it will be retrieved from the HashMap.</p>
<p><a href="https://github.com/sockeqwe/fragmentargs" target="_blank" rel="external">FragmentArgs</a> works similar to ButterKnife. It uses reflection to instantiate things that otherwise the developer who uses FragmentArgs has to do manually. FragmentArgs generates a special “lookup” class while annotation processing which is kind of HashMap. So the whole FragmentArgs library executes only one reflection call at the very first time to instantiate this special HashMap class. Once this class is instantiated with <strong>Class.forName()</strong>fragment arguments injection runs in native java code.</p>
<p>All in all it’s up to you (the developer of annotation processor) to find a good compromise between reflection and usability for other users of your annotation processor.</p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>I hope you have a deeper understanding of annotation processing now. I have to say it once again: Annotation processing is a very powerful tool and helps reducing writing boiler plate code. I also want to mention that with annotation processors you can do much more complex things than I show in this simple factory sample, for example type erasure on Generics, because annotation processing happens before type erasure. As you have seen there are two common problems you have to deal when writing: First, if you want to use ElementUtils, TypeUtils and Messager in other classes then you have to pass them as parameters somehow. In <a href="https://github.com/sockeqwe/AnnotatedAdapter" target="_blank" rel="external">AnnotatedAdapter</a>, one of my annotation processors for android, I tried to solve that problem with Dagger (Dependency Injection). It feels a little bit to much overhead for such a simple processor, however it has worked well. The second thing you have to deal is you have to make “queries” for <strong>Elements</strong>. As I said before, working with elements can be seen as parsing XML or HTML. For HTML you can use jQuery. Something similar to jQuery for annotation processing would be really awesome. Please comment below if you know any similar library.</p>
<p><strong>Please note that parts of the code of FactoryProcessor has some edges and pitfalls. These “mistakes” are placed explicit by me to struggle through them as I explain common mistakes while writing annotation processors (like “Attempt to recreate a file”). If you start writing your own annotation processor based on FactoryProcessor DON’T copy and paste this pitfalls. Instead you should avoid them from the very beginning.</strong></p>
<p>In a future blog post (Annotation Processing 102) I will write about unit testing annotation processors. However, my next blog post will be about software architecture in android. Stay tuned.</p>
<h3 id="Update"><a href="#Update" class="headerlink" title="Update"></a>Update</h3><p>I gave a talk about Annotation Processing at droidcon Germany 2015. The video of my talk can be found at <a href="https://www.youtube.com/watch?v=43FFfTyDYEg" target="_blank" rel="external">youtube</a>. </p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/20/colleges/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Allen Wang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="AllenWang的个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/20/colleges/" itemprop="url">未命名</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-20T14:36:06+08:00">
                2017-12-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li>徐欢 游戏事业部 weibo投广告</li>
</ul>
<ul>
<li>杨爱杰 技术产品中心 交互设计师</li>
<li>郑杨建 节目制作中心 做机器人节目</li>
<li>闫迪 电商事业部 电商运营</li>
<li>许仕琏 节目制作中心 机器人节目</li>
</ul>
<ul>
<li>我的前半生</li>
<li>锦绣未央</li>
<li>欢乐颂</li>
<li>三生三世</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/17/RePlugin解析-startActivity流程分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Allen Wang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="AllenWang的个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/17/RePlugin解析-startActivity流程分析/" itemprop="url">RePlugin解析(-):startActivity流程分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-17T00:06:11+08:00">
                2017-12-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="1-替换"><a href="#1-替换" class="headerlink" title="1.替换"></a>1.替换</h3><p>所有plugin中的Activity子类都会在编译时由gradle插件进行替换，即将继承自Activity或Activity子类(如AppCompatActivity)的类改为继承PluginActivity和PluginAppCompatActivity等,这样做的原因在于:RePlugin既不想Hook AMP,Instrumentation等，又想达到动态加载未在Manifest中声明的组件的目的，那么就只能在编译期做更多的事情，即通过gradle插件来修改plugin中的代码(特别是组件的代码),比如这里所有本来继承自Activity或AppCompatActivity改为继承PluginActivity和PluginAppCompatActivity,而PluginActivity虽然也是继承自Activity,但是其内部的方法已经重写了，代码如下&lt;!—more—&gt;（在replugin-plugin-library中):</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 插件内的BaseActivity，建议插件内所有的Activity都要继承此类</span></div><div class="line"><span class="comment"> * 此类通过override方式来完成插件框架的相关工作</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@author</span> RePlugin Team</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">PluginActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">attachBaseContext</span><span class="params">(Context newBase)</span> </span>&#123;</div><div class="line">        newBase = RePluginInternal.createActivityContext(<span class="keyword">this</span>, newBase);</div><div class="line">        <span class="keyword">super</span>.attachBaseContext(newBase);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="comment">//</span></div><div class="line">        RePluginInternal.handleActivityCreateBefore(<span class="keyword">this</span>, savedInstanceState);</div><div class="line"></div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line"></div><div class="line">        <span class="comment">//</span></div><div class="line">        RePluginInternal.handleActivityCreate(<span class="keyword">this</span>, savedInstanceState);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">//</span></div><div class="line">        RePluginInternal.handleActivityDestroy(<span class="keyword">this</span>);</div><div class="line"></div><div class="line">        <span class="keyword">super</span>.onDestroy();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onRestoreInstanceState</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="comment">//</span></div><div class="line">        RePluginInternal.handleRestoreInstanceState(<span class="keyword">this</span>, savedInstanceState);</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">super</span>.onRestoreInstanceState(savedInstanceState);</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">            <span class="comment">// Added by Jiongxuan Zhang</span></div><div class="line">            <span class="comment">// Crash Hash: B1F67129BC6A67C882AF2BBE62202BF0</span></div><div class="line">            <span class="comment">// java.lang.IllegalArgumentException: Wrong state class异常</span></div><div class="line">            <span class="comment">// 原因：恢复现场时，Activity坑位找错了。通常是用于占坑的Activity的层级过深导致</span></div><div class="line">            <span class="comment">// 举例：假如我们只有一个坑位可用，A和B分别是清理和通讯录的两个Activity</span></div><div class="line">            <span class="comment">//      如果进程重启，系统原本恢复B，却走到了A，从而出现此问题</span></div><div class="line">            <span class="comment">// 解决：将其Catch住，这样系统在找ViewState时不会出错。</span></div><div class="line">            <span class="comment">// 后遗症：</span></div><div class="line">            <span class="comment">// 1、可能无法恢复系统级View的保存的状态；</span></div><div class="line">            <span class="comment">// 2、如果自己代码处理不当，可能会出现异常。故自己代码一定要用SecExtraUtils来获取Bundle数据</span></div><div class="line">            <span class="keyword">if</span> (LogRelease.LOGR) &#123;</div><div class="line">                LogRelease.e(<span class="string">"PluginActivity"</span>, <span class="string">"o r i s: p="</span> + getPackageCodePath() + <span class="string">"; "</span> + e.getMessage(), e);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivity</span><span class="params">(Intent intent)</span> </span>&#123;</div><div class="line">        <span class="comment">//</span></div><div class="line">        <span class="keyword">if</span> (RePluginInternal.startActivity(<span class="keyword">this</span>, intent)) &#123;</div><div class="line">            <span class="comment">// 这个地方不需要回调startActivityAfter，因为Factory2最终还是会回调回来，最终还是要走super.startActivity()</span></div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">super</span>.startActivity(intent);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivityForResult</span><span class="params">(Intent intent, <span class="keyword">int</span> requestCode)</span> </span>&#123;</div><div class="line">        <span class="comment">//</span></div><div class="line">        <span class="keyword">if</span> (RePluginInternal.startActivityForResult(<span class="keyword">this</span>, intent, requestCode)) &#123;</div><div class="line">            <span class="comment">// 这个地方不需要回调startActivityAfter，因为Factory2最终还是会回调回来，最终还是要走super.startActivityForResult()</span></div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">super</span>.startActivityForResult(intent, requestCode);</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>显然，这样做的结果是之前插件中Activity代码中的startActivity和startActivityForResult()方法都修改为RePluginInternal.startActivity()和RePluginInternal.startActivityForResult()方法，而RePluginInternal其实只是做了封装，最终通过反射调用到replugin-host-library的startActivity()中:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * Copyright (C) 2005-2017 Qihoo 360 Inc.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * Licensed under the Apache License, Version 2.0 (the "License"); you may not</span></div><div class="line"><span class="comment"> * use this file except in compliance with the License. You may obtain a copy of</span></div><div class="line"><span class="comment"> * the License at</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * http://www.apache.org/licenses/LICENSE-2.0</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * Unless required by applicable law or agreed To in writing, software</span></div><div class="line"><span class="comment"> * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT</span></div><div class="line"><span class="comment"> * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the</span></div><div class="line"><span class="comment"> * License for the specific language governing permissions and limitations under</span></div><div class="line"><span class="comment"> * the License.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"></div><div class="line"><span class="keyword">package</span> com.qihoo360.i;</div><div class="line"></div><div class="line"><span class="keyword">import</span> android.app.Activity;</div><div class="line"><span class="keyword">import</span> android.app.Service;</div><div class="line"><span class="keyword">import</span> android.content.Context;</div><div class="line"><span class="keyword">import</span> android.content.Intent;</div><div class="line"><span class="keyword">import</span> android.os.Bundle;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.qihoo360.loader2.PluginLibraryInternalProxy;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.json.JSONArray;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * plugin-library中，通过“反射”调用的内部逻辑（如PluginActivity类的调用等）均在此处 &lt;p&gt;</span></div><div class="line"><span class="comment"> * 注意：务必要Keep住此类，否则插件调用将失败</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@author</span> RePlugin Team</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Factory2</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * <span class="doctag">@hide</span> 内部框架使用</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> PluginLibraryInternalProxy sPLProxy;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * <span class="doctag">@hide</span> 内部方法，插件框架使用</span></div><div class="line"><span class="comment">     * 插件的Activity创建成功后通过此方法获取其base context</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> activity</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> newBase</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> 为Activity构造一个base Context</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Context <span class="title">createActivityContext</span><span class="params">(Activity activity, Context newBase)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> sPLProxy.createActivityContext(activity, newBase);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * <span class="doctag">@hide</span> 内部方法，插件框架使用</span></div><div class="line"><span class="comment">     * 插件的Activity的onCreate调用前调用此方法</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> activity</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> savedInstanceState</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">handleActivityCreateBefore</span><span class="params">(Activity activity, Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        sPLProxy.handleActivityCreateBefore(activity, savedInstanceState);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * <span class="doctag">@hide</span> 内部方法，插件框架使用</span></div><div class="line"><span class="comment">     * 插件的Activity的onCreate调用后调用此方法</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> activity</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> savedInstanceState</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">handleActivityCreate</span><span class="params">(Activity activity, Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        sPLProxy.handleActivityCreate(activity, savedInstanceState);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * <span class="doctag">@hide</span> 内部方法，插件框架使用</span></div><div class="line"><span class="comment">     * 插件的Activity的onDestroy调用后调用此方法</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> activity</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">handleActivityDestroy</span><span class="params">(Activity activity)</span> </span>&#123;</div><div class="line">        sPLProxy.handleActivityDestroy(activity);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * <span class="doctag">@hide</span> 内部方法，插件框架使用</span></div><div class="line"><span class="comment">     * 插件的Activity的onRestoreInstanceState调用后调用此方法</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> activity</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> savedInstanceState</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">handleRestoreInstanceState</span><span class="params">(Activity activity, Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        sPLProxy.handleRestoreInstanceState(activity, savedInstanceState);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * <span class="doctag">@hide</span> 内部方法，插件框架使用</span></div><div class="line"><span class="comment">     * 插件的Service的onCreate调用后调用此方法</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> service</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">handleServiceCreate</span><span class="params">(Service service)</span> </span>&#123;</div><div class="line">        sPLProxy.handleServiceCreate(service);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * <span class="doctag">@hide</span> 内部方法，插件框架使用</span></div><div class="line"><span class="comment">     * 插件的Service的onDestroy调用后调用此方法</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> service</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">handleServiceDestroy</span><span class="params">(Service service)</span> </span>&#123;</div><div class="line">        sPLProxy.handleServiceDestroy(service);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * <span class="doctag">@hide</span> 内部方法，插件框架使用</span></div><div class="line"><span class="comment">     * 启动一个插件中的activity</span></div><div class="line"><span class="comment">     * 通过Extra参数IPluginManager.KEY_COMPATIBLE，IPluginManager.KEY_PLUGIN，IPluginManager.KEY_ACTIVITY，IPluginManager.KEY_PROCESS控制</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> context Context上下文</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> intent</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> 插件机制层是否成功，例如没有插件存在、没有合适的Activity坑</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">startActivity</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> sPLProxy.startActivity(context, intent);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * <span class="doctag">@hide</span> 内部方法，插件框架使用</span></div><div class="line"><span class="comment">     * 启动一个插件中的activity</span></div><div class="line"><span class="comment">     * 通过Extra参数IPluginManager.KEY_COMPATIBLE，IPluginManager.KEY_PLUGIN，IPluginManager.KEY_ACTIVITY，IPluginManager.KEY_PROCESS控制</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> activity Activity上下文</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> intent</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> 插件机制层是否成功，例如没有插件存在、没有合适的Activity坑</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">startActivity</span><span class="params">(Activity activity, Intent intent)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> sPLProxy.startActivity(activity, intent);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * <span class="doctag">@hide</span> 内部方法，插件框架使用</span></div><div class="line"><span class="comment">     * 启动一个插件中的activity，如果插件不存在会触发下载界面</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> context 应用上下文或者Activity上下文</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> intent</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> plugin 插件名</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> activity 待启动的activity类名</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> process 是否在指定进程中启动</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> download 下载</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> 插件机制层是否成功，例如没有插件存在、没有合适的Activity坑</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">startActivity</span><span class="params">(Context context, Intent intent, String plugin, String activity, <span class="keyword">int</span> process, <span class="keyword">boolean</span> download)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> sPLProxy.startActivity(context, intent, plugin, activity, process, download);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 通过 forResult 方式启动一个插件的 Activity</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> activity    源 Activity</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> intent      要打开 Activity 的 Intent，其中 ComponentName 的 Key 必须为插件名</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> requestCode 请求码</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> options     附加的数据</span></div><div class="line"><span class="comment">     * <span class="doctag">@see</span> #startActivityForResult(Activity, Intent, int, Bundle)</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">startActivityForResult</span><span class="params">(Activity activity, Intent intent, <span class="keyword">int</span> requestCode, Bundle options)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> sPLProxy.startActivityForResult(activity, intent, requestCode, options);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * <span class="doctag">@hide</span> 内部方法，插件框架使用</span></div><div class="line"><span class="comment">     * 返回所有插件的json串，格式见plugins-builtin.json文件</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> name 插件名，传null或者空串表示获取全部</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span></span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> JSONArray <span class="title">fetchPlugins</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> sPLProxy.fetchPlugins(name);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * <span class="doctag">@hide</span> 内部方法，插件框架使用</span></div><div class="line"><span class="comment">     * 登记动态映射的类</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> className 壳类名</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> plugin 目标插件名</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> type 目标类的类型: activity, service, provider</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> target 目标类名</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span></span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">registerDynamicClass</span><span class="params">(String className, String plugin, String type, String target)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> sPLProxy.registerDynamicClass(className, plugin, type, target);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * <span class="doctag">@hide</span> 内部方法，插件框架使用</span></div><div class="line"><span class="comment">     * 登记动态映射的类</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> className 壳类名</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> plugin 目标插件名</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> target 目标类名</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span></span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">registerDynamicClass</span><span class="params">(String className, String plugin, String target, Class defClass)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> sPLProxy.registerDynamicClass(className, plugin, target, defClass);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * <span class="doctag">@hide</span> 内部方法，插件框架使用</span></div><div class="line"><span class="comment">     * 查询动态映射的类</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> className 壳类名</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> plugin 目标插件名</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span></span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">isDynamicClass</span><span class="params">(String plugin, String className)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> sPLProxy.isDynamicClass(plugin, className);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">unregisterDynamicClass</span><span class="params">(String source)</span> </span>&#123;</div><div class="line">        sPLProxy.unregisterDynamicClass(source);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * <span class="doctag">@hide</span> 内部方法，插件框架调用</span></div><div class="line"><span class="comment">     * 根据动态注册的类，反查此类对应的插件名称</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> className 动态类名称</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> 插件名称</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String <span class="title">getPluginByDynamicClass</span><span class="params">(String className)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> sPLProxy.getPluginByDynamicClass(className);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>而Factory2其实仍然还是起一个封装的作用，实际调用的是PluginLibraryInternalProxy中的startActivity()方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">    * <span class="doctag">@hide</span> 内部方法，插件框架使用</span></div><div class="line"><span class="comment">    * 启动一个插件中的activity</span></div><div class="line"><span class="comment">    * 通过Extra参数IPluginManager.KEY_COMPATIBLE，IPluginManager.KEY_PLUGIN，IPluginManager.KEY_ACTIVITY，IPluginManager.KEY_PROCESS控制</span></div><div class="line"><span class="comment">    * <span class="doctag">@param</span> context Context上下文</span></div><div class="line"><span class="comment">    * <span class="doctag">@param</span> intent</span></div><div class="line"><span class="comment">    * <span class="doctag">@return</span> 插件机制层是否成功，例如没有插件存在、没有合适的Activity坑</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">startActivity</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (LOG) &#123;</div><div class="line">           LogDebug.d(PLUGIN_TAG, <span class="string">"start context: intent="</span> + intent);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">// 兼容模式，直接使用标准方式启动</span></div><div class="line">       <span class="keyword">if</span> (intent.getBooleanExtra(IPluginManager.KEY_COMPATIBLE, <span class="keyword">false</span>)) &#123;</div><div class="line">           PmBase.cleanIntentPluginParams(intent);</div><div class="line">           <span class="keyword">if</span> (LOG) &#123;</div><div class="line">               LogDebug.d(PLUGIN_TAG, <span class="string">"start context: COMPATIBLE is true, direct start"</span>);</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">// 获取Activity的名字，有两种途径：</span></div><div class="line">       <span class="comment">// 1. 从Intent里取。通常是明确知道要打开的插件的Activity时会用</span></div><div class="line">       <span class="comment">// 2. 从Intent的ComponentName中获取</span></div><div class="line">       String name = intent.getStringExtra(IPluginManager.KEY_ACTIVITY);</div><div class="line">       <span class="keyword">if</span> (TextUtils.isEmpty(name)) &#123;</div><div class="line">           ComponentName cn = intent.getComponent();</div><div class="line">           <span class="keyword">if</span> (cn != <span class="keyword">null</span>) &#123;</div><div class="line">               name = cn.getClassName();</div><div class="line">               <span class="keyword">if</span> (LOG) &#123;</div><div class="line">                   LogDebug.d(PLUGIN_TAG, <span class="string">"start context: custom context="</span> + context);</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">// 已经是标准坑了（例如N1ST1这样的），则无需再过“坑位分配”逻辑，直接使用标准方式启动</span></div><div class="line">       <span class="keyword">if</span> (mPluginMgr.isActivity(name)) &#123;</div><div class="line">           PmBase.cleanIntentPluginParams(intent);</div><div class="line">           <span class="keyword">if</span> (LOG) &#123;</div><div class="line">               LogDebug.d(PLUGIN_TAG, <span class="string">"start context: context is container, direct start"</span>);</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">// 获取插件名，有三种途径：</span></div><div class="line">       <span class="comment">// 1. 从Intent里取。通常是明确知道要打开的插件时会用</span></div><div class="line">       <span class="comment">// 2. 根据当前Activity的坑位名来“反查”其插件名。通常是插件内开启自己的Activity时用到</span></div><div class="line">       <span class="comment">// 3. 通过获得Context的类加载器来判断其插件名</span></div><div class="line">       String plugin = intent.getStringExtra(IPluginManager.KEY_PLUGIN);</div><div class="line"></div><div class="line">       <span class="comment">/* 检查是否是动态注册的类 */</span></div><div class="line">       <span class="comment">// 如果要启动的 Activity 是动态注册的类，则不使用坑位机制，而是直接动态类。</span></div><div class="line">       <span class="comment">// 原因：宿主的某些动态注册的类不能运行在坑位中（如'桌面'插件的入口Activity）</span></div><div class="line">       ComponentName componentName = intent.getComponent();</div><div class="line">       <span class="keyword">if</span> (componentName != <span class="keyword">null</span>) &#123;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (LogDebug.LOG) &#123;</div><div class="line">            LogDebug.d(<span class="string">"loadClass"</span>, <span class="string">"isHookingClass("</span> + plugin + <span class="string">","</span> + componentName.getClassName() + <span class="string">") = "</span></div><div class="line">                    + isDynamicClass(plugin, componentName.getClassName()));</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (isDynamicClass(plugin, componentName.getClassName())) &#123;</div><div class="line">               intent.putExtra(IPluginManager.KEY_COMPATIBLE, <span class="keyword">true</span>);</div><div class="line">            intent.setComponent(<span class="keyword">new</span> ComponentName(IPC.getPackageName(), componentName.getClassName()));</div><div class="line">            context.startActivity(intent);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (TextUtils.isEmpty(plugin)) &#123;</div><div class="line">           <span class="comment">// 看下Context是否为Activity，如是则直接从坑位中获取插件名（最准确）</span></div><div class="line">           <span class="keyword">if</span> (context <span class="keyword">instanceof</span> Activity) &#123;</div><div class="line">               plugin = fetchPluginByPitActivity((Activity) context);</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">if</span> (LOG) &#123;</div><div class="line">               LogDebug.d(PLUGIN_TAG, <span class="string">"start context: custom plugin is empty, query plugin="</span> + plugin);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">// 没拿到插件名？再从 ClassLoader 获取插件名称（兜底）</span></div><div class="line">       <span class="keyword">if</span> (TextUtils.isEmpty(plugin)) &#123;</div><div class="line">           plugin = RePlugin.fetchPluginNameByClassLoader(context.getClassLoader());</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">// 仍然拿不到插件名？（例如从宿主中调用），则打开的Activity可能是宿主的。直接使用标准方式启动</span></div><div class="line">       <span class="keyword">if</span> (TextUtils.isEmpty(plugin)) &#123;</div><div class="line">           PmBase.cleanIntentPluginParams(intent);</div><div class="line">           <span class="keyword">if</span> (LOG) &#123;</div><div class="line">               LogDebug.d(PLUGIN_TAG, <span class="string">"start context: plugin and context is empty, direct start"</span>);</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">// 获取进程值，看目标Activity要打开哪个进程</span></div><div class="line">       <span class="keyword">int</span> process = intent.getIntExtra(IPluginManager.KEY_PROCESS, Integer.MIN_VALUE);</div><div class="line"></div><div class="line">       PmBase.cleanIntentPluginParams(intent);</div><div class="line"></div><div class="line">       <span class="comment">// 调用“特殊版”的startActivity，不让自动填写ComponentName，防止外界再用时出错</span></div><div class="line">       <span class="keyword">return</span> Factory.startActivityWithNoInjectCN(context, intent, plugin, name, process);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>在分析这个方法之前，我们先分析一下除了Activity.startActivity()之外的另外一种startActivity()的调用，即Context.startActivity()这个调用，那我们将这个调用也替换掉呢？</p>
<p>其实很简单，不需要改动这部分代码，只需要在插件初始化时将其Context替换为特制的Context,即PluginContext:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivity</span><span class="params">(Intent intent)</span> </span>&#123;</div><div class="line">       <span class="comment">// HINT 只有插件Application才会走这里</span></div><div class="line">       <span class="comment">// 而Activity.startActivity系统最终会走startActivityForResult，不会走这儿</span></div><div class="line"></div><div class="line">       <span class="comment">// 这里会被调用两次：</span></div><div class="line">       <span class="comment">// 第一次：获取各种信息，最终确认坑位，并走startActivity，再次回到这里</span></div><div class="line">       <span class="comment">// 第二次：判断要打开的是“坑位Activity”，则返回False，直接走super，后面的事情你们都懂的</span></div><div class="line">       <span class="comment">// 当然，如果在获取坑位信息时遇到任何情况（例如要打开的是宿主的Activity），则直接返回false，走super</span></div><div class="line">       <span class="keyword">if</span> (!Factory2.startActivity(<span class="keyword">this</span>, intent)) &#123;</div><div class="line">           <span class="keyword">if</span> (mContextInjector != <span class="keyword">null</span>) &#123;</div><div class="line">               mContextInjector.startActivityBefore(intent);</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="keyword">super</span>.startActivity(intent);</div><div class="line"></div><div class="line">           <span class="keyword">if</span> (mContextInjector != <span class="keyword">null</span>) &#123;</div><div class="line">               mContextInjector.startActivityAfter(intent);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>可以看到，PluginContext中的startActivity()方法其实也是调用 Factory2.startActivity()，到这里我们就把插件中所有startActivity()的调用都统一到Factory2.startActivity()的调用了，而至于插件中上下文的替换，是另外一个很大的话题，后面会专门写一篇文章来阐述。</p>
<h3 id="2-PluginLibraryInternalProxy"><a href="#2-PluginLibraryInternalProxy" class="headerlink" title="2.PluginLibraryInternalProxy"></a>2.PluginLibraryInternalProxy</h3><h4 id="2-1-首次进入插件时的startActivity-调用"><a href="#2-1-首次进入插件时的startActivity-调用" class="headerlink" title="2.1 首次进入插件时的startActivity()调用"></a>2.1 首次进入插件时的startActivity()调用</h4><p>此时涉及到坑位的分配，情况比较复杂。</p>
<p>从外部进入一个插件，通过调用RePlugin.startActivity(Context,Intent)实现，这个调用流程如下:</p>
<img src="/images/RePlugin_startActivity_flow.png">
<p>下面就逐步来分析。</p>
<ul>
<li>2.1.1 RePlugin.startActivity(Context,Intent)</li>
</ul>
<p>在看这个方法之前，先看一下这个Intent是如何来的，它跟一般的startActivity中的Intent不一样，它是特殊构造的，如下是一个调用示例:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">RePlugin.startActivity(MainActivity.<span class="keyword">this</span>,RePlugin.createIntent(<span class="string">"demo1"</span>,<span class="string">"com.qihoo360.replugin.sample.demo1.MainActivity"</span>));</div></pre></td></tr></table></figure>
<p>而RePlugin.createIntent()方法如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">     * 创建一个用来定向到插件组件的Intent &lt;p&gt;</span></div><div class="line"><span class="comment">     * &lt;p&gt;</span></div><div class="line"><span class="comment">     * 推荐用法： &lt;p&gt;</span></div><div class="line"><span class="comment">     * &lt;code&gt;</span></div><div class="line"><span class="comment">     * Intent in = RePlugin.createIntent("clean", "com.qihoo360.mobilesafe.clean.CleanActivity");</span></div><div class="line"><span class="comment">     * &lt;/code&gt; &lt;p&gt;</span></div><div class="line"><span class="comment">     * 当然，也可以用标准的Android创建方法： &lt;p&gt;</span></div><div class="line"><span class="comment">     * &lt;code&gt;</span></div><div class="line"><span class="comment">     * Intent in = new Intent(); &lt;p&gt;</span></div><div class="line"><span class="comment">     * in.setComponent(new ComponentName("clean", "com.qihoo360.mobilesafe.clean.CleanActivity"));</span></div><div class="line"><span class="comment">     * &lt;/code&gt;</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> pluginName 插件名</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> cls        目标全名</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> 可以被RePlugin识别的Intent</span></div><div class="line"><span class="comment">     * <span class="doctag">@since</span> 1.0.0</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Intent <span class="title">createIntent</span><span class="params">(String pluginName, String cls)</span> </span>&#123;</div><div class="line">        Intent in = <span class="keyword">new</span> Intent();</div><div class="line">        in.setComponent(createComponentName(pluginName, cls));</div><div class="line">        <span class="keyword">return</span> in;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>显然，这个方法的作用是创建一个定向到插件中组件的Intent,所以”demo1”是插件名称，而”com.qihoo360.replugin.sample.demo1.MainActivity”是组件名。</p>
<p>下面看RePlugin.startActivity(Context,Intent)方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">    * 开启一个插件的Activity &lt;p&gt;</span></div><div class="line"><span class="comment">    * 其中Intent的ComponentName的Key应为插件名（而不是包名），可使用createIntent方法来创建Intent对象</span></div><div class="line"><span class="comment">    *</span></div><div class="line"><span class="comment">    * <span class="doctag">@param</span> context Context对象</span></div><div class="line"><span class="comment">    * <span class="doctag">@param</span> intent  要打开Activity的Intent，其中ComponentName的Key必须为插件名</span></div><div class="line"><span class="comment">    * <span class="doctag">@return</span> 插件Activity是否被成功打开？</span></div><div class="line"><span class="comment">    * FIXME 是否需要Exception来做？</span></div><div class="line"><span class="comment">    * <span class="doctag">@see</span> #createIntent(String, String)</span></div><div class="line"><span class="comment">    * <span class="doctag">@since</span> 1.0.0</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">startActivity</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</div><div class="line">       <span class="comment">// TODO 先用旧的开启Activity方案，以后再优化</span></div><div class="line">       ComponentName cn = intent.getComponent();</div><div class="line">       <span class="keyword">if</span> (cn == <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="comment">// TODO 需要支持Action方案</span></div><div class="line">           <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">       &#125;</div><div class="line">       String plugin = cn.getPackageName();</div><div class="line">       String cls = cn.getClassName();</div><div class="line">       <span class="keyword">return</span> Factory.startActivityWithNoInjectCN(context, intent, plugin, cls, IPluginManager.PROCESS_AUTO);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>其实注释已经写得很完整了，就是开启一个插件的Activity,而plugin和cls刚刚在前面已经赋值，分别为”demo1”和”com.qihoo360.replugin.sample.demo1.MainActivity”. 其中IPluginManager.PROCESS_AUTO表示自动分配插件进程。</p>
<ul>
<li><p>2.1.2 Factory.startActivityWithNoInjectCN(Context, Intent, String, String, int)</p>
<p>该方法代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">    * 内部接口，仅为Factory2.startActivity(context, intent) 和 RePlugin.startActivity方法而使用</span></div><div class="line"><span class="comment">    *</span></div><div class="line"><span class="comment">    * <span class="doctag">@param</span> context  应用上下文或者Activity上下文</span></div><div class="line"><span class="comment">    * <span class="doctag">@param</span> intent   Intent对象</span></div><div class="line"><span class="comment">    * <span class="doctag">@param</span> plugin   插件名</span></div><div class="line"><span class="comment">    * <span class="doctag">@param</span> activity 待启动的activity类名</span></div><div class="line"><span class="comment">    * <span class="doctag">@param</span> process  是否在指定进程中启动</span></div><div class="line"><span class="comment">    * <span class="doctag">@return</span> 插件机制层，是否成功，例如没有插件存在、没有合适的Activity坑</span></div><div class="line"><span class="comment">    * Added by Jiongxuan Zhang</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">startActivityWithNoInjectCN</span><span class="params">(Context context, Intent intent, String plugin, String activity, <span class="keyword">int</span> process)</span> </span>&#123;</div><div class="line">       <span class="keyword">boolean</span> result = sPluginManager.startActivity(context, intent, plugin, activity, process);</div><div class="line"></div><div class="line">       RePlugin.getConfig().getEventCallbacks().onStartActivityCompleted(plugin, activity, result);</div><div class="line">       <span class="keyword">return</span> result;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>显然，该方法仅仅是起一个转发以及回调的作用。没什么好分析的，PluginCommImpl.startActivity(Context, Intent, String, String, int)类似，下面就直接进入PluginLibraryInternalProxy.startActivity()的分析。</p>
</li>
<li><p>2.1.3 PluginLibraryInternalProxy.startActivity(Context, Intent, String, String, int, boolean)</p>
<p>该方法如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// FIXME 建议去掉plugin和activity参数，直接用intent代替</span></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * <span class="doctag">@hide</span> 内部方法，插件框架使用</span></div><div class="line"><span class="comment">     * 启动一个插件中的activity，如果插件不存在会触发下载界面</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> context 应用上下文或者Activity上下文</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> intent</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> plugin 插件名</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> activity 待启动的activity类名</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> process 是否在指定进程中启动</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> download 下载</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> 插件机制层是否成功，例如没有插件存在、没有合适的Activity坑</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">startActivity</span><span class="params">(Context context, Intent intent, String plugin, String activity, <span class="keyword">int</span> process, <span class="keyword">boolean</span> download)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (LOG) &#123;</div><div class="line">            LogDebug.d(PLUGIN_TAG, <span class="string">"start activity: intent="</span> + intent + <span class="string">" plugin="</span> + plugin + <span class="string">" activity="</span> + activity + <span class="string">" process="</span> + process + <span class="string">" download="</span> + download);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 是否启动下载</span></div><div class="line">        <span class="comment">// 若插件不可用（不存在或版本不匹配），则直接弹出“下载插件”对话框</span></div><div class="line">        <span class="comment">// 因为已经打开UpdateActivity，故在这里返回True，告诉外界已经打开，无需处理</span></div><div class="line">        <span class="keyword">if</span> (download) &#123;</div><div class="line">            <span class="keyword">if</span> (PluginTable.getPluginInfo(plugin) == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">if</span> (LOG) &#123;</div><div class="line">                    LogDebug.d(PLUGIN_TAG, <span class="string">"plugin="</span> + plugin + <span class="string">" not found, start download ..."</span>);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">// 如果用户在下载即将完成时突然点按“取消”，则有可能出现插件已下载成功，但没有及时加载进来的情况</span></div><div class="line">                <span class="comment">// 因此我们会判断这种情况，如果是，则重新加载一次即可，反之则提示用户下载</span></div><div class="line">                <span class="comment">// 原因：“取消”会触发Task.release方法，最终调用mDownloadTask.destroy，导致“下载服务”的Receiver被注销，即使文件下载了也没有回调回来</span></div><div class="line">                <span class="comment">// NOTE isNeedToDownload方法会调用pluginDownloaded再次尝试加载</span></div><div class="line">                <span class="keyword">if</span> (isNeedToDownload(context, plugin)) &#123;</div><div class="line">                    <span class="keyword">return</span> RePlugin.getConfig().getCallbacks().onPluginNotExistsForActivity(context, plugin, intent, process);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/* 检查是否是动态注册的类 */</span></div><div class="line">        <span class="comment">// 如果要启动的 Activity 是动态注册的类，则不使用坑位机制，而是直接动态类。</span></div><div class="line">        <span class="comment">// 原因：宿主的某些动态注册的类不能运行在坑位中（如'桌面'插件的入口Activity）</span></div><div class="line">        <span class="keyword">if</span> (LOG) &#123;</div><div class="line">            LogDebug.d(<span class="string">"loadClass"</span>, <span class="string">"isHookingClass("</span> + plugin + <span class="string">" , "</span> + activity + <span class="string">") = "</span></div><div class="line">                    + Factory2.isDynamicClass(plugin, activity));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (Factory2.isDynamicClass(plugin, activity)) &#123;</div><div class="line">            intent.putExtra(IPluginManager.KEY_COMPATIBLE, <span class="keyword">true</span>);</div><div class="line">            intent.setComponent(<span class="keyword">new</span> ComponentName(IPC.getPackageName(), activity));</div><div class="line">            context.startActivity(intent);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 如果插件状态出现问题，则每次弹此插件的Activity都应提示无法使用，或提示升级（如有新版）</span></div><div class="line">        <span class="comment">// Added by Jiongxuan Zhang</span></div><div class="line">        <span class="keyword">if</span> (PluginStatusController.getStatus(plugin) &lt; PluginStatusController.STATUS_OK) &#123;</div><div class="line">            <span class="keyword">if</span> (LOG) &#123;</div><div class="line">                LogDebug.d(PLUGIN_TAG, <span class="string">"PluginLibraryInternalProxy.startActivity(): Plugin Disabled. pn="</span> + plugin);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> RePlugin.getConfig().getCallbacks().onPluginNotExistsForActivity(context, plugin, intent, process);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 若为首次加载插件，且是“大插件”，则应异步加载，同时弹窗提示“加载中”</span></div><div class="line">        <span class="comment">// Added by Jiongxuan Zhang</span></div><div class="line">        <span class="keyword">if</span> (!RePlugin.isPluginDexExtracted(plugin)) &#123;</div><div class="line">            PluginDesc pd = PluginDesc.get(plugin);</div><div class="line">            <span class="keyword">if</span> (pd != <span class="keyword">null</span> &amp;&amp; pd.isLarge()) &#123;</div><div class="line">                <span class="keyword">if</span> (LOG) &#123;</div><div class="line">                    LogDebug.d(PLUGIN_TAG, <span class="string">"PM.startActivity(): Large Plugin! p="</span> + plugin);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">return</span> RePlugin.getConfig().getCallbacks().onLoadLargePluginForActivity(context, plugin, intent, process);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// WARNING：千万不要修改intent内容，尤其不要修改其ComponentName</span></div><div class="line">        <span class="comment">// 因为一旦分配坑位有误（或压根不是插件Activity），则外界还需要原封不动的startActivity到系统中</span></div><div class="line">        <span class="comment">// 可防止出现“本来要打开宿主，结果被改成插件”，进而无法打开宿主Activity的问题</span></div><div class="line"></div><div class="line">        <span class="comment">// 缓存打开前的Intent对象，里面将包括Action等内容</span></div><div class="line">        Intent from = <span class="keyword">new</span> Intent(intent);</div><div class="line"></div><div class="line">        <span class="comment">// 帮助填写打开前的Intent的ComponentName信息（如有。没有的情况如直接通过Action打开等）</span></div><div class="line">        <span class="keyword">if</span> (!TextUtils.isEmpty(plugin) &amp;&amp; !TextUtils.isEmpty(activity)) &#123;</div><div class="line">            from.setComponent(<span class="keyword">new</span> ComponentName(plugin, activity));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        ComponentName cn = mPluginMgr.mLocal.loadPluginActivity(intent, plugin, activity, process);</div><div class="line">        <span class="keyword">if</span> (cn == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (LOG) &#123;</div><div class="line">                LogDebug.d(PLUGIN_TAG, <span class="string">"plugin cn not found: intent="</span> + intent + <span class="string">" plugin="</span> + plugin + <span class="string">" activity="</span> + activity + <span class="string">" process="</span> + process);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 将Intent指向到“坑位”。这样：</span></div><div class="line">        <span class="comment">// from：插件原Intent</span></div><div class="line">        <span class="comment">// to：坑位Intent</span></div><div class="line">        intent.setComponent(cn);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (LOG) &#123;</div><div class="line">            LogDebug.d(PLUGIN_TAG, <span class="string">"start activity: real intent="</span> + intent);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        context.startActivity(intent);</div><div class="line"></div><div class="line">        <span class="comment">// 通知外界，已准备好要打开Activity了</span></div><div class="line">        <span class="comment">// 其中：from为要打开的插件的Intent，to为坑位Intent</span></div><div class="line">        RePlugin.getConfig().getEventCallbacks().onPrepareStartPitActivity(context, from, intent);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>这个方法是最长的一个，主要分如下几个部分来分析:</p>
<p>1)如果插件还未下载，则触发下载回调，让用户决定是否下载;</p>
<p>2)检查这个activity类是否为动态类，这里这个类并不是，所以进入下一个判断;</p>
<p>3)如果插件状态出现问题，则也弹出插件不存在的回调，让用户决定下一步如何做;</p>
<p>4)调用RePlugin.isPluginDexExtracted()来判断当前插件是否已经释放了Dex,Native库等，如果没有，则要提示用户正在加载中;</p>
<p>5)下面调用PluginCommImpl.loadPluginActivity(Intent, String, String, int)的方法，这个方法里面涉及到坑位的分配，这是整个RePlugin中非常核心的一部分，内容也非常多，所以单独在下个小节进行分析。</p>
</li>
</ul>
<h3 id="3-Activity坑位的分配–PluginCommImpl分析"><a href="#3-Activity坑位的分配–PluginCommImpl分析" class="headerlink" title="3.Activity坑位的分配–PluginCommImpl分析"></a>3.Activity坑位的分配–PluginCommImpl分析</h3><p>PluginCommImpl.loadPluginActivity(Intent, String, String, int)方法如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">    * 加载插件Activity，在startActivity之前调用</span></div><div class="line"><span class="comment">    * <span class="doctag">@param</span> intent</span></div><div class="line"><span class="comment">    * <span class="doctag">@param</span> plugin 插件名</span></div><div class="line"><span class="comment">    * <span class="doctag">@param</span> target 目标Service名，如果传null，则取获取到的第一个</span></div><div class="line"><span class="comment">    * <span class="doctag">@param</span> process 是否在指定进程中启动</span></div><div class="line"><span class="comment">    * <span class="doctag">@return</span></span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="function"><span class="keyword">public</span> ComponentName <span class="title">loadPluginActivity</span><span class="params">(Intent intent, String plugin, String activity, <span class="keyword">int</span> process)</span> </span>&#123;</div><div class="line"></div><div class="line">       ActivityInfo ai = <span class="keyword">null</span>;</div><div class="line">       String container = <span class="keyword">null</span>;</div><div class="line">       PluginBinderInfo info = <span class="keyword">new</span> PluginBinderInfo(PluginBinderInfo.ACTIVITY_REQUEST);</div><div class="line"></div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           <span class="comment">// 获取 ActivityInfo(可能是其它插件的 Activity，所以这里使用 pair 将 pluginName 也返回)</span></div><div class="line">           ai = getActivityInfo(plugin, activity, intent);</div><div class="line">           <span class="keyword">if</span> (ai == <span class="keyword">null</span>) &#123;</div><div class="line">               <span class="keyword">if</span> (LOG) &#123;</div><div class="line">                   LogDebug.d(PLUGIN_TAG, <span class="string">"PACM: bindActivity: activity not found"</span>);</div><div class="line">               &#125;</div><div class="line">               <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="comment">// 存储此 Activity 在插件 Manifest 中声明主题到 Intent</span></div><div class="line">           intent.putExtra(INTENT_KEY_THEME_ID, ai.theme);</div><div class="line">           <span class="keyword">if</span> (LOG) &#123;</div><div class="line">               LogDebug.d(<span class="string">"theme"</span>, String.format(<span class="string">"intent.putExtra(%s, %s);"</span>, ai.name, ai.theme));</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="comment">// 根据 activity 的 processName，选择进程 ID 标识</span></div><div class="line">           <span class="keyword">if</span> (ai.processName != <span class="keyword">null</span>) &#123;</div><div class="line">               process = PluginClientHelper.getProcessInt(ai.processName);</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="comment">// 容器选择（启动目标进程）</span></div><div class="line">           IPluginClient client = MP.startPluginProcess(plugin, process, info);</div><div class="line">           <span class="keyword">if</span> (client == <span class="keyword">null</span>) &#123;</div><div class="line">               <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="comment">// 远程分配坑位</span></div><div class="line">           container = client.allocActivityContainer(plugin, process, ai.name, intent);</div><div class="line">           <span class="keyword">if</span> (LOG) &#123;</div><div class="line">               LogDebug.i(PLUGIN_TAG, <span class="string">"alloc success: container="</span> + container + <span class="string">" plugin="</span> + plugin + <span class="string">" activity="</span> + activity);</div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">           <span class="keyword">if</span> (LOGR) &#123;</div><div class="line">               LogRelease.e(PLUGIN_TAG, <span class="string">"l.p.a spp|aac: "</span> + e.getMessage(), e);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">// 分配失败</span></div><div class="line">       <span class="keyword">if</span> (TextUtils.isEmpty(container)) &#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       PmBase.cleanIntentPluginParams(intent);</div><div class="line"></div><div class="line">       PluginIntent ii = <span class="keyword">new</span> PluginIntent(intent);</div><div class="line">       ii.setPlugin(plugin);</div><div class="line">       ii.setActivity(ai.name);</div><div class="line">       ii.setProcess(IPluginManager.PROCESS_AUTO);</div><div class="line">       ii.setContainer(container);</div><div class="line">       ii.setCounter(<span class="number">0</span>);</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> ComponentName(IPC.getPackageName(), container);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>这个方法主要分为如下几个部分。</p>
<h4 id="3-1-PluginCommImpl-getActivityInfo-String-String-Intent"><a href="#3-1-PluginCommImpl-getActivityInfo-String-String-Intent" class="headerlink" title="3.1 PluginCommImpl.getActivityInfo(String,String,Intent)"></a>3.1 PluginCommImpl.getActivityInfo(String,String,Intent)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">    * 根据条件，查找 ActivityInfo 对象</span></div><div class="line"><span class="comment">    *</span></div><div class="line"><span class="comment">    * <span class="doctag">@param</span> plugin   插件名称</span></div><div class="line"><span class="comment">    * <span class="doctag">@param</span> activity Activity 名称</span></div><div class="line"><span class="comment">    * <span class="doctag">@param</span> intent   调用者传递过来的 Intent</span></div><div class="line"><span class="comment">    * <span class="doctag">@return</span> 插件中 Activity 的 ActivityInfo</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="function"><span class="keyword">public</span> ActivityInfo <span class="title">getActivityInfo</span><span class="params">(String plugin, String activity, Intent intent)</span> </span>&#123;</div><div class="line">       <span class="comment">// 获取插件对象</span></div><div class="line">       Plugin p = mPluginMgr.loadAppPlugin(plugin);</div><div class="line">       <span class="keyword">if</span> (p == <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">if</span> (LOG) &#123;</div><div class="line">               LogDebug.d(PLUGIN_TAG, <span class="string">"PACM: bindActivity: may be invalid plugin name or load plugin failed: plugin="</span> + p);</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       ActivityInfo ai = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">       <span class="comment">// activity 不为空时，从插件声明的 Activity 集合中查找</span></div><div class="line">       <span class="keyword">if</span> (!TextUtils.isEmpty(activity)) &#123;</div><div class="line">           ai = p.mLoader.mComponents.getActivity(activity);</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           <span class="comment">// activity 为空时，根据 Intent 匹配</span></div><div class="line">           ai = IntentMatcherHelper.getActivityInfo(mContext, plugin, intent);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> ai;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>这个方法的逻辑很简单，就是先加载插件，然后从插件的组件信息中获取ActivityInfo对象。可见，重点在于PmBase.loadAppPlugin(String)的调用，方法如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> Plugin <span class="title">loadAppPlugin</span><span class="params">(String plugin)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> loadPlugin(mPlugins.get(plugin), Plugin.LOAD_APP, <span class="keyword">true</span>);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>这里的3个参数都很重要，首先看mPlugins是如何来的。</p>
<p>mPlugins其实包含的就量插件信息，key为插件的包名或别名，而value则为插件对象。它其实是在常驻进程初始化时赋值的。当然，中间如果安装了新的插件，mPlugins中的信息也会有更新。</p>
<p>mPlugins的初始化流程如下:</p>
<img src="/images/android/replugin/replugin_pmbase_init_flow.png">
<h5 id="3-1-1-插件信息的加载"><a href="#3-1-1-插件信息的加载" class="headerlink" title="3.1.1 插件信息的加载"></a>3.1.1 插件信息的加载</h5><p>首先看一下插件信息是如何来的，关注initForServer()中调用的Builder.builder()方法.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">builder</span><span class="params">(Context context, PxAll all)</span> </span>&#123;</div><div class="line">      <span class="comment">// 搜索所有本地插件和V5插件</span></div><div class="line">      Finder.search(context, all);</div><div class="line"></div><div class="line">      <span class="comment">// 删除不适配的PLUGINs</span></div><div class="line">      <span class="keyword">for</span> (PluginInfo p : all.getOthers()) &#123;</div><div class="line">          <span class="comment">// TODO 如果已存在built-in和V5则不删除</span></div><div class="line">          <span class="keyword">if</span> (LOG) &#123;</div><div class="line">              LogDebug.d(PLUGIN_TAG, <span class="string">"delete obsolote plugin="</span> + p);</div><div class="line">          &#125;</div><div class="line">          <span class="keyword">boolean</span> rc = p.deleteObsolote(context);</div><div class="line">          <span class="keyword">if</span> (!rc) &#123;</div><div class="line">              <span class="keyword">if</span> (LOG) &#123;</div><div class="line">                  LogDebug.d(PLUGIN_TAG, <span class="string">"can't delete obsolote plugin="</span> + p);</div><div class="line">              &#125;</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">// 删除所有和PLUGINs不一致的DEX文件</span></div><div class="line">      deleteUnknownDexs(context, all);</div><div class="line"></div><div class="line">      <span class="comment">// 删除所有和PLUGINs不一致的SO库目录</span></div><div class="line">      <span class="comment">// Added by Jiongxuan Zhang</span></div><div class="line">      deleteUnknownLibs(context, all);</div><div class="line"></div><div class="line">      <span class="comment">// 构建数据</span></div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>其中的重点在于Finder.search()这个方法调用，因为它会搜索所有本地插件和V5插件，如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">* 扫描插件</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">search</span><span class="params">(Context context, PxAll all)</span> </span>&#123;</div><div class="line">      <span class="comment">// 扫描内置插件</span></div><div class="line">      FinderBuiltin.loadPlugins(context, all);</div><div class="line"></div><div class="line">      <span class="comment">// 扫描V5插件</span></div><div class="line">      File pluginDir = context.getDir(Constant.LOCAL_PLUGIN_SUB_DIR, <span class="number">0</span>);</div><div class="line">      V5Finder.search(context, pluginDir, all);</div><div class="line"></div><div class="line">      <span class="comment">// 扫描现有插件，包括刚才从V5插件文件更新过来的文件</span></div><div class="line">      HashSet&lt;File&gt; deleted = <span class="keyword">new</span> HashSet&lt;File&gt;();</div><div class="line">      &#123;</div><div class="line">          <span class="keyword">if</span> (LOG) &#123;</div><div class="line">              LogDebug.d(PLUGIN_TAG, <span class="string">"search plugins: dir="</span> + pluginDir.getAbsolutePath());</div><div class="line">          &#125;</div><div class="line">          searchLocalPlugins(pluginDir, all, deleted);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">// 删除非插件文件和坏的文件</span></div><div class="line">      <span class="keyword">for</span> (File f : deleted) &#123;</div><div class="line">          <span class="keyword">if</span> (LOG) &#123;</div><div class="line">              LogDebug.d(PLUGIN_TAG, <span class="string">"search: delete plugin dir invalid file="</span> + f.getAbsolutePath());</div><div class="line">          &#125;</div><div class="line">          <span class="keyword">boolean</span> rc = f.delete();</div><div class="line">          <span class="keyword">if</span> (!rc) &#123;</div><div class="line">              <span class="keyword">if</span> (LOG) &#123;</div><div class="line">                  LogDebug.d(PLUGIN_TAG, <span class="string">"search: can't delete plugin dir invalid file="</span> + f.getAbsolutePath());</div><div class="line">              &#125;</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line">      deleted.clear();</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>真正执行查询的是FinderBuiltin.loadPlugins()这个方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function">tatic <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">loadPlugins</span><span class="params">(Context context, PxAll all)</span> </span>&#123;</div><div class="line">        InputStream in;</div><div class="line"></div><div class="line">        <span class="comment">// 读取内部配置</span></div><div class="line">        in = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            in = context.getAssets().open(<span class="string">"plugins-builtin.json"</span>);</div><div class="line">            <span class="comment">// TODO 简化参数 all</span></div><div class="line">            readConfig(in, all);</div><div class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e0) &#123;</div><div class="line">            <span class="keyword">if</span> (LOG) &#123;</div><div class="line">                LogDebug.e(PLUGIN_TAG, <span class="string">"plugins-builtin.json"</span> + <span class="string">" not found"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">            <span class="keyword">if</span> (LOG) &#123;</div><div class="line">                LogDebug.d(PLUGIN_TAG, e.getMessage(), e);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        CloseableUtils.closeQuietly(in);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>显然，这里就是查询assets目录下的plugins-builtin.json这个文件，获取所有内建的插件信息，该文件示例如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[&#123;<span class="string">"high"</span>:<span class="keyword">null</span>,<span class="string">"frm"</span>:<span class="keyword">null</span>,<span class="string">"ver"</span>:<span class="number">100</span>,<span class="string">"low"</span>:<span class="keyword">null</span>,<span class="string">"pkg"</span>:<span class="string">"com.qihoo360.replugin.sample.demo1"</span>,<span class="string">"path"</span>:<span class="string">"plugins/demo1.jar"</span>,<span class="string">"name"</span>:<span class="string">"demo1"</span>&#125;,&#123;<span class="string">"high"</span>:<span class="keyword">null</span>,<span class="string">"frm"</span>:<span class="keyword">null</span>,<span class="string">"ver"</span>:<span class="number">100</span>,<span class="string">"low"</span>:<span class="keyword">null</span>,<span class="string">"pkg"</span>:<span class="string">"com.qihoo360.replugin.sample.demo2"</span>,<span class="string">"path"</span>:<span class="string">"plugins/demo2.jar"</span>,<span class="string">"name"</span>:<span class="string">"demo2"</span>&#125;]</div></pre></td></tr></table></figure>
<p>而读取里面的json信息的代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">readConfig</span><span class="params">(InputStream in, PxAll all)</span> <span class="keyword">throws</span> IOException, JSONException </span>&#123;</div><div class="line">        String str = IOUtils.toString(in, Charsets.UTF_8);</div><div class="line">        JSONArray ja = <span class="keyword">new</span> JSONArray(str);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ja.length(); i++) &#123;</div><div class="line">            JSONObject jo = ja.getJSONObject(i);</div><div class="line">            <span class="keyword">if</span> (jo == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line">            String name = jo.getString(<span class="string">"name"</span>);</div><div class="line">            <span class="keyword">if</span> (TextUtils.isEmpty(name)) &#123;</div><div class="line">                <span class="keyword">if</span> (LOG) &#123;</div><div class="line">                    LogDebug.d(PLUGIN_TAG, <span class="string">"built-in plugins config: invalid item: name is empty, json="</span> + jo);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line">            PluginInfo info = PluginInfo.buildFromBuiltInJson(jo);</div><div class="line">            <span class="keyword">if</span> (!info.match()) &#123;</div><div class="line">                <span class="keyword">if</span> (LOG) &#123;</div><div class="line">                    LogDebug.e(PLUGIN_TAG, <span class="string">"built-in plugins config: mismatch item: "</span> + info);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (LOG) &#123;</div><div class="line">                LogDebug.d(PLUGIN_TAG, <span class="string">"built-in plugins config: item: "</span> + info);</div><div class="line">            &#125;</div><div class="line">            all.addBuiltin(info);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> PluginInfo <span class="title">buildFromBuiltInJson</span><span class="params">(JSONObject jo)</span> </span>&#123;</div><div class="line">        String pkgName = jo.optString(<span class="string">"pkg"</span>);</div><div class="line">        String name = jo.optString(<span class="string">"name"</span>);</div><div class="line">        String assetName = jo.optString(<span class="string">"path"</span>);</div><div class="line">        <span class="keyword">if</span> (TextUtils.isEmpty(name) || TextUtils.isEmpty(pkgName) || TextUtils.isEmpty(assetName)) &#123;</div><div class="line">            <span class="keyword">if</span> (LogDebug.LOG) &#123;</div><div class="line">                LogDebug.d(TAG, <span class="string">"buildFromBuiltInJson: Invalid json. j="</span> + jo);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">int</span> low = jo.optInt(<span class="string">"low"</span>, Constant.ADAPTER_COMPATIBLE_VERSION);    <span class="comment">// Low应指向最低兼容版本</span></div><div class="line">        <span class="keyword">int</span> high = jo.optInt(<span class="string">"high"</span>, Constant.ADAPTER_COMPATIBLE_VERSION);  <span class="comment">// High同上</span></div><div class="line">        <span class="keyword">int</span> ver = jo.optInt(<span class="string">"ver"</span>);</div><div class="line">        PluginInfo info = <span class="keyword">new</span> PluginInfo(pkgName, name, low, high, ver, assetName, TYPE_BUILTIN);</div><div class="line"></div><div class="line">        <span class="comment">// 从 json 中读取 frameVersion（可选）</span></div><div class="line">        <span class="keyword">int</span> frameVer = jo.optInt(<span class="string">"frm"</span>);</div><div class="line">        <span class="keyword">if</span> (frameVer &lt; <span class="number">1</span>) &#123;</div><div class="line">            frameVer = RePlugin.getConfig().getDefaultFrameworkVersion();</div><div class="line">        &#125;</div><div class="line">        info.setFrameworkVersion(frameVer);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> info;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>其实就是读取json信息然后赋值给PluginInfo,其实PluginInfo本来应该设计成一个标准的Java bean,<strong>而现在竟然仍然用JSONObject来保存信息，然后后面需要时又要读出来，这其实是一个不太好的设计</strong>。</p>
<h5 id="3-1-2-initForServer"><a href="#3-1-2-initForServer" class="headerlink" title="3.1.2 initForServer()"></a>3.1.2 initForServer()</h5><p>如果允许开启常驻进程来管理插件进程，则在在首次启动:GuardService这个常驻进程时，会调用initForServer()进行初始化:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">    * Persistent(常驻)进程的初始化</span></div><div class="line"><span class="comment">    *</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">initForServer</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (LOG) &#123;</div><div class="line">           LogDebug.d(PLUGIN_TAG, <span class="string">"search plugins from file system"</span>);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       mHostSvc = <span class="keyword">new</span> PmHostSvc(mContext, <span class="keyword">this</span>);</div><div class="line">       PluginProcessMain.installHost(mHostSvc);</div><div class="line">       PluginProcessMain.schedulePluginProcessLoop(PluginProcessMain.CHECK_STAGE1_DELAY);</div><div class="line"></div><div class="line">       <span class="comment">// 兼容即将废弃的p-n方案 by Jiongxuan Zhang</span></div><div class="line">       mAll = <span class="keyword">new</span> Builder.PxAll();</div><div class="line">       Builder.builder(mContext, mAll);</div><div class="line">       refreshPluginMap(mAll.getPlugins());</div><div class="line"></div><div class="line">       <span class="comment">// [Newest!] 使用全新的RePlugin APK方案</span></div><div class="line">       <span class="comment">// Added by Jiongxuan Zhang</span></div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           List&lt;PluginInfo&gt; l = PluginManagerProxy.load();</div><div class="line">           <span class="keyword">if</span> (l != <span class="keyword">null</span>) &#123;</div><div class="line">               <span class="comment">// 将"纯APK"插件信息并入总的插件信息表中，方便查询</span></div><div class="line">               <span class="comment">// 这里有可能会覆盖之前在p-n中加入的信息。本来我们就想这么干，以"纯APK"插件为准</span></div><div class="line">               refreshPluginMap(l);</div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">           <span class="keyword">if</span> (LOGR) &#123;</div><div class="line">               LogRelease.e(PLUGIN_TAG, <span class="string">"lst.p: "</span> + e.getMessage(), e);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>在其中的refreshPluginMap()中会进行mPlugins的赋值:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">     * 更新所有的插件信息</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> plugins</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">refreshPluginMap</span><span class="params">(List&lt;PluginInfo&gt; plugins)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (plugins == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span> (PluginInfo info : plugins) &#123;</div><div class="line">            Plugin plugin = Plugin.build(info);</div><div class="line">            putPluginObject(info, plugin);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">putPluginObject</span><span class="params">(PluginInfo info, Plugin plugin)</span> </span>&#123;</div><div class="line">        <span class="comment">// 同时加入PackageName和Alias（如有）</span></div><div class="line">        mPlugins.put(info.getPackageName(), plugin);</div><div class="line">        <span class="keyword">if</span> (!TextUtils.isEmpty(info.getAlias())) &#123;</div><div class="line">            <span class="comment">// 即便Alias和包名相同也可以再Put一次，反正只是覆盖了相同Value而已</span></div><div class="line">            mPlugins.put(info.getAlias(), plugin);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>可见，首先根据之前的插件信息生成Plugin对象，然后分别以插件的包名和别名为key,以Plugin对象作为value插入到mPlugins中，经过初始化后，Demo中的结果如下图:</p>
<img src="/images/android/replugin/mPlugins.png">
<p>所以，再回到PluginCommImpl.getActivityInfo()这个方法，显然可以根据”demo1”这个别名获取到对应的Plugin对象。</p>
<h5 id="3-1-3-mComponents"><a href="#3-1-3-mComponents" class="headerlink" title="3.1.3 mComponents"></a>3.1.3 mComponents</h5><p>到这里为止，我们只是分析了读取插件信息并且创建Plugin对象的过程，但是还没有分析完插件的加载过程，实际上插件的加载涉及到dex文件，so库等的处理。</p>
<p>而内建插件的加载流程如下:</p>
<img src="/images/android/replugin/load_plugin_flow.png">
<ul>
<li><p>Plugin.load(int, boolean)方法如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">load</span><span class="params">(<span class="keyword">int</span> load, <span class="keyword">boolean</span> useCache)</span> </span>&#123;</div><div class="line">        PluginInfo info = mInfo;</div><div class="line">        <span class="keyword">boolean</span> rc = loadLocked(load, useCache);</div><div class="line">        <span class="comment">// 尝试在此处调用Application.onCreate方法</span></div><div class="line">        <span class="comment">// Added by Jiongxuan Zhang</span></div><div class="line">        <span class="keyword">if</span> (load == LOAD_APP &amp;&amp; rc) &#123;</div><div class="line">            callApp();</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 如果info改了，通知一下常驻</span></div><div class="line">        <span class="comment">// 只针对P-n的Type转化来处理，一定要通知，这样Framework_Version也会得到更新</span></div><div class="line">        <span class="keyword">if</span> (rc &amp;&amp; mInfo != info) &#123;</div><div class="line">            UpdateInfoTask task = <span class="keyword">new</span> UpdateInfoTask((PluginInfo) mInfo.clone());</div><div class="line">            Tasks.post2Thread(task);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> rc;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>显然，这个方法是先调用loadLocked()方法完成加载，然后调用callApp()以调用到插件的Application.onCreate()方法。</p>
</li>
<li><p>loadLocked()方法如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">loadLocked</span><span class="params">(<span class="keyword">int</span> load, <span class="keyword">boolean</span> useCache)</span> </span>&#123;</div><div class="line">       <span class="comment">// 若插件被“禁用”，则即便上次加载过（且进程一直活着），这次也不能再次使用了</span></div><div class="line">       <span class="comment">// Added by Jiongxuan Zhang</span></div><div class="line">       <span class="keyword">int</span> status = PluginStatusController.getStatus(mInfo.getName(), mInfo.getVersion());</div><div class="line">       <span class="keyword">if</span> (status &lt; PluginStatusController.STATUS_OK) &#123;</div><div class="line">           <span class="keyword">if</span> (LOG) &#123;</div><div class="line">               LogDebug.d(PLUGIN_TAG, <span class="string">"loadLocked(): Disable in="</span> + mInfo.getName() + <span class="string">":"</span> + mInfo.getVersion() + <span class="string">"; st="</span> + status);</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (mInitialized) &#123;</div><div class="line">           <span class="keyword">if</span> (mLoader == <span class="keyword">null</span>) &#123;</div><div class="line">               <span class="keyword">if</span> (LOG) &#123;</div><div class="line">                   LogDebug.i(MAIN_TAG, <span class="string">"loadLocked(): Initialized but mLoader is Null"</span>);</div><div class="line">               &#125;</div><div class="line">               <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">if</span> (load == LOAD_INFO) &#123;</div><div class="line">               <span class="keyword">boolean</span> rl = mLoader.isPackageInfoLoaded();</div><div class="line">               <span class="keyword">if</span> (LOG) &#123;</div><div class="line">                   LogDebug.i(MAIN_TAG, <span class="string">"loadLocked(): Initialized, pkginfo loaded = "</span> + rl);</div><div class="line">               &#125;</div><div class="line">               <span class="keyword">return</span> rl;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">if</span> (load == LOAD_RESOURCES) &#123;</div><div class="line">               <span class="keyword">boolean</span> rl = mLoader.isResourcesLoaded();</div><div class="line">               <span class="keyword">if</span> (LOG) &#123;</div><div class="line">                   LogDebug.i(MAIN_TAG, <span class="string">"loadLocked(): Initialized, resource loaded = "</span> + rl);</div><div class="line">               &#125;</div><div class="line">               <span class="keyword">return</span> rl;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">if</span> (load == LOAD_DEX) &#123;</div><div class="line">               <span class="keyword">boolean</span> rl = mLoader.isDexLoaded();</div><div class="line">               <span class="keyword">if</span> (LOG) &#123;</div><div class="line">                   LogDebug.i(MAIN_TAG, <span class="string">"loadLocked(): Initialized, dex loaded = "</span> + rl);</div><div class="line">               &#125;</div><div class="line">               <span class="keyword">return</span> rl;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">boolean</span> il = mLoader.isAppLoaded();</div><div class="line">           <span class="keyword">if</span> (LOG) &#123;</div><div class="line">               LogDebug.i(MAIN_TAG, <span class="string">"loadLocked(): Initialized, is loaded = "</span> + il);</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">return</span> il;</div><div class="line">       &#125;</div><div class="line">       mInitialized = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">       <span class="comment">// 若开启了“打印详情”则打印调用栈，便于观察</span></div><div class="line">       <span class="keyword">if</span> (RePlugin.getConfig().isPrintDetailLog()) &#123;</div><div class="line">           String reason = <span class="string">""</span>;</div><div class="line">           reason += <span class="string">"--- plugin: "</span> + mInfo.getName() + <span class="string">" ---\n"</span>;</div><div class="line">           reason += <span class="string">"load="</span> + load + <span class="string">"\n"</span>;</div><div class="line">           StackTraceElement elements[] = Thread.currentThread().getStackTrace();</div><div class="line">           <span class="keyword">for</span> (StackTraceElement item : elements) &#123;</div><div class="line">               <span class="keyword">if</span> (item.isNativeMethod()) &#123;</div><div class="line">                   <span class="keyword">continue</span>;</div><div class="line">               &#125;</div><div class="line">               String cn = item.getClassName();</div><div class="line">               String mn = item.getMethodName();</div><div class="line">               String filename = item.getFileName();</div><div class="line">               <span class="keyword">int</span> line = item.getLineNumber();</div><div class="line">               <span class="keyword">if</span> (LOG) &#123;</div><div class="line">                   LogDebug.i(PLUGIN_TAG, cn + <span class="string">"."</span> + mn + <span class="string">"("</span> + filename + <span class="string">":"</span> + line + <span class="string">")"</span>);</div><div class="line">               &#125;</div><div class="line">               reason += cn + <span class="string">"."</span> + mn + <span class="string">"("</span> + filename + <span class="string">":"</span> + line + <span class="string">")"</span> + <span class="string">"\n"</span>;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">if</span> (sLoadedReasons == <span class="keyword">null</span>) &#123;</div><div class="line">               sLoadedReasons = <span class="keyword">new</span> ArrayList&lt;String&gt;();</div><div class="line">           &#125;</div><div class="line">           sLoadedReasons.add(reason);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">// 这里先处理一下，如果cache命中，省了后面插件提取（如释放Jar包等）操作</span></div><div class="line">       <span class="keyword">if</span> (useCache) &#123;</div><div class="line">           <span class="keyword">boolean</span> result = loadByCache(load);</div><div class="line">           <span class="comment">// 如果缓存命中，则直接返回</span></div><div class="line">           <span class="keyword">if</span> (result) &#123;</div><div class="line">               <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       Context context = mContext;</div><div class="line">       ClassLoader parent = mParent;</div><div class="line">       PluginCommImpl manager = mPluginManager;</div><div class="line"></div><div class="line">       <span class="comment">//</span></div><div class="line">       String logTag = <span class="string">"try1"</span>;</div><div class="line">       String lockFileName = String.format(Constant.LOAD_PLUGIN_LOCK, mInfo.getApkFile().getName());</div><div class="line">       ProcessLocker lock = <span class="keyword">new</span> ProcessLocker(context, lockFileName);</div><div class="line">       <span class="keyword">if</span> (LOG) &#123;</div><div class="line">           LogDebug.i(PLUGIN_TAG, <span class="string">"loadLocked(): Ready to lock! logtag = "</span> + logTag + <span class="string">"; pn = "</span> + mInfo.getName());</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (!lock.tryLockTimeWait(<span class="number">5000</span>, <span class="number">10</span>)) &#123;</div><div class="line">           <span class="comment">// 此处仅仅打印错误</span></div><div class="line">           <span class="keyword">if</span> (LOGR) &#123;</div><div class="line">               LogRelease.w(PLUGIN_TAG, logTag + <span class="string">": failed to lock: can't wait plugin ready"</span>);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       <span class="comment">//</span></div><div class="line">       <span class="keyword">long</span> t1 = System.currentTimeMillis();</div><div class="line">       <span class="keyword">boolean</span> rc = doLoad(logTag, context, parent, manager, load);</div><div class="line">       <span class="keyword">if</span> (LOG) &#123;</div><div class="line">           LogDebug.i(PLUGIN_TAG, <span class="string">"load "</span> + mInfo.getPath() + <span class="string">" "</span> + hashCode() + <span class="string">" c="</span> + load + <span class="string">" rc="</span> + rc + <span class="string">" delta="</span> + (System.currentTimeMillis() - t1));</div><div class="line">       &#125;</div><div class="line">       <span class="comment">//</span></div><div class="line">       lock.unlock();</div><div class="line">       <span class="keyword">if</span> (LOG) &#123;</div><div class="line">           LogDebug.i(PLUGIN_TAG, <span class="string">"loadLocked(): Unlock! logtag = "</span> + logTag + <span class="string">"; pn = "</span> + mInfo.getName());</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (!rc) &#123;</div><div class="line">           <span class="keyword">if</span> (LOGR) &#123;</div><div class="line">               LogRelease.e(PLUGIN_TAG, logTag + <span class="string">": loading fail1"</span>);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (rc) &#123;</div><div class="line">           <span class="comment">// 打印当前内存占用情况，只针对Dex和App加载做输出</span></div><div class="line">           <span class="comment">// 只有开启“详细日志”才会输出，防止“消耗性能”</span></div><div class="line">           <span class="keyword">if</span> (LOG &amp;&amp; RePlugin.getConfig().isPrintDetailLog()) &#123;</div><div class="line">               <span class="keyword">if</span> (load == LOAD_DEX || load == LOAD_APP) &#123;</div><div class="line">                   LogDebug.printPluginInfo(mInfo, load);</div><div class="line">                   LogDebug.printMemoryStatus(LogDebug.TAG, <span class="string">"act=, loadLocked, flag=, End-1, pn=, "</span> + mInfo.getName() + <span class="string">", type=, "</span> + load);</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">try</span> &#123;</div><div class="line">               <span class="comment">// 至此，该插件已开始运行</span></div><div class="line">               PluginManagerProxy.addToRunningPluginsNoThrows(mInfo.getName());</div><div class="line">           &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">               <span class="keyword">if</span> (LOGR) &#123;</div><div class="line">                   LogRelease.e(PLUGIN_TAG, <span class="string">"p.u.1: "</span> + e.getMessage(), e);</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">//</span></div><div class="line">       logTag = <span class="string">"try2"</span>;</div><div class="line">       lock = <span class="keyword">new</span> ProcessLocker(context, lockFileName);</div><div class="line">       <span class="keyword">if</span> (!lock.tryLockTimeWait(<span class="number">5000</span>, <span class="number">10</span>)) &#123;</div><div class="line">           <span class="comment">// 此处仅仅打印错误</span></div><div class="line">           <span class="keyword">if</span> (LOGR) &#123;</div><div class="line">               LogRelease.w(PLUGIN_TAG, logTag + <span class="string">": failed to lock: can't wait plugin ready"</span>);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// 清空数据对象</span></div><div class="line">       mLoader = <span class="keyword">null</span>;</div><div class="line">       <span class="comment">// 删除优化dex文件</span></div><div class="line">       File odex = mInfo.getDexFile();</div><div class="line">       <span class="keyword">if</span> (odex.exists()) &#123;</div><div class="line">           <span class="keyword">if</span> (LOG) &#123;</div><div class="line">               LogDebug.d(PLUGIN_TAG, logTag + <span class="string">": delete exist odex="</span> + odex.getAbsolutePath());</div><div class="line">           &#125;</div><div class="line">           odex.delete();</div><div class="line">       &#125;</div></pre></td></tr></table></figure>
<pre><code>    if (Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.LOLLIPOP) {
        // support for multidex below LOLLIPOP:delete Extra odex,if need
        try {
            FileUtils.forceDelete(mInfo.getExtraOdexDir());
        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    t1 = System.currentTimeMillis();
    rc = doLoad(logTag, context, parent, manager, load);
    if (LOG) {
        LogDebug.i(PLUGIN_TAG, &quot;load2 &quot; + mInfo.getPath() + &quot; &quot; + hashCode() + &quot; c=&quot; + load + &quot; rc=&quot; + rc + &quot; delta=&quot; + (System.currentTimeMillis() - t1));
    }
    //
    lock.unlock();
    if (!rc) {
        if (LOGR) {
            LogRelease.e(PLUGIN_TAG, logTag + &quot;: loading fail2&quot;);
        }
        return false;
    }

    // 打印当前内存占用情况，只针对Dex和App加载做输出
    // 只有开启“详细日志”才会输出，防止“消耗性能”
    if (LOG &amp;&amp; RePlugin.getConfig().isPrintDetailLog()) {
        if (load == LOAD_DEX || load == LOAD_APP) {
            LogDebug.printPluginInfo(mInfo, load);
            LogDebug.printMemoryStatus(LogDebug.TAG, &quot;act=, loadLocked, flag=, End-2, pn=, &quot; + mInfo.getName() + &quot;, type=, &quot; + load);
        }
    }

    try {
        // 至此，该插件已开始运行
        PluginManagerProxy.addToRunningPluginsNoThrows(mInfo.getName());
    } catch (Throwable e) {
        if (LOGR) {
            LogRelease.e(PLUGIN_TAG, &quot;p.u.2: &quot; + e.getMessage(), e);
        }
    }

    return true;
}
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">  ​</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">#### 2.2 进入插件后的startActivity()调用</div><div class="line"></div><div class="line">Factory2也只是起一个封装作用，即它只是调用PluginLibraryInternalProxy中相应的方法来完成操作，Factory2中的startActivity(Context,Intent)方法就是调用了PluginLibraryInternalProxy的startActivity(Context,Intent)方法:</div><div class="line"></div><div class="line">​```java</div><div class="line"> /**</div><div class="line">     * @hide 内部方法，插件框架使用</div><div class="line">     * 启动一个插件中的activity</div><div class="line">     * 通过Extra参数IPluginManager.KEY_COMPATIBLE，IPluginManager.KEY_PLUGIN，IPluginManager.KEY_ACTIVITY，IPluginManager.KEY_PROCESS控制</div><div class="line">     * @param context Context上下文</div><div class="line">     * @param intent</div><div class="line">     * @return 插件机制层是否成功，例如没有插件存在、没有合适的Activity坑</div><div class="line">     */</div><div class="line">    public boolean startActivity(Context context, Intent intent) &#123;</div><div class="line">        if (LOG) &#123;</div><div class="line">            LogDebug.d(PLUGIN_TAG, &quot;start context: intent=&quot; + intent);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // 兼容模式，直接使用标准方式启动</div><div class="line">        if (intent.getBooleanExtra(IPluginManager.KEY_COMPATIBLE, false)) &#123;</div><div class="line">            PmBase.cleanIntentPluginParams(intent);</div><div class="line">            if (LOG) &#123;</div><div class="line">                LogDebug.d(PLUGIN_TAG, &quot;start context: COMPATIBLE is true, direct start&quot;);</div><div class="line">            &#125;</div><div class="line">            return false;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // 获取Activity的名字，有两种途径：</div><div class="line">        // 1. 从Intent里取。通常是明确知道要打开的插件的Activity时会用</div><div class="line">        // 2. 从Intent的ComponentName中获取</div><div class="line">        String name = intent.getStringExtra(IPluginManager.KEY_ACTIVITY);</div><div class="line">        if (TextUtils.isEmpty(name)) &#123;</div><div class="line">            ComponentName cn = intent.getComponent();</div><div class="line">            if (cn != null) &#123;</div><div class="line">                name = cn.getClassName();</div><div class="line">                if (LOG) &#123;</div><div class="line">                    LogDebug.d(PLUGIN_TAG, &quot;start context: custom context=&quot; + context);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // 已经是标准坑了（例如N1ST1这样的），则无需再过“坑位分配”逻辑，直接使用标准方式启动</div><div class="line">        if (mPluginMgr.isActivity(name)) &#123;</div><div class="line">            PmBase.cleanIntentPluginParams(intent);</div><div class="line">            if (LOG) &#123;</div><div class="line">                LogDebug.d(PLUGIN_TAG, &quot;start context: context is container, direct start&quot;);</div><div class="line">            &#125;</div><div class="line">            return false;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // 获取插件名，有三种途径：</div><div class="line">        // 1. 从Intent里取。通常是明确知道要打开的插件时会用</div><div class="line">        // 2. 根据当前Activity的坑位名来“反查”其插件名。通常是插件内开启自己的Activity时用到</div><div class="line">        // 3. 通过获得Context的类加载器来判断其插件名</div><div class="line">        String plugin = intent.getStringExtra(IPluginManager.KEY_PLUGIN);</div><div class="line"></div><div class="line">        /* 检查是否是动态注册的类 */</div><div class="line">        // 如果要启动的 Activity 是动态注册的类，则不使用坑位机制，而是直接动态类。</div><div class="line">        // 原因：宿主的某些动态注册的类不能运行在坑位中（如&apos;桌面&apos;插件的入口Activity）</div><div class="line">        ComponentName componentName = intent.getComponent();</div><div class="line">        if (componentName != null) &#123;</div><div class="line"></div><div class="line">	        if (LogDebug.LOG) &#123;</div><div class="line">	            LogDebug.d(&quot;loadClass&quot;, &quot;isHookingClass(&quot; + plugin + &quot;,&quot; + componentName.getClassName() + &quot;) = &quot;</div><div class="line">	                    + isDynamicClass(plugin, componentName.getClassName()));</div><div class="line">	        &#125;</div><div class="line">	        if (isDynamicClass(plugin, componentName.getClassName())) &#123;</div><div class="line">                intent.putExtra(IPluginManager.KEY_COMPATIBLE, true);</div><div class="line">	            intent.setComponent(new ComponentName(IPC.getPackageName(), componentName.getClassName()));</div><div class="line">	            context.startActivity(intent);</div><div class="line">	            return false;</div><div class="line">	        &#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">        if (TextUtils.isEmpty(plugin)) &#123;</div><div class="line">            // 看下Context是否为Activity，如是则直接从坑位中获取插件名（最准确）</div><div class="line">            if (context instanceof Activity) &#123;</div><div class="line">                plugin = fetchPluginByPitActivity((Activity) context);</div><div class="line">            &#125;</div><div class="line">            if (LOG) &#123;</div><div class="line">                LogDebug.d(PLUGIN_TAG, &quot;start context: custom plugin is empty, query plugin=&quot; + plugin);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // 没拿到插件名？再从 ClassLoader 获取插件名称（兜底）</div><div class="line">        if (TextUtils.isEmpty(plugin)) &#123;</div><div class="line">            plugin = RePlugin.fetchPluginNameByClassLoader(context.getClassLoader());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // 仍然拿不到插件名？（例如从宿主中调用），则打开的Activity可能是宿主的。直接使用标准方式启动</div><div class="line">        if (TextUtils.isEmpty(plugin)) &#123;</div><div class="line">            PmBase.cleanIntentPluginParams(intent);</div><div class="line">            if (LOG) &#123;</div><div class="line">                LogDebug.d(PLUGIN_TAG, &quot;start context: plugin and context is empty, direct start&quot;);</div><div class="line">            &#125;</div><div class="line">            return false;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // 获取进程值，看目标Activity要打开哪个进程</div><div class="line">        int process = intent.getIntExtra(IPluginManager.KEY_PROCESS, Integer.MIN_VALUE);</div><div class="line"></div><div class="line">        PmBase.cleanIntentPluginParams(intent);</div><div class="line"></div><div class="line">        // 调用“特殊版”的startActivity，不让自动填写ComponentName，防止外界再用时出错</div><div class="line">        return Factory.startActivityWithNoInjectCN(context, intent, plugin, name, process);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="2-上下文替换"><a href="#2-上下文替换" class="headerlink" title="2.上下文替换"></a>2.上下文替换</h3>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/04/hello-world/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Allen Wang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="AllenWang的个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/04/hello-world/" itemprop="url">Hello World</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-04T04:20:38+08:00">
                2017-12-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="external">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="external">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="external">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="external">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo new <span class="string">"My New Post"</span></div></pre></td></tr></table></figure>
<p>More info
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2017/12/04/hello-world/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/02/你以为的timeout-不一定是用户的timeout/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Allen Wang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="AllenWang的个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/02/你以为的timeout-不一定是用户的timeout/" itemprop="url">你以为的timeout,不一定是用户的timeout</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-02T10:56:12+08:00">
                2017-12-02
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h3 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h3><p>最近在协助业务团队解决一些疑难问题，其中有一个就是有些用户反馈在进行某个特定的操作时，偶尔会遇到加载很久的情况，就好像是timeout不起作用一样，但是业务开发的同学明明将网络请求的timeout设置为30s,这是为什么呢？难道是okhttp有bug?还是说用户操作不当？</p>
<p>最终我花费了三天时间，慢慢地抽丝剥茧，终于找到了问题的原因
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2017/12/02/你以为的timeout-不一定是用户的timeout/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/11/06/Android-graphic-system/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Allen Wang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="AllenWang的个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/11/06/Android-graphic-system/" itemprop="url">Android图形系统分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-06T12:03:41+08:00">
                2017-11-06
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h3 id="图形绘制概述"><a href="#图形绘制概述" class="headerlink" title="图形绘制概述"></a>图形绘制概述</h3><p>Android框架提供了两种绘制图形的方式:Canvas和OpenGL.  </p>
<p>android.graphics.Canvas是一个2D图形API, 并且是在开发者中最流行的图形API. Canvas运算会在Android中绘制所有原生和自定义android.view.View. 在Android中，Canvas API通过一个名为OpenGLRender的绘制库实现硬件加速，该绘制库将Canvas运算转换为OpenGL运算，以便它们可以在GPU上执行。</p>
<p>从Android 4.0开始，硬件加速的Canvas默认情况下处于启用状态。因此，支持OpenGL ES 2.0的硬件GPU对于Android 4.0及更高版本的设备来说是强制要求。</p>
<p>除了Canvas,开发者渲染图形的另一个主要方式是使用OpenGL ES直接渲染到Surface. Android在Android.opengl包中提供了OpenGL ES接口，开发者可以使用这些接口通过SDK或Android NDK中提供的原生API调用其GL实现。</p>
<h3 id="Android图形组件"><a href="#Android图形组件" class="headerlink" title="Android图形组件"></a>Android图形组件</h3><p>无论开发者使用什么渲染API,一切内容都会渲染到”Surface”. Surface表示缓冲队列中的生产方，而缓冲队列通常会被SurfaceFlinger消耗。在Android平台上创建的每个窗口都由Surface提供支持。所有被渲染的可见Surface都被SurfaceFlinger合成到显示部分。</p>
<p>下图显示了关键组件是如何协作的
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2017/11/06/Android-graphic-system/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/09/09/HttpURLConnection背后的惊人真相/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Allen Wang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="AllenWang的个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/09/HttpURLConnection背后的惊人真相/" itemprop="url">Http(s)URLConnection背后的惊人真相</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-09T17:38:53+08:00">
                2017-09-09
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h3 id="1-疑问"><a href="#1-疑问" class="headerlink" title="1.疑问"></a>1.疑问</h3><p>前些天有朋友问了我一个问题：对于像Http(s)URLConnection这样Android官方提供的用于进行网络连接的类，在进行很好的封装后，使用起来也很方便，但问题来了，使用它们是否足够可靠
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2017/09/09/HttpURLConnection背后的惊人真相/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/08/30/一个OkHttp的bug引发的血案/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Allen Wang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="AllenWang的个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/08/30/一个OkHttp的bug引发的血案/" itemprop="url">一个OkHttp的bug引发的血案</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-30T23:17:00+08:00">
                2017-08-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h3 id="1-起因"><a href="#1-起因" class="headerlink" title="1.起因"></a>1.起因</h3><p>今天在做流量分析时，从服务端记录的请求日志发现流量排名前10的用户里有一个用户的某个网络请求竟然在很短的时间内请求了10000多次! 那段时间内的流量占比如下图:</p>
 <img src="/images/okhttp/flow_rate.png">
<h3 id="2-分析"><a href="#2-分析" class="headerlink" title="2.分析"></a>2.分析</h3><p>考虑到客户端采用AOP的方式记录了所有的网络请求信息，于是赶紧把客户端日志拉上来进行分析，看看是不是某些条件触发的，却意外地并没有看到频繁地网络请求! 我的内心是崩溃
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2017/08/30/一个OkHttp的bug引发的血案/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/08/04/AndroidArchitecture01/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Allen Wang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="AllenWang的个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/08/04/AndroidArchitecture01/" itemprop="url">Google推荐的Android架构使用方式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-04T20:09:26+08:00">
                2017-08-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h2 id="Google推荐的Android架构使用方式"><a href="#Google推荐的Android架构使用方式" class="headerlink" title="Google推荐的Android架构使用方式"></a>Google推荐的Android架构使用方式</h2><h3 id="引入"><a href="#引入" class="headerlink" title="引入"></a>引入</h3><p>Lifecycles,LiveData,ViewModel</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">compile <span class="string">'android.arch.lifecycle:runtime:1.0.0-alpha3'</span></div><div class="line">compile <span class="string">'android.arch.lifecycle:extensions:1.0.0-alpha3'</span></div><div class="line">annotationProcessor <span class="string">'android.arch.lifecycle:compiler:1.0.0-alpha3'</span></div></pre></td></tr></table></figure>
<p>整体的架构图
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2017/08/04/AndroidArchitecture01/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/02/20/你真的了解Context吗/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Allen Wang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="AllenWang的个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/02/20/你真的了解Context吗/" itemprop="url">你真的了解Context吗</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-02-20T11:06:27+08:00">
                2017-02-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>很多人应该知道Activity,Service中的Context和ApplicationContext的区别,而且也知道Context,ContextImpl,ContextWrapper,Activity,Service,Application构成的体系，在异步任务需要Context时,也知道为了防止内存泄露需要传递ApplicationContext而不是Activity的Context,但是这样的场景并不万能，因为并不是所有需要Activity的Context的地方都可以用ApplicationContext来
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2017/02/20/你真的了解Context吗/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/15/">15</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="Allen Wang" />
          <p class="site-author-name" itemprop="name">Allen Wang</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">143</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">24</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">6</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Allen Wang</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






  





  

  

  

  

  

  

</body>
</html>
