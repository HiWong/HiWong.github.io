<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="1.Android与JNI从编程语言年地，Android Framework由基于Java语言的Java层与基于C/C++语言的C/C++层组成，每个层中的功能模块都是使用相应的语言编写的，并且两个层中的大部分模块之间保持着千丝成缕的联系。以Android GPS子系统为例，如下图所示，它提供终端的地理位置信息。在Android应用程序获取GPS信息时，需要先调用应用程序框架中Location M">
<meta property="og:type" content="article">
<meta property="og:title" content="JNI完全解析">
<meta property="og:url" content="http://yoursite.com/2016/02/19/2016-02-19-jniwan-quan-jie-xi/index.html">
<meta property="og:site_name" content="AllenWang的个人博客">
<meta property="og:description" content="1.Android与JNI从编程语言年地，Android Framework由基于Java语言的Java层与基于C/C++语言的C/C++层组成，每个层中的功能模块都是使用相应的语言编写的，并且两个层中的大部分模块之间保持着千丝成缕的联系。以Android GPS子系统为例，如下图所示，它提供终端的地理位置信息。在Android应用程序获取GPS信息时，需要先调用应用程序框架中Location M">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://7xn1yt.com1.z0.glb.clouddn.com/GPS_frame.png">
<meta property="og:image" content="http://7xn1yt.com1.z0.glb.clouddn.com/JNI.png">
<meta property="og:updated_time" content="2017-08-05T12:17:02.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="JNI完全解析">
<meta name="twitter:description" content="1.Android与JNI从编程语言年地，Android Framework由基于Java语言的Java层与基于C/C++语言的C/C++层组成，每个层中的功能模块都是使用相应的语言编写的，并且两个层中的大部分模块之间保持着千丝成缕的联系。以Android GPS子系统为例，如下图所示，它提供终端的地理位置信息。在Android应用程序获取GPS信息时，需要先调用应用程序框架中Location M">
<meta name="twitter:image" content="http://7xn1yt.com1.z0.glb.clouddn.com/GPS_frame.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2016/02/19/2016-02-19-jniwan-quan-jie-xi/"/>





  <title>JNI完全解析 | AllenWang的个人博客</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">AllenWang的个人博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">小楼一夜听春雨</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Startseite
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archiv
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/02/19/2016-02-19-jniwan-quan-jie-xi/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Allen Wang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="AllenWang的个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">JNI完全解析</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-02-19T20:03:56+08:00">
                2016-02-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">in</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android-deep-analysis/" itemprop="url" rel="index">
                    <span itemprop="name">android_deep_analysis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="1-Android与JNI"><a href="#1-Android与JNI" class="headerlink" title="1.Android与JNI"></a>1.Android与JNI</h2><p>从编程语言年地，Android Framework由基于Java语言的Java层与基于C/C++语言的C/C++层组成，每个层中的功能模块都是使用相应的语言编写的，并且两个层中的大部分模块之间保持着千丝成缕的联系。以Android GPS子系统为例，如下图所示，它提供终端的地理位置信息。在Android应用程序获取GPS信息时，需要先调用应用程序框架中Location Manager提供的Java API，而后通过调用框架内的GPS库，连接到GPS设备驱动上，应用程序即可获取当前地理位置信息。在此过程中，C/C++层与Java层相互作用、相互配合，共同<a id="more"></a>完成任务。  </p>
<p><img src="http://7xn1yt.com1.z0.glb.clouddn.com/GPS_frame.png" alt="GPS_framework"></p>
<p>在Android Framework中，需要提供一种媒介或桥梁，将Java层(上层)与C/C++层(底层)有机地联系起来，使得它们相互协调，共同完成某些任务。在两层之间充当桥梁的就是Java本地接口(JNI,Java Native Interface),它允许Java代码与基于C/C++编写的应用程序和库进行交互操作。  </p>
<p>Java提供了一系列接口，允许Java类与使用C/C++等其他编程语言(在JNI中，这些语言被称为本地语言)编写的应用程序、模块、库进行交互操作。比如，在Java类中使用C语言库中的特定函数，或在C语言程序中使用Java类库，都需要借助JNI来完成。  </p>
<p>通常在以下几种情况下会使用JNI：</p>
<h3 id="1）注重处理速度"><a href="#1）注重处理速度" class="headerlink" title="1）注重处理速度"></a>1）注重处理速度</h3><p>与本地代码相比，Java代码的执行速度要慢一些。如果对某段程序的执行速度有较高的要求，建议使用C/C++编写代码。而后在Java中通过JNI调用基于C/C++编写的部分，常常能够获得更快的运行速度。  </p>
<h3 id="2-硬件控制"><a href="#2-硬件控制" class="headerlink" title="2)硬件控制"></a>2)硬件控制</h3><p>为了更好地控制硬件，硬件控制代码通常都使用C语言编写。而后借助JNI将其与Java层连接起来，从而实现对硬件的控制。  </p>
<h3 id="3-既有C-C-代码的复用"><a href="#3-既有C-C-代码的复用" class="headerlink" title="3)既有C/C++代码的复用"></a>3)既有C/C++代码的复用</h3><p>在程序编写过程中，常常会使用一些已经编写好的C/C++代码，既提高了编程效率，又确保了程序的安全性与健壮性。在复用这些C/C++代码时，就要通过JNI来实现。  </p>
<h2 id="2-简单的JNI示例"><a href="#2-简单的JNI示例" class="headerlink" title="2.简单的JNI示例"></a>2.简单的JNI示例</h2><h3 id="1-第一步-编写Java代码"><a href="#1-第一步-编写Java代码" class="headerlink" title="1)第一步:编写Java代码"></a>1)第一步:编写Java代码</h3><figure class="highlight java"><figcaption><span>HelloJni.java</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloJni</span></span>&#123;</div><div class="line">	<span class="keyword">static</span> &#123;</div><div class="line">		System.loadLibrary(<span class="string">"hellojni"</span>);</div><div class="line">	&#125;</div><div class="line">        </div><div class="line">    <span class="function"><span class="keyword">native</span> <span class="keyword">void</span> <span class="title">printHello</span><span class="params">()</span></span>;</div><div class="line">    <span class="function"><span class="keyword">native</span> <span class="keyword">void</span> <span class="title">printString</span><span class="params">(String str)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[]args)</span></span>&#123;</div><div class="line">    HelloJni helloJni=<span class="keyword">new</span> HelloJni();</div><div class="line">    helloJni.printHello();</div><div class="line">    helloJni.printString(<span class="string">"Hello world!\n"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="2-第二步-编译Java代码，非常简单。而编译的目的其实是为了生成相应的函数签名。"><a href="#2-第二步-编译Java代码，非常简单。而编译的目的其实是为了生成相应的函数签名。" class="headerlink" title="2)第二步:编译Java代码，非常简单。而编译的目的其实是为了生成相应的函数签名。"></a>2)第二步:编译Java代码，非常简单。而编译的目的其实是为了生成相应的函数签名。</h3><figure class="highlight bash"><figcaption><span>编译</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$javac</span> HelloJni.java</div></pre></td></tr></table></figure>
<h3 id="3-第三步：生成相应的头文件，利用javah即可"><a href="#3-第三步：生成相应的头文件，利用javah即可" class="headerlink" title="3)第三步：生成相应的头文件，利用javah即可"></a>3)第三步：生成相应的头文件，利用javah即可</h3><figure class="highlight bash"><figcaption><span>生成头文件</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$javah</span> HelloJni</div></pre></td></tr></table></figure>
<p>生成的头文件如下：<br><figure class="highlight c"><figcaption><span>HelloJni.h</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* DO NOT EDIT THIS FILE - it is machine generated */</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></div><div class="line"><span class="comment">/* Header for class HelloJni */</span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _Included_HelloJni</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> _Included_HelloJni</span></div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></div><div class="line"><span class="keyword">extern</span> <span class="string">"C"</span> &#123;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment">	 + Class:     HelloJni</span></div><div class="line"><span class="comment">	 + Method:    printHello</span></div><div class="line"><span class="comment">	 + Signature: ()V</span></div><div class="line"><span class="comment"> */</span></div><div class="line">JNIEXPORT <span class="keyword">void</span> JNICALL Java_HelloJni_printHello</div><div class="line">  (JNIEnv *, jobject);</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment">	 + Class:     HelloJni</span></div><div class="line"><span class="comment">	 + Method:    printString</span></div><div class="line"><span class="comment">	 + Signature: (Ljava/lang/String;)V</span></div><div class="line"><span class="comment"> */</span></div><div class="line">JNIEXPORT <span class="keyword">void</span> JNICALL Java_HelloJni_printString</div><div class="line">  (JNIEnv *, jobject, jstring);</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></div><div class="line">&#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div></pre></td></tr></table></figure></p>
<p>可以看到，里面包含了jni.h这个头文件以及sayHello这个Java方法对应的本地方法声明。  </p>
<p>其中JNIEXPORT,JNICALL都是JNI关键字，表示此函数要被JNI调用，函数原型中必须有这两个关键字，JNI才能正常调用函数。其实,JNIEXPORT,JNICALL两个关键字都是宏定义，它们被定义在JDK_HOME/include/linux/jni_md.h文件中。  </p>
<p>JNIEnv*是JNI接口的指针，用来调用JNI表中的各种JNI函数，如下图所示：  </p>
<p><img src="http://7xn1yt.com1.z0.glb.clouddn.com/JNI.png" alt="JNI"></p>
<p>函数原型中的第二个默认参数类型jobject也是JNI提供的Java本地类型，用来在C代码中访问Java对象，此参数中保存着调用本地方法的对象的一个引用。例如上面的helloJni.sayHello();中helloJni对象调用了本地方法，上面JNI函数的第二个参数jobject中保存着对helloJni对象的引用。  </p>
<p>Java类型与Java本地类型的对应列表如下:</p>
<p>Java类型  Java本地类型  占用内存大小<br>  byte        jbyte          1<br>  short          jshort         2<br>  int         jint           4<br>  long        jlong          8<br>  float       jfloat         4<br>  double      jdouble        8<br>  char        jchar          2<br>  boolean     jboolean       1<br>  void        void           -</p>
<p>以上Java本地类型定义都可以在下面的头文件中找到：  </p>
<ul>
<li>1)JDK_HOME/include/jni.h  </li>
<li>2)JDK_HOME/include/linux/jni_md.h  </li>
</ul>
<p>注意，如果是Windows平台，则jni_md.h的位置则不是这个路径。  </p>
<ul>
<li><p>4)根据头文件编写相应的C/C++代码<br>C语言代码如下:  </p>
<figure class="highlight c"><figcaption><span>HelloJni.c</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"HelloJni.h"</span></span></div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment">	 + Class:     HelloJni</span></div><div class="line"><span class="comment">	 + Method:    printHello</span></div><div class="line"><span class="comment">	 + Signature: ()V</span></div><div class="line"><span class="comment"> */</span></div><div class="line">JNIEXPORT <span class="keyword">void</span> JNICALL Java_HelloJni_printHello</div><div class="line">  (JNIEnv *env, jobject obj)</div><div class="line">&#123;</div><div class="line">   <span class="built_in">printf</span>(<span class="string">"Hello JNI!\n"</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment">	 + Class:     HelloJni</span></div><div class="line"><span class="comment">	 + Method:    printString</span></div><div class="line"><span class="comment">	 + Signature: (Ljava/lang/String;)V</span></div><div class="line"><span class="comment"> */</span></div><div class="line">JNIEXPORT <span class="keyword">void</span> JNICALL Java_HelloJni_printString</div><div class="line">  (JNIEnv *env, jobject obj, jstring str)</div><div class="line">&#123;</div><div class="line">   <span class="keyword">const</span> <span class="keyword">char</span>*content=(*env)-&gt;GetStringUTFChars(env,str,<span class="number">0</span>);</div><div class="line">   <span class="built_in">printf</span>(<span class="string">"%s\n"</span>,content);</div><div class="line"></div><div class="line">   <span class="keyword">return</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>5)生成so库<br>在<a href="http://blog.imallen.wang/blog/2016/02/19/linuxxia-gccde-shi-yong/" target="_blank" rel="external">Linux下gcc的使用</a>一文中对于Linux下gcc的使用进行了详细的阐述，如果不有熟悉的小伙伴，建议先看一下那篇博客。  </p>
</li>
</ul>
<p>由于包含的头文件在JDK_HOME/include和JDK_HOME/include/linux下，所以编译成so库的命令如下:  </p>
<pre><code>$gcc -shared -fPIC hellojni.c -I /usr/lib/jvm/jdk7/include -I /usr/lib/jvm/jdk7/include/linux -o libhellojni.so
</code></pre><ul>
<li>6)运行<br>在<a href="http://blog.imallen.wang/blog/2016/02/19/linuxxia-gccde-shi-yong/" target="_blank" rel="external">Linux下gcc的使用</a>一文中讲解过库路径、文件路径与环境变量的问题，这里存在同样的问题，因而在运行之前先要将当前的路径添加进去：  <figure class="highlight bash"><figcaption><span>link</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$export</span> LD_LIBRARY_PATH=LD_LIBRARY_PATH:<span class="variable">$PWD</span></div><div class="line"><span class="variable">$export</span> CLASSPATH=<span class="variable">$CLASSPATH</span>:<span class="variable">$PWD</span></div><div class="line"><span class="variable">$java</span> HelloJni</div></pre></td></tr></table></figure>
</li>
</ul>
<p>之后可看到正确的输出结果。 </p>
<p>值得注意的是，上面是以C语言为例子，如果采用C++的话，除了在编译so库时将gcc换成g++外，其它均一样，所以此处不再示例。  </p>
<h2 id="3-Java和C相互调用示例"><a href="#3-Java和C相互调用示例" class="headerlink" title="3.Java和C相互调用示例"></a>3.Java和C相互调用示例</h2><p>上面举了Java调用C的例子，下面的例子中则包含了C调用Java中的对象及方法等。<br>首先是Java代码：<br><figure class="highlight java"><figcaption><span>JniFuncMain.java</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JniFuncMain</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> num=<span class="number">300</span>;</div><div class="line"></div><div class="line"> <span class="keyword">static</span> &#123;System.loadLibrary(<span class="string">"jnifunc"</span>);&#125;</div><div class="line"></div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">native</span> JniTest <span class="title">createJniObject</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[]args)</span></span></div><div class="line"><span class="function"> </span>&#123;</div><div class="line">   System.out.println(<span class="string">"[Java] createJniObject() call native method"</span>);</div><div class="line">   JniTest jniObj=createJniObject();</div><div class="line">   jniObj.callTest();</div><div class="line"> &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">JniTest</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">int</span> count;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">JniTest</span><span class="params">(<span class="keyword">int</span> num)</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">this</span>.count=num;</div><div class="line">    System.out.println(<span class="string">"[Java] constructor: count="</span>+count);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">callByNative</span><span class="params">(<span class="keyword">int</span> num)</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    System.out.println(<span class="string">"[Java] JniTest method callByNative("</span>+num+<span class="string">")"</span>);</div><div class="line">    <span class="keyword">return</span> num;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callTest</span><span class="params">()</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">     System.out.println(<span class="string">"[Java] JniTest callTest() method,count="</span>+count);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>编译后通过javah生成相应的头文件，头文件如下所示：<br><figure class="highlight c"><figcaption><span>JniFuncMain.h</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* DO NOT EDIT THIS FILE - it is machine generated */</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></div><div class="line"><span class="comment">/* Header for class JniFuncMain */</span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _Included_JniFuncMain</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> _Included_JniFuncMain</span></div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></div><div class="line"><span class="keyword">extern</span> <span class="string">"C"</span> &#123;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment">	 + Class:     JniFuncMain</span></div><div class="line"><span class="comment">	 + Method:    createJniObject</span></div><div class="line"><span class="comment">	 + Signature: ()LJniTest;</span></div><div class="line"><span class="comment"> */</span></div><div class="line">JNIEXPORT jobject JNICALL Java_JniFuncMain_createJniObject</div><div class="line">  (JNIEnv *, jclass);</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></div><div class="line">&#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div></pre></td></tr></table></figure></p>
<p>此处采用C++来实现,jnifunc.cpp的代码如下：<br><figure class="highlight c++"><figcaption><span>jnifunc.cpp</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"JniFuncMain.h"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment">	 + Class:     JniFuncMain</span></div><div class="line"><span class="comment">	 + Method:    createJniObject</span></div><div class="line"><span class="comment">	 + Signature: ()LJniTest;</span></div><div class="line"><span class="comment"> */</span></div><div class="line">JNIEXPORT jobject JNICALL Java_JniFuncMain_createJniObject</div><div class="line">  (JNIEnv *env, jclass clazz)</div><div class="line">&#123;</div><div class="line">   jclass targetClass;</div><div class="line">   jmethodID mid;</div><div class="line">   jobject newObject;</div><div class="line"></div><div class="line">   jstring helloStr;</div><div class="line">   jfieldID fid;</div><div class="line">   jint num;</div><div class="line">   jint result;</div><div class="line"></div><div class="line">   fid=env-&gt;GetStaticFieldID(clazz,<span class="string">"num"</span>,<span class="string">"I"</span>);</div><div class="line">   num=env-&gt;GetStaticIntField(clazz,fid);</div><div class="line">   <span class="built_in">printf</span>(<span class="string">"[CPP] get the value of field num%d\n"</span>,num);</div><div class="line">   </div><div class="line">   targetClass=env-&gt;FindClass(<span class="string">"JniTest"</span>);</div><div class="line">   mid=env-&gt;GetMethodID(targetClass,<span class="string">"&lt;init&gt;"</span>,<span class="string">"(I)V"</span>);</div><div class="line">   <span class="built_in">printf</span>(<span class="string">"[CPP] JniTest object\n"</span>);</div><div class="line">   newObject=env-&gt;NewObject(targetClass,mid,<span class="number">100</span>);</div><div class="line"></div><div class="line">   mid=env-&gt;GetMethodID(targetClass,<span class="string">"callByNative"</span>,<span class="string">"(I)I"</span>);</div><div class="line">   result=env-&gt;CallIntMethod(newObject,mid,<span class="number">200</span>);</div><div class="line"></div><div class="line">   fid=env-&gt;GetFieldID(targetClass,<span class="string">"count"</span>,<span class="string">"I"</span>);</div><div class="line">   <span class="built_in">printf</span>(<span class="string">"[CPP] set the value of count in JniTest Object\n"</span>);</div><div class="line">   env-&gt;SetIntField(newObject,fid,result);</div><div class="line"></div><div class="line">   <span class="keyword">return</span> newObject;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>程序通过JNI访问Java类/对象的成员变量按如下顺序进行:  </p>
<ul>
<li>1)查找含待访问的成员变量的Java类的jclass值;  </li>
<li>2)获取此类成员变量的jfieldID值。若成员变量为静态变量，则调用名称为GetStaticFieldID()的JNI函数;若待访问的成员变量是普通对象，则调用名称为GetFieldID()的JNI函数;  </li>
<li>3)使用1,2中获得的jclass与jfieldID值。  </li>
</ul>
<p>下面重点讲解一下GetStaticFieldID()和GetFieldID()函数。  </p>
<p>jfield GetStaticFieldID(JNIEnv<em>env,jclass clazz,const char</em>name,const char*signature);</p>
<p>jfield GetFieldID(JNIEnv<em>env,jclass clazz,const char</em>name,const char*signature);</p>
<p>其中env-JNI接口指针<br>    clazz-包含成员变量的类的jclass<br>    name-成员变量名<br>    signature-成员方法签名  </p>
<p>那么如何获取成员方法签名呢？<br>在jdk中有一个javap命令(Java反编译器)，利用它可轻松获取指定的成员变量或成员方法的签名。  </p>
<pre><code>形式: javap [选项] 类名  
选项：-s 输出Java签名  
      -p 输出所有类及成员  
</code></pre><p>比如这里使用javap -s JniFuncMain命令，输出如下：<br><figure class="highlight bash"><figcaption><span>输出</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">Compiled from <span class="string">"JniFuncMain.java"</span></div><div class="line">public class JniFuncMain&#123;</div><div class="line">	public JniFuncMain();</div><div class="line">	  Signature: ()V</div><div class="line"></div><div class="line">	public static native JniTest createJniObject();</div><div class="line">	  Signature: ()LJniTest;</div><div class="line"></div><div class="line">	public static void main(java.lang.String[]);</div><div class="line">	  Signature:([Ljava/lang/String;])V</div><div class="line"></div><div class="line">	static &#123;&#125;;</div><div class="line">	  Signature: ()V</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后，编译获取so库的命令为：<br><figure class="highlight bash"><figcaption><span>编译so库</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$g</span>++ -shared -fPIC jnifunc.cpp -I /usr/lib/jvm/jdk7/include -I /usr/lib/jvm/jdk7/include/linux -o libjnifunc.so</div></pre></td></tr></table></figure></p>
<p>后面的步骤与前一个示例相似，此处不再赘述。输出结果如下：<br><figure class="highlight bash"><figcaption><span>output</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[Java] createJniObject() call native method</div><div class="line">[CPP] get the value of field num300</div><div class="line">[CPP] JniTest object</div><div class="line">[Java] constructor: count=100</div><div class="line">[Java] JniTest method callByNative(200)</div><div class="line">[CPP] <span class="built_in">set</span> the value of count <span class="keyword">in</span> JniTest Object</div><div class="line">[Java] JniTest callTest() method,count=200</div></pre></td></tr></table></figure></p>
<p>从输出结果可看出，Java通过JNI调用了native方法，C++中通过JNI调用了Java中的成员变量及方法。  </p>
<p>实际上在Android系统中，也有大量的代码使用了JNI函数，这些代码存在于Android源码的相关目录中。比如在Android 2.2.1的如下目录下就有：<br><figure class="highlight bash"><figcaption><span>dir</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">frameworks/base/core/jni</div><div class="line">frameworks/base/services/jni</div><div class="line">frameworks/base/media/jni</div></pre></td></tr></table></figure></p>
<p>关于这些，后面还会详细讲解，此处先提一下。  </p>
<h2 id="4-在C程序中运行Java类"><a href="#4-在C程序中运行Java类" class="headerlink" title="4.在C程序中运行Java类"></a>4.在C程序中运行Java类</h2><p>前面示例代码中的主程序都是使用Java语言编写的，通过这些示例，我们学习了在Java代码中如何通过本地方法调用C函数，即使用JNI的方式。在这个小节中，我们将一起学习在由C/C++编写的主程序中如何运行Java类,这也是使用JNI的重要方式。  </p>
<p>我们知道，由Java类编译生成的字节码必须运行在Java虚拟机上，那么在C/C++编写的程序中运行Java类或对象还需要Java虚拟机吗？  </p>
<p>答案是肯定的。为此，JNI提供了一套Invocation API，它允许本地代码在自身内存区域内加载Java虚拟机。在C代码中，如何使用Invocation API，装载Java类，并运行指定的方法呢？这就是本节要讲解的主要内容。  </p>
<p>下面列出的情况就是需要使用Invocation API在C/C++代码中调用Java代码的几种典型情况。  </p>
<ul>
<li>1)需要在C/C++编写的本地应用程序中访问用Java语言编写的代码或代码库;  </li>
<li>2)希望在C/C++编写的本地应用程序中使用标准Java类库;  </li>
<li>3)当需要把已有的C/C++程序与Java程序组织链接在一起时，使用Invocation API，可以将它们组织成一个完整的程序。  </li>
</ul>
<p>首先是Java程序，非常简单：<br><figure class="highlight java"><figcaption><span>InvocationApiTest.java</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InvocationApiTest</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[]args)</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">     System.out.println(args[<span class="number">0</span>]);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后是C代码(invocationApi.c):<br><figure class="highlight c"><figcaption><span>invocationApi.c</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">  JNIEnv*env;</div><div class="line">  JavaVM*vm;</div><div class="line">  JavaVMInitArgs vm_args;</div><div class="line">  JavaVMOption options[<span class="number">1</span>];</div><div class="line">  jint res;</div><div class="line">  jclass cls;</div><div class="line">  jmethodID mid;</div><div class="line">  jstring jstr;</div><div class="line">  jclass stringClass;</div><div class="line">  jobjectArray args;</div><div class="line">      </div><div class="line">      <span class="comment">//生成Java虚拟机选项</span></div><div class="line">  options[<span class="number">0</span>].optionString=<span class="string">"-Djava.class.path=."</span>;</div><div class="line">  vm_args.version=<span class="number">0x00010002</span>;</div><div class="line">  vm_args.options=options;</div><div class="line">  vm_args.nOptions=<span class="number">1</span>;</div><div class="line">  vm_args.ignoreUnrecognized=JNI_TRUE;</div><div class="line"></div><div class="line">      <span class="comment">//创建Java虚拟机</span></div><div class="line">  res=JNI_CreateJavaVM(&amp;vm,(<span class="keyword">void</span>**)&amp;env,&amp;vm_args);</div><div class="line">  <span class="comment">//查找并加载类</span></div><div class="line">  cls=(*env)-&gt;FindClass(env,<span class="string">"InvocationApiTest"</span>);</div><div class="line"></div><div class="line">      <span class="comment">//根据main方法的签名获取该方法的ID</span></div><div class="line">  mid=(*env)-&gt;GetStaticMethodID(env,cls,<span class="string">"main"</span>,<span class="string">"([Ljava/lang/String;)V"</span>);</div><div class="line">  </div><div class="line">  <span class="comment">//生成字符串对象，用作main()方法的参数</span></div><div class="line">  jstr=(*env)-&gt;NewStringUTF(env,<span class="string">"Hello Invocation API!"</span>);</div><div class="line">  stringClass=(*env)-&gt;FindClass(env,<span class="string">"java/lang/String"</span>);</div><div class="line">  args=(*env)-&gt;NewObjectArray(env,<span class="number">1</span>,stringClass,jstr);</div><div class="line">      </div><div class="line">      <span class="comment">//调用main()方法</span></div><div class="line">  (*env)-&gt;CallStaticVoidMethod(env,cls,mid,args);</div><div class="line">  <span class="comment">//销毁Java虚拟机</span></div><div class="line">  (*vm)-&gt;DestroyJavaVM(vm);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在生成Java虚拟机选项时，使用JavaVMInitArgs和JavaVMOption结构体，它们定义在jni.h文件中，如下所示：<br><figure class="highlight c"><figcaption><span>jni.h</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">JavaVMInitArgs</span>&#123;</span></div><div class="line">	jint version;</div><div class="line">	jint nOptions;</div><div class="line">	JavaVMOption*options;</div><div class="line">	jboolean ignoreUnrecognized;</div><div class="line">&#125; JavaVMInitArgs;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">JavaVMOptions</span>&#123;</span></div><div class="line">	<span class="keyword">char</span>*optionString;</div><div class="line">	<span class="keyword">void</span>*extraInfo;</div><div class="line">&#125; JavaVMOption;</div></pre></td></tr></table></figure></p>
<p>此处由于包含与jvm相关的库，所以编译命令稍微复杂一点：<br><figure class="highlight bash"><figcaption><span>compile</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$gcc</span> -g -I /usr/lib/jvm/jdk7/include -I /usr/lib/jvm/jdk7/include/linux -L/usr/lib/jvm/jdk7/jre/lib/amd64/server invocationApi.c -ljvm -o main</div></pre></td></tr></table></figure></p>
<p>另外，由于使用到了libjvm.so，所以如果直接./main的话会出现找不到libjvm.so的错误。解决方法也很简单，只要将/usr/lib/jvm/jdk7/jre/lib/amd64/server加入到链接路径即可：<br><figure class="highlight bash"><figcaption><span>link</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$export</span> LD_LIBRARY_PATH=LD_LIBRARY_PATH:/usr/lib/jvm/jdk7/jre/lib/amd64/server/</div></pre></td></tr></table></figure></p>
<p>之后运行即可得到”Hello Invocation API!”的输出。  </p>
<h2 id="5-直接注册JNI本地函数"><a href="#5-直接注册JNI本地函数" class="headerlink" title="5.直接注册JNI本地函数"></a>5.直接注册JNI本地函数</h2><p>通过前面的简单示例学习，我们已经知道Java虚拟机在运行包含本地方法的Java应用程序时，要经过以下两个步骤:  </p>
<ul>
<li>1).调用System.loadLibrary()方法，将包含本地方法具体实现的C/C++运行库加载到内存中;  </li>
<li>2).Java虚拟机检索加载进来的库函数符号，在其中查找与Java本地方法拥有相同签名的JNI本地函数符号。若找到一致的，则将本地方法映射到具体的JNI本地函数。<br>像简单示例中那样，若JNI支持的功能函数只有一个，Java虚拟机在将本地方法与C运行库中的JNI本地函数映射在一起时，不会耗费很长时间。但在Android Framework这类复杂的系统下，拥有大量的包含本地方法的Java类，Java虚拟机加载相应运行库，再逐一检索，将各个本地方法与相应的函数映射起来，这显然会增加运行时间，降低运行的效率。  </li>
</ul>
<p>为了解决这一问题，JNI机制提供了名为RegisterNatives()的JNI函数，该函数允许C/C++开发者将JNI本地函数与Java类的本地方法直接映射在一起。当不调用RegisterNatives()函数时，Java虚拟机会自动检索并将JNI本地函数与相应的Java本地方法链接在一起。但当开发者直接调用RegisterNatives()函数进行映射时，Java虚拟机就不必进行映射处理，这会极大提高运行速度，提升运行效率。  </p>
<p>由于程序员直接将JNI本地函数与Java本地方法链接在一起，在加载运行库时，Java虚拟机不必为了识别JNI本地函数而将JNI本地函数的名称与JNI支持的命名规则进行比对，即任何名称的函数都能直接链接到Java本地方法上。  </p>
<p>首先分析System.loadLibrary()方法的执行过程。在Java代码中，调用System.loadLibrary()方法时，Java虚拟机会加载其参数指定的共享库。然后,Java虚拟机检索共享库内的函数符号，检查JNI_OnLoad()函数是否被实现，若共享库中含有相关函数，则JNI_OnLoad()函数就会被自动调用。否则，像前面的libhellojni.so一样，库中的JNI_OnLoad()函数未被实现，则Java虚拟机会自动将本地方法与库内的JNI本地函数符号进行比较匹配。  </p>
<p>在加载指定的库文件时，JNI_OnLoad()函数会被自动调用执行，程序开发者若想手工映射本地方法与JNI本地函数，需要在JNI_OnLoad()函数内调用RegisterNatives()函数进行映射匹配。  </p>
<p>jint JNI_OnLoad(JavaVM<em>vm,void</em>reserved) 其中vm:JavaVM接口指针  reserved:预定参数  </p>
<p>若执行成员，则返回所生成的数组引用,否则返回NULL.  </p>
<p>仍以HelloJni那个例子为例，HelloJni.java的代码不需要改变，但是用hellojni.cpp代替hellojni.c,其中hellojni.cpp的代码如下：<br><figure class="highlight cpp"><figcaption><span>hellojni.cpp</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"jni.h"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">printHelloNative</span><span class="params">(JNIEnv*env,jobject obj)</span></span>;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">printStringNative</span><span class="params">(JNIEnv*env,jobject obj,jstring <span class="built_in">string</span>)</span></span>;</div><div class="line"></div><div class="line"><span class="function">JNIEXPORT jint JNICALL <span class="title">JNI_OnLoad</span><span class="params">(JavaVM*vm,<span class="keyword">void</span> *reserved)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">  JNIEnv*env=<span class="literal">NULL</span>;</div><div class="line">  JNINativeMethod nm[<span class="number">2</span>];</div><div class="line">  jclass cls;</div><div class="line">  jint result=<span class="number">-1</span>;</div><div class="line"> </div><div class="line">  <span class="keyword">if</span>(vm-&gt;GetEnv((<span class="keyword">void</span>**)&amp;env,JNI_VERSION_1_4)!=JNI_OK)&#123;</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"Error"</span>);</div><div class="line">    <span class="keyword">return</span> JNI_ERR;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  cls=env-&gt;FindClass(<span class="string">"HelloJni"</span>);</div><div class="line"></div><div class="line">  nm[<span class="number">0</span>].name=<span class="string">"printHello"</span>;</div><div class="line">  nm[<span class="number">0</span>].signature=<span class="string">"()V"</span>;</div><div class="line">  nm[<span class="number">0</span>].fnPtr=(<span class="keyword">void</span>*)printHelloNative;</div><div class="line"></div><div class="line">  nm[<span class="number">1</span>].name=<span class="string">"printString"</span>;</div><div class="line">  nm[<span class="number">1</span>].signature=<span class="string">"(Ljava/lang/String;)V"</span>;</div><div class="line">  nm[<span class="number">1</span>].fnPtr=(<span class="keyword">void</span>*)printStringNative;</div><div class="line"></div><div class="line">  env-&gt;RegisterNatives(cls,nm,<span class="number">2</span>);</div><div class="line"></div><div class="line">  <span class="keyword">return</span> JNI_VERSION_1_4;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">printHelloNative</span><span class="params">(JNIEnv*env,jobject obj)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">  <span class="built_in">printf</span>(<span class="string">"Hello Jni!\n"</span>);</div><div class="line"></div><div class="line">  <span class="keyword">return</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">printStringNative</span><span class="params">(JNIEnv*env,jobject obj,jstring <span class="built_in">string</span>)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">  <span class="keyword">const</span> <span class="keyword">char</span>*str=env-&gt;GetStringUTFChars(<span class="built_in">string</span>,<span class="number">0</span>);</div><div class="line">  <span class="built_in">printf</span>(<span class="string">"%s"</span>,str);</div><div class="line"></div><div class="line">  <span class="keyword">return</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>由于是采用C++，所以编译要采用g++，编译命令如下：<br><figure class="highlight bash"><figcaption><span>compile</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$g</span>++ -shared -fPIC hellojni.cpp -I /usr/lib/jvm/jdk7/include -I /usr/lib/jvm/jdk7/include/linux -o libhellojni.so</div></pre></td></tr></table></figure></p>
<p>编译时会有一些Warning,可忽略。<br>在运行之前，需要利用export将当前目录加入到链接库路径中：<br><figure class="highlight bash"><figcaption><span>link</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$export</span> LD_LIBRARY_PATH=LD_LIBRARY_PATH:<span class="variable">$PWD</span></div></pre></td></tr></table></figure></p>
<p>然后就可以直接运行了：<br><figure class="highlight bash"><figcaption><span>run</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$java</span> HelloJni</div></pre></td></tr></table></figure></p>
<p>可看到正确的输出，说明本地方法调用成功。  </p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/02/19/2016-02-19-linuxxia-gccde-shi-yong/" rel="next" title="Linux下gcc的使用">
                <i class="fa fa-chevron-left"></i> Linux下gcc的使用
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/02/23/2016-02-23-zygotewan-quan-jie-xi-1/" rel="prev" title="Zygote完全解析(1)">
                Zygote完全解析(1) <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            Inhaltsverzeichnis
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Übersicht
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="Allen Wang" />
          <p class="site-author-name" itemprop="name">Allen Wang</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">136</span>
                <span class="site-state-item-name">Artikel</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">25</span>
                <span class="site-state-item-name">Kategorien</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">2</span>
                <span class="site-state-item-name">Tags</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-Android与JNI"><span class="nav-number">1.</span> <span class="nav-text">1.Android与JNI</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1）注重处理速度"><span class="nav-number">1.1.</span> <span class="nav-text">1）注重处理速度</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-硬件控制"><span class="nav-number">1.2.</span> <span class="nav-text">2)硬件控制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-既有C-C-代码的复用"><span class="nav-number">1.3.</span> <span class="nav-text">3)既有C/C++代码的复用</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-简单的JNI示例"><span class="nav-number">2.</span> <span class="nav-text">2.简单的JNI示例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-第一步-编写Java代码"><span class="nav-number">2.1.</span> <span class="nav-text">1)第一步:编写Java代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-第二步-编译Java代码，非常简单。而编译的目的其实是为了生成相应的函数签名。"><span class="nav-number">2.2.</span> <span class="nav-text">2)第二步:编译Java代码，非常简单。而编译的目的其实是为了生成相应的函数签名。</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-第三步：生成相应的头文件，利用javah即可"><span class="nav-number">2.3.</span> <span class="nav-text">3)第三步：生成相应的头文件，利用javah即可</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-Java和C相互调用示例"><span class="nav-number">3.</span> <span class="nav-text">3.Java和C相互调用示例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-在C程序中运行Java类"><span class="nav-number">4.</span> <span class="nav-text">4.在C程序中运行Java类</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-直接注册JNI本地函数"><span class="nav-number">5.</span> <span class="nav-text">5.直接注册JNI本地函数</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Allen Wang</span>
</div>


<div class="powered-by">
  Erstellt mit  <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






  





  

  

  

  

  

  

</body>
</html>
